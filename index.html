<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>TTTIW</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9Ii0xIDE1IDY1IDQwIj4KICA8ZyBmaWxsPSIjRTVCMjVEIiB0cmFuc2Zvcm09Im1hdHJpeCgwLjY3NDY1LCAwLCAwLCAwLjY3NDY1LCAwLCAxNykiPgogICAgPHBhdGggZD0iTTAsNTEuMTdsNTkuMjkuMzRMMjkuOTQsMCwwLDUxLjE3Wk0xMC41Nyw0NS4xNkwyOS44NywxMi4xNmwxOC45MiwzMy4yMS0zOC4yMi0uMjJaIi8+CiAgICA8cGF0aCBkPSJNNTYuNDMsNDkuODRsLTUzLjU2LS4zMUwyOS45MiwzLjMxbDI2LjUyLDQ2LjU0Wk00LjYxLDQ4LjU0bDUwLjA5LjI5TDI5LjkxLDUuMzEsNC42MSw0OC41NFpNNTMuMzgsNDguMDZsLTQ3LjQyLS4yN0wyOS45LDYuODVsMjMuNDgsNDEuMlpNNy42OSw0Ni43OWw0My45Ni4yNUwyOS44OSw4Ljg1LDcuNjksNDYuNzlaIi8+CiAgPC9nPgogIDxnPgogICAgPGcgZmlsbD0iI0U1QjI1RCIgdHJhbnNmb3JtPSJtYXRyaXgoMC41MDAyLCAwLCAwLCAwLjUwMDIsIDUuMjQ0MzM3LCAxNi4xNTk2NjIpIiBzdHlsZT0iIj4KICAgICAgPHBhdGggZD0iTTg1LjgzLDEuNjhoLS4yYy0xMy43NSwwLTI0Ljk1LDExLjE3LTI0Ljk5LDI0LjkyLS4wNCwxMy43OCwxMS4xNCwyNS4wMiwyNC45MywyNS4wNmguMmMxMy43NSwwLDI0Ljk1LTExLjE3LDI0Ljk5LTI0LjkyLjA0LTEzLjc4LTExLjE0LTI1LjAyLTI0LjkzLTI1LjA2Wk04Mi40OSw4LjA2bC0uMDksMTUuNDEtMTUuMy0uMDljLjY2LTMuNzksMi40Ni03LjI5LDUuMjMtMTAuMDcsMi44LTIuOCw2LjMzLTQuNiwxMC4xNi01LjI1Wk04Mi4zNiwyOS41NGwtLjA5LDE1LjcxYy0zLjc3LS43LTcuMy0yLjUzLTEwLjAxLTUuMjktMi44Ni0yLjg5LTQuNjUtNi41Ni01LjI0LTEwLjUxbDE1LjM0LjA5Wk04OC4zNSw0NS4zN2wuMDktMTUuNzksMTUuOTEuMDljLTEuMzIsOC4xMi03LjgzLDE0LjU0LTE2LDE1LjdaTTg4LjQ4LDIzLjVsLjA5LTE1LjQ5YzguMDUsMS4yNCwxNC40Myw3LjU3LDE1Ljc3LDE1LjU4bC0xNS44Ni0uMDlaIi8+CiAgICA8L2c+CiAgICA8cmVjdCBzdHlsZT0iZmlsbDogcmdiKDIyOSwgMTc4LCA5Myk7IHRyYW5zZm9ybS1ib3g6IGZpbGwtYm94OyB0cmFuc2Zvcm0tb3JpZ2luOiA1MCUgNTAlOyIgdHJhbnNmb3JtPSJtYXRyaXgoMC44NjYwMjYsIC0wLjUsIDAuNSwgMC44NjYwMjYsIC0xMC4yMDcxODMsIC0xMS44NjcyMjQpIiB4PSI2NC40MDQiIHk9IjQ5LjUxMiIgd2lkdGg9IjUiIGhlaWdodD0iMTQiIHJ4PSIxIiByeT0iMSIvPgogIDwvZz4KICA8cGF0aCBzdHlsZT0iZmlsbDogcmdiKDIyOSwgMTc4LCA5Myk7IiBkPSJNIDQ4LjU4NCA0MS45MzcgQyA1MS41OTUgNDIuMDAzIDUyLjQ4OSA0Mi43MiA1NC4wODkgNDUuMTU3IEwgNTguMzk2IDQyLjUzNCBDIDU3LjI0NyA0MC4wMTEgNTcuMjMzIDM4LjczNiA1OC44NDEgMzUuOTc5IEMgNTUuNzI5IDM3LjI4MiA0OC41NjkgNDEuOTUgNDguNTg0IDQxLjkzNyBaIi8+Cjwvc3ZnPg==">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#1e1018; --surface:#2a1520; --border:#4a2a38;
  --accent:#E5B25D; --accent3:#c9a0dc;
  --text:#E1E2EF; --muted:#8a6a78;
  --win:#7ec8a0; --loss:#d9534f; --admin:#c9a0dc;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html,body{width:100%;overflow-x:hidden;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;}
body::before{content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;
  background:radial-gradient(ellipse at 30% 20%,rgba(229,178,93,.06) 0%,transparent 50%),
             radial-gradient(ellipse at 70% 80%,rgba(53,30,41,.8) 0%,transparent 50%);
  pointer-events:none;z-index:0;}

/* HEADER */
header{width:100%;padding:.9rem 1.25rem;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:.75rem;position:relative;z-index:10;}
.header-logo{display:flex;align-items:center;gap:.6rem;flex-shrink:0;}
header h1{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:.08em;color:var(--accent);line-height:1;}
.header-sub{font-family:'DM Mono',monospace;font-size:.58rem;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;}
.header-right{margin-left:auto;display:flex;align-items:center;gap:.6rem;flex-shrink:0;}
#decay-status{font-size:.55rem;color:var(--muted);font-family:'DM Mono',monospace;letter-spacing:.07em;white-space:nowrap;display:none;}
@media(min-width:640px){#decay-status{display:block;}}

/* ADMIN BTN */
#admin-btn{background:none;border:1px solid var(--border);color:var(--muted);
  font-family:'DM Mono',monospace;font-size:.58rem;letter-spacing:.08em;text-transform:uppercase;
  padding:.35rem .65rem;cursor:pointer;transition:all .2s;white-space:nowrap;flex-shrink:0;}
#admin-btn:hover{border-color:var(--admin);color:var(--admin);}
#admin-btn.on{border-color:var(--admin);color:var(--admin);background:rgba(201,160,220,.1);}
.admin-btn-label{display:none;}
@media(min-width:480px){.admin-btn-label{display:inline;}}

/* NAV */
nav{width:100%;border-bottom:1px solid var(--border);position:relative;z-index:9;
  display:flex;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
nav::-webkit-scrollbar{display:none;}
nav button{background:none;border:none;color:var(--muted);font-family:'DM Mono',monospace;
  font-size:.68rem;letter-spacing:.07em;text-transform:uppercase;padding:.8rem 1rem;
  cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap;flex-shrink:0;}
nav button.active{color:var(--accent);border-bottom-color:var(--accent);}
nav button.admin-tab{color:var(--admin);opacity:.5;}
nav button.admin-tab.active{color:var(--admin);border-bottom-color:var(--admin);opacity:1;}
nav button:hover:not(.active){color:var(--text);}

/* MAIN */
main{padding:1.25rem;position:relative;z-index:1;width:100%;overflow-x:hidden;}
.panel{display:none;}.panel.active{display:block;width:100%;overflow-x:hidden;}

/* LEADERBOARD */
.lb-table{width:100%;border-collapse:collapse;}
.lb-table th{font-family:'DM Mono',monospace;font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;
  color:var(--muted);text-align:left;padding:.55rem .7rem;border-bottom:1px solid var(--border);}
.lb-table td{padding:.7rem;border-bottom:1px solid rgba(74,42,56,.5);vertical-align:middle;}
.lb-table tr:hover td{background:rgba(229,178,93,.04);}
.lb-table tbody tr{cursor:pointer;}
.rank{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;color:var(--muted);width:2.2rem;}
.rank.top1{color:var(--accent);}.rank.top2{color:#c0c0c0;}.rank.top3{color:#cd7f32;}
.lb-avatar{width:30px;height:30px;border-radius:50%;object-fit:cover;border:1px solid var(--border);background:var(--surface);flex-shrink:0;}
.lb-av-ph{width:30px;height:30px;border-radius:50%;background:var(--surface);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:.8rem;color:var(--muted);flex-shrink:0;}
.player-name{font-size:.9rem;font-weight:600;letter-spacing:.02em;}
.pname-cell{display:flex;align-items:center;gap:.55rem;}
.rating-val{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;color:var(--accent);letter-spacing:.05em;}
.rd-val{font-family:'DM Mono',monospace;font-size:.72rem;color:var(--muted);}
.record-badge{font-family:'DM Mono',monospace;font-size:.62rem;display:inline-flex;gap:.35rem;}
.record-badge .w{color:var(--win);}.record-badge .l{color:var(--loss);}

/* FORMS */
.form-card{background:var(--surface);border:1px solid var(--border);padding:1.25rem;margin-bottom:1.25rem;width:100%;}
.form-card h2{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:.08em;margin-bottom:1rem;color:var(--text);}
.field{margin-bottom:.9rem;}
label{display:block;font-family:'DM Mono',monospace;font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:.35rem;}
input,select,textarea{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);
  font-family:'DM Sans',sans-serif;font-size:.88rem;padding:.6rem .85rem;outline:none;
  transition:border-color .2s;appearance:none;border-radius:0;}
input:focus,select:focus,textarea:focus{border-color:var(--accent);}
input::placeholder,textarea::placeholder{color:var(--muted);}

.btn{background:var(--accent);color:#1e1018;border:none;font-family:'DM Mono',monospace;
  font-size:.68rem;letter-spacing:.1em;text-transform:uppercase;padding:.7rem 1.4rem;
  cursor:pointer;font-weight:500;transition:all .15s;display:inline-block;border-radius:0;}
.btn:hover{background:#f5e6cc;}.btn:disabled{opacity:.4;cursor:not-allowed;}
.btn-ghost{background:none;border:1px solid var(--border);color:var(--muted);
  font-family:'DM Mono',monospace;font-size:.62rem;letter-spacing:.07em;text-transform:uppercase;
  padding:.45rem .85rem;cursor:pointer;transition:all .15s;border-radius:0;}
.btn-ghost:hover{border-color:var(--text);color:var(--text);}
.btn-danger{background:var(--loss);color:#fff;border:none;font-family:'DM Mono',monospace;
  font-size:.58rem;letter-spacing:.07em;text-transform:uppercase;padding:.38rem .65rem;
  cursor:pointer;transition:opacity .15s;border-radius:0;}
.btn-danger:hover{opacity:.8;}
.btn-admin{background:rgba(201,160,220,.12);color:var(--admin);border:1px solid var(--admin);
  font-family:'DM Mono',monospace;font-size:.58rem;letter-spacing:.07em;text-transform:uppercase;
  padding:.38rem .65rem;cursor:pointer;transition:all .15s;border-radius:0;}
.btn-admin:hover{background:rgba(201,160,220,.22);}

.msg{font-family:'DM Mono',monospace;font-size:.68rem;padding:.6rem .85rem;margin-top:.65rem;
  border-left:3px solid var(--accent);background:rgba(229,178,93,.07);color:var(--accent);display:none;}
.msg.err{border-color:var(--loss);background:rgba(255,71,87,.05);color:var(--loss);}

/* HISTORY */
.hist-filters{display:flex;gap:.65rem;margin-bottom:1rem;flex-wrap:wrap;}
.hist-filters select{width:auto;min-width:150px;flex:1;}
.match-row{background:var(--surface);border:1px solid var(--border);padding:.75rem .9rem;
  margin-bottom:.35rem;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:.4rem;}
.match-player{display:flex;flex-direction:column;gap:.15rem;}
.match-player .name{font-weight:600;font-size:.82rem;}
.match-player .delta{font-family:'DM Mono',monospace;font-size:.62rem;}
.match-player .delta.pos{color:var(--win);}.match-player .delta.neg{color:var(--loss);}
.match-player .rdi{font-family:'DM Mono',monospace;font-size:.56rem;color:var(--muted);}
.match-mid{text-align:center;}
.match-result{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;color:var(--muted);letter-spacing:.07em;
  display:flex;align-items:center;gap:.3rem;justify-content:center;white-space:nowrap;}
.match-result .ws{color:var(--win);font-size:.8rem;}.match-result .ls{color:var(--loss);font-size:.8rem;}
.match-score-lbl{font-size:1.2rem;}
.match-date-lbl{font-family:'DM Mono',monospace;font-size:.55rem;color:var(--muted);margin-top:.2rem;}

.empty{font-family:'DM Mono',monospace;font-size:.72rem;color:var(--muted);text-align:center;padding:2.5rem 1rem;border:1px dashed var(--border);}
.loading{font-family:'DM Mono',monospace;font-size:.72rem;color:var(--muted);text-align:center;padding:2.5rem;letter-spacing:.1em;}
.loading::after{content:'';display:inline-block;width:10px;height:10px;border:2px solid var(--border);
  border-top-color:var(--accent);border-radius:50%;margin-left:8px;vertical-align:middle;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* PLAYER CARDS */
.cards-label{font-family:'DM Mono',monospace;font-size:.58rem;letter-spacing:.1em;color:var(--muted);margin-bottom:.65rem;}
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(min(220px,100%),1fr));gap:.65rem;width:100%;}
.player-card{background:var(--surface);border:1px solid var(--border);padding:.9rem;cursor:pointer;
  transition:border-color .2s,transform .15s;display:flex;flex-direction:column;gap:.65rem;
  min-width:0;max-width:100%;box-sizing:border-box;}
.player-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 18px rgba(229,178,93,.1);}
.pc-header{display:flex;align-items:center;gap:.65rem;}
.pc-avatar{width:42px;height:42px;border-radius:50%;object-fit:cover;border:2px solid var(--border);background:var(--bg);flex-shrink:0;}
.pc-av-ph{width:42px;height:42px;border-radius:50%;background:var(--bg);border:2px solid var(--border);
  display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:1rem;color:var(--muted);flex-shrink:0;}
.pc-name-block{min-width:0;}
.pc-name{font-weight:600;font-size:.9rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.pc-tag{font-family:'DM Mono',monospace;font-size:.48rem;letter-spacing:.07em;color:var(--loss);
  border:1px solid var(--loss);padding:.08rem .28rem;display:inline-block;margin-top:.12rem;}
.pc-stats{display:grid;grid-template-columns:1fr 1fr;gap:.45rem .65rem;}
.pc-stat{display:flex;flex-direction:column;gap:.08rem;}
.pc-stat-l{font-family:'DM Mono',monospace;font-size:.5rem;letter-spacing:.07em;text-transform:uppercase;color:var(--muted);}
.pc-stat-v{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;line-height:1;}
.pc-foot{display:flex;align-items:center;justify-content:space-between;padding-top:.6rem;border-top:1px solid var(--border);}
.pc-hint{font-family:'DM Mono',monospace;font-size:.5rem;color:var(--muted);letter-spacing:.06em;}

/* SEASON BADGES */
.season-badges{display:flex;flex-wrap:wrap;gap:.3rem;margin-top:.35rem;}
.s-badge{font-family:'Bebas Neue',sans-serif;font-size:.7rem;letter-spacing:.06em;padding:.18rem .45rem;border-radius:2px;display:inline-flex;align-items:center;gap:.25rem;line-height:1;}
.s-badge.rank1{background:linear-gradient(135deg,#b8860b,#ffd700,#b8860b);color:#1a1000;box-shadow:0 1px 6px rgba(255,215,0,.35);}
.s-badge.rank2{background:linear-gradient(135deg,#666,#c0c0c0,#666);color:#0a0a0a;}
.s-badge.rank3{background:linear-gradient(135deg,#7a4a1e,#cd7f32,#7a4a1e);color:#1a0800;}
.s-badge.rankN{background:var(--surface);color:var(--muted);border:1px solid var(--border);}
.s-history-wrap{border-top:1px solid var(--border);padding-top:.6rem;margin-top:.1rem;}
.s-history-select{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--muted);
  font-family:'DM Mono',monospace;font-size:.58rem;padding:.35rem .6rem;cursor:pointer;border-radius:0;appearance:none;}
.s-history-select:focus{border-color:var(--accent);outline:none;}
.s-history-data{font-family:'DM Mono',monospace;font-size:.62rem;color:var(--muted);line-height:1.7;margin-top:.4rem;padding:.5rem .65rem;background:rgba(0,0,0,.2);border:1px solid var(--border);}
.s-history-data strong{color:var(--text);}

/* SEASON COUNTDOWN in header */
#season-countdown{font-size:.55rem;color:var(--accent);font-family:'DM Mono',monospace;letter-spacing:.07em;white-space:nowrap;border:1px solid rgba(229,178,93,.3);padding:.25rem .5rem;max-width:120px;overflow:hidden;text-overflow:ellipsis;}
@media(min-width:480px){#season-countdown{max-width:none;}}
#season-countdown.urgent{color:var(--loss);border-color:rgba(217,83,79,.4);animation:pulse 1.5s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.6;}}

/* RULES */
.rules-wrap{max-width:580px;}
.rules-list{display:flex;flex-direction:column;}
.rule-item{display:flex;align-items:flex-start;gap:.9rem;padding:.9rem 0;border-bottom:1px solid var(--border);}
.rule-item:last-child{border-bottom:none;}
.rule-icon{font-family:'Bebas Neue',sans-serif;font-size:1rem;color:var(--accent);min-width:1.8rem;text-align:center;padding-top:.1rem;flex-shrink:0;}
.rule-title{font-weight:600;font-size:.88rem;color:var(--text);margin-bottom:.22rem;}
.rule-desc{font-family:'DM Mono',monospace;font-size:.65rem;color:var(--muted);line-height:1.6;}

/* PROFILE MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(5,5,10,.88);
  backdrop-filter:blur(6px);z-index:200;align-items:center;justify-content:center;padding:.75rem;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);width:100%;max-width:800px;
  max-height:92vh;overflow-y:auto;animation:mIn .2s ease;}
@keyframes mIn{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
.modal-header{padding:1.25rem;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;gap:.75rem;}
.mh-left{display:flex;gap:.85rem;align-items:flex-start;flex:1;min-width:0;}
.m-av-wrap{position:relative;flex-shrink:0;}
.m-avatar{width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid var(--border);display:block;}
.m-av-ph{width:60px;height:60px;border-radius:50%;background:var(--bg);border:2px solid var(--border);
  display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:1.3rem;color:var(--muted);}
.m-av-upload{position:absolute;bottom:-2px;right:-2px;width:20px;height:20px;background:var(--accent);
  border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;
  font-size:.7rem;color:#1e1018;border:2px solid var(--surface);font-weight:700;line-height:1;}
.m-av-upload:hover{background:#f5e6cc;}
.m-av-input{display:none;}
.m-player-info{flex:1;min-width:0;}
.m-player-name{font-family:'Bebas Neue',sans-serif;font-size:1.9rem;letter-spacing:.06em;color:var(--text);line-height:1;word-break:break-word;}
.m-stats{display:flex;gap:1rem;flex-wrap:wrap;margin-top:.4rem;}
.m-stat{display:flex;flex-direction:column;gap:.12rem;}
.m-stat-l{font-family:'DM Mono',monospace;font-size:.52rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);}
.m-stat-v{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;color:var(--accent);line-height:1;}
.m-stat-v.neutral{color:var(--text);}.m-stat-v.green{color:var(--win);}.m-stat-v.red{color:var(--loss);}
.m-close{background:none;border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;
  font-size:.62rem;letter-spacing:.07em;padding:.35rem .65rem;cursor:pointer;flex-shrink:0;transition:all .15s;}
.m-close:hover{border-color:var(--text);color:var(--text);}
.modal-body{padding:1.25rem;}
.m-quote{font-family:'DM Mono',monospace;font-size:.68rem;color:var(--muted);font-style:italic;margin-top:.4rem;line-height:1.6;}
.m-quote .qa{color:var(--accent);font-style:normal;}
.quote-row{display:flex;gap:.4rem;margin-top:.45rem;}
.quote-row input{font-size:.72rem;padding:.38rem .6rem;}
.quote-row .btn{padding:.38rem .65rem;font-size:.56rem;}
.upload-prog{font-family:'DM Mono',monospace;font-size:.6rem;color:var(--accent);margin-top:.4rem;display:none;}

/* CHART */
.chart-section{margin-bottom:1.4rem;}
.chart-lbl{font-family:'DM Mono',monospace;font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:.65rem;}
.chart-outer{border:1px solid var(--border);background:var(--bg);overflow-x:auto;overflow-y:hidden;position:relative;height:175px;cursor:crosshair;}
.chart-outer::-webkit-scrollbar{height:3px;}.chart-outer::-webkit-scrollbar-track{background:var(--bg);}.chart-outer::-webkit-scrollbar-thumb{background:var(--border);}
.chart-wrap{position:relative;display:inline-block;min-width:100%;}
.chart-tip{position:absolute;background:var(--surface);border:1px solid var(--border);padding:.38rem .65rem;
  font-family:'DM Mono',monospace;font-size:.62rem;color:var(--text);pointer-events:none;
  z-index:20;display:none;line-height:1.6;white-space:nowrap;box-shadow:0 4px 14px rgba(0,0,0,.5);}

/* PROFILE MATCHES */
.pm-row{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:.65rem;
  padding:.65rem 0;border-bottom:1px solid rgba(74,42,56,.6);}
.pm-row:last-child{border-bottom:none;}
.pm-badge{font-family:'Bebas Neue',sans-serif;font-size:.82rem;width:2.7rem;text-align:center;padding:.22rem 0;letter-spacing:.05em;}
.pm-badge.win{color:var(--win);background:rgba(71,255,184,.08);}
.pm-badge.loss{color:var(--loss);background:rgba(255,71,87,.08);}
.pm-info{display:flex;flex-direction:column;gap:.12rem;min-width:0;}
.pm-opp{font-weight:600;font-size:.82rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.pm-date{font-family:'DM Mono',monospace;font-size:.58rem;color:var(--muted);}
.pm-delta{font-family:'DM Mono',monospace;font-size:.75rem;text-align:right;white-space:nowrap;}
.pm-delta.pos{color:var(--win);}.pm-delta.neg{color:var(--loss);}

/* ADMIN PANEL */
.admin-section{margin-bottom:1.75rem;}
.admin-stitle{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:.08em;color:var(--admin);
  margin-bottom:.85rem;padding-bottom:.45rem;border-bottom:1px solid rgba(201,160,220,.2);}
.admin-prow{display:flex;align-items:center;gap:.65rem;padding:.65rem;background:var(--surface);
  border:1px solid var(--border);margin-bottom:.35rem;flex-wrap:wrap;}
.admin-prow:hover{border-color:var(--admin);}
.admin-pname{flex:1;font-weight:600;font-size:.88rem;min-width:80px;}
.admin-prating{font-family:'DM Mono',monospace;font-size:.7rem;color:var(--muted);}
.admin-mrow{display:flex;align-items:center;gap:.65rem;padding:.6rem .7rem;background:var(--surface);
  border:1px solid var(--border);margin-bottom:.35rem;flex-wrap:wrap;}
.admin-mrow:hover{border-color:var(--loss);}
.admin-minfo{flex:1;font-family:'DM Mono',monospace;font-size:.65rem;color:var(--muted);line-height:1.5;}
.admin-minfo strong{color:var(--text);font-family:'DM Sans',sans-serif;font-size:.82rem;}

/* ADMIN LOGIN / EDIT MODALS */
.am-overlay{display:none;position:fixed;inset:0;background:rgba(5,5,10,.92);z-index:300;align-items:center;justify-content:center;padding:.75rem;}
.am-overlay.open{display:flex;}
.am-box{background:var(--surface);border:1px solid var(--admin);padding:1.75rem;width:100%;max-width:350px;animation:mIn .2s ease;}
.am-box h2{font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:.08em;color:var(--admin);margin-bottom:1.1rem;}

/* QUOTES */
.lb-quote{font-family:'DM Mono',monospace;font-size:.78rem;color:var(--muted);font-style:italic;
  margin-bottom:1.1rem;text-align:center;letter-spacing:.02em;line-height:1.6;opacity:.7;}
.lb-quote .qa{color:var(--muted);font-style:normal;opacity:.8;}

/* SCROLLBARS */
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border);}
::-webkit-scrollbar-thumb:hover{background:var(--muted);}
*{scrollbar-width:thin;scrollbar-color:var(--border) var(--bg);}

/* RESPONSIVE */
@media(min-width:480px){
  header{padding:1.1rem 1.75rem;}
  header h1{font-size:2.6rem;}
  main{padding:1.5rem 1.75rem;}
}
@media(min-width:640px){
  header{padding:1.2rem 2rem;}
  header h1{font-size:3rem;}
  nav{padding:0 2rem;}
  main{padding:1.75rem 2rem;}
  .match-row{grid-template-columns:1fr auto 1fr auto;}
  .match-meta-col{display:block;text-align:right;font-family:'DM Mono',monospace;font-size:.58rem;color:var(--muted);line-height:1.6;}
  .match-date-lbl{display:none;}
}
@media(min-width:900px){
  .players-layout{display:grid;grid-template-columns:360px 1fr;gap:1.5rem;align-items:start;}
  .players-sidebar-mobile{display:none;}
  #players-list-desktop{display:block;}
}
@media(max-width:899px){
  #players-list-desktop{display:none;}
  .players-sidebar-mobile{display:block;}
  .players-layout{width:100%;}
  .players-sidebar{width:100%;max-width:100%;}
  .form-card{width:100%;max-width:100%;box-sizing:border-box;}
}
.match-meta-col{display:none;}
</style>
</head>
<body>

<header>
  <div class="header-logo">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="-1 15 65 40" style="height:32px;width:auto;flex-shrink:0">
      <g fill="#E5B25D" transform="matrix(0.67465,0,0,0.67465,0,17)">
        <path d="M0,51.17l59.29.34L29.94,0,0,51.17ZM10.57,45.16L29.87,12.16l18.92,33.21-38.22-.22Z"/>
        <path d="M56.43,49.84l-53.56-.31L29.92,3.31l26.52,46.54ZM4.61,48.54l50.09.29L29.91,5.31,4.61,48.54ZM53.38,48.06l-47.42-.27L29.9,6.85l23.48,41.2ZM7.69,46.79l43.96.25L29.89,8.85,7.69,46.79Z"/>
      </g>
      <g><g fill="#E5B25D" transform="matrix(0.5002,0,0,0.5002,5.244337,16.159662)">
        <path d="M85.83,1.68h-.2c-13.75,0-24.95,11.17-24.99,24.92-.04,13.78,11.14,25.02,24.93,25.06h.2c13.75,0,24.95-11.17,24.99-24.92.04-13.78-11.14-25.02-24.93-25.06ZM82.49,8.06l-.09,15.41-15.3-.09c.66-3.79,2.46-7.29,5.23-10.07,2.8-2.8,6.33-4.6,10.16-5.25ZM82.36,29.54l-.09,15.71c-3.77-.7-7.3-2.53-10.01-5.29-2.86-2.89-4.65-6.56-5.24-10.51l15.34.09ZM88.35,45.37l.09-15.79,15.91.09c-1.32,8.12-7.83,14.54-16,15.7ZM88.48,23.5l.09-15.49c8.05,1.24,14.43,7.57,15.77,15.58l-15.86-.09Z"/>
      </g>
      <rect style="fill:rgb(229,178,93);transform-box:fill-box;transform-origin:50% 50%;" transform="matrix(0.866026,-0.5,0.5,0.866026,-10.207183,-11.867224)" x="64.404" y="49.512" width="5" height="14" rx="1" ry="1"/>
      </g>
      <path style="fill:rgb(229,178,93);" d="M48.584,41.937C51.595,42.003,52.489,42.72,54.089,45.157L58.396,42.534C57.247,40.011,57.233,38.736,58.841,35.979C55.729,37.282,48.569,41.95,48.584,41.937Z"/>
    </svg>
    <h1>TTTIW</h1>
  </div>
  <span class="header-sub" style="display:none" id="header-sub-text">Table Tennis ¬∑ Texas Invention<span style="color:var(--accent)">Works</span></span>
  <div class="header-right">
    <span id="decay-status"></span>
    <span id="season-countdown" style="display:none"></span>
    <button id="admin-btn" onclick="openAdminLogin()">‚öô<span class="admin-btn-label"> Admin</span></button>
  </div>
</header>

<nav>
  <button class="active" onclick="showPanel('leaderboard',this)">Leaderboard</button>
  <button onclick="showPanel('players',this)">Players</button>
  <button onclick="showPanel('match',this)">Submit Match</button>
  <button onclick="showPanel('history',this)">Match History</button>
  <button onclick="showPanel('rules',this)">Rules</button>
  <button onclick="showPanel('pong',this)">Pong</button>
  <button id="admin-tab-btn" class="admin-tab" onclick="showPanel('admin',this)" style="display:none">‚òÖ Admin</button>
</nav>

<main>
  <!-- LEADERBOARD -->
  <div id="panel-leaderboard" class="panel active">
    <div id="lb-loading" class="loading">Loading leaderboard</div>
    <table class="lb-table" id="lb-table" style="display:none">
      <thead><tr><th>#</th><th>Player</th><th>Rating</th><th>RD</th><th>W‚ÄìL</th></tr></thead>
      <tbody id="lb-body"></tbody>
    </table>
    <div id="lb-empty" class="empty" style="display:none">No players yet.</div>
  </div>

  <!-- PLAYERS -->
  <div id="panel-players" class="panel">
    <div class="players-layout">
      <div class="players-sidebar">
        <div class="form-card">
          <h2>Add Player</h2>
          <div class="field"><label>Player Name</label><input type="text" id="player-name" placeholder="Enter name‚Ä¶"></div>
          <button class="btn" id="add-player-btn" onclick="addPlayer()">Add Player</button>
          <div class="msg" id="player-msg"></div>
          <p style="font-family:'DM Mono',monospace;font-size:.58rem;color:var(--muted);margin-top:.65rem;line-height:1.7">
            New players start at <span style="color:var(--accent)">1500</span> ¬∑ RD <span style="color:var(--accent)">120</span>.<br>
            Tap any player card to add a profile photo &amp; quote.
          </p>
        </div>
        <div class="players-sidebar-mobile" id="players-list-mobile"></div>
      </div>
      <div id="players-list-desktop"></div>
    </div>
  </div>

  <!-- SUBMIT MATCH -->
  <div id="panel-match" class="panel">
    <div style="max-width:460px">
      <div class="form-card">
        <h2>Submit Match Result</h2>
        <div class="field"><label>Winner</label><select id="match-winner"></select></div>
        <div class="field"><label>Loser</label><select id="match-loser"></select></div>
        <div class="field"><label>Score (optional)</label><input type="text" id="match-score" placeholder="e.g. 11-7"></div>
        <button class="btn" id="submit-match-btn" onclick="submitMatch()">Submit Match</button>
        <div class="msg" id="match-msg"></div>
      </div>
    </div>
  </div>

  <!-- HISTORY -->
  <div id="panel-history" class="panel">
    <div class="hist-filters">
      <select id="history-filter" onchange="renderHistory()"><option value="all">All Players</option></select>
    </div>
    <div id="history-list"><div class="loading">Loading matches</div></div>
  </div>

  <!-- RULES -->
  <div id="panel-rules" class="panel">
    <div class="rules-wrap">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:.08em;color:var(--text);margin-bottom:1.1rem">House Rules</div>
      <div class="rules-list">
        <div class="rule-item"><div class="rule-icon">11</div><div><div class="rule-title">First to 11</div><div class="rule-desc">Win by reaching 11 points with a 2-point lead.</div></div></div>
        <div class="rule-item"><div class="rule-icon">2√ó</div><div><div class="rule-title">2 Serves Each</div><div class="rule-desc">Players alternate with 2 serves per turn.</div></div></div>
        <div class="rule-item"><div class="rule-icon">‚àû</div><div><div class="rule-title">Deuce Serving</div><div class="rule-desc">At 10‚Äì10 (deuce), alternate serves every point.</div></div></div>
        <div class="rule-item"><div class="rule-icon">6‚Ä≥</div><div><div class="rule-title">Serve Height</div><div class="rule-desc">Ball must be struck 6 inches above the table surface.</div></div></div>
        <div class="rule-item"><div class="rule-icon">‚öñ</div><div><div class="rule-title">Fairness Rule</div><div class="rule-desc">Beating stronger players gains more rating points.</div></div></div>
      </div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:.08em;color:var(--text);margin:1.75rem 0 1.1rem">Rating System</div>
      <div class="rules-list">
        <div class="rule-item"><div class="rule-icon" style="font-size:.8rem">RD</div><div><div class="rule-title">Rating Deviation</div><div class="rule-desc">RD measures how confident the system is in a player's rating. A low RD means the rating is reliable; a high RD means more uncertainty. New players start at RD 120. After enough games, RD can drop below 100 ‚Äî only then does a player appear on the leaderboard. RD also decreases as you play more matches.</div></div></div>
        <div class="rule-item"><div class="rule-icon" style="font-size:.7rem">‚è± RD</div><div><div class="rule-title">RD Decay (Inactivity)</div><div class="rule-desc">If you stop playing, your RD slowly increases over time ‚Äî because the system becomes less certain your rating is still accurate. This happens on a configurable timer (default: every 4 hours of inactivity). Each period of inactivity increases RD using the Glicko-2 formula œÜ* = ‚àö(œÜ¬≤ + œÉ¬≤). RD is capped at 200. If your RD rises above 100 you'll be hidden from the leaderboard until you play again.</div></div></div>
        <div class="rule-item"><div class="rule-icon" style="font-size:.8rem">G2</div><div><div class="rule-title">Glicko-2 Algorithm</div><div class="rule-desc">Uses Glicko-2, an improvement on ELO. Every match updates both players' ratings based on expected outcome ‚Äî upsets gain more, expected wins gain less. Starting rating: 1500.</div></div></div>
      </div>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="panel-admin" class="panel">
    <div style="max-width:820px">

      <div class="admin-section">
        <div class="admin-stitle">Season Settings</div>
        <div class="form-card" style="border-color:rgba(201,160,220,.3);max-width:480px">
          <p style="font-family:'DM Mono',monospace;font-size:.65rem;color:var(--muted);margin-bottom:.9rem;line-height:1.6">Set a season end date. When the deadline passes, you can trigger a season reset ‚Äî all ratings return to 1500, RD to 120, wins/losses to 0, and a snapshot of final rankings is saved to each player's history.</p>
          <div class="field">
            <label>Season Name</label>
            <input type="text" id="season-name-input" placeholder="e.g. Spring 2025">
          </div>
          <div class="field">
            <label>Season End Date</label>
            <input type="datetime-local" id="season-deadline-input">
          </div>
          <div style="display:flex;gap:.6rem;flex-wrap:wrap">
            <button class="btn" onclick="saveSeason()">Save Season Deadline</button>
            <button class="btn-danger" id="reset-season-btn" onclick="triggerSeasonReset()" style="padding:.7rem 1.2rem;font-size:.65rem">‚ö° Reset Season Now</button>
          </div>
          <div class="msg" id="season-msg"></div>
          <div id="season-status-admin" style="font-family:'DM Mono',monospace;font-size:.62rem;color:var(--muted);margin-top:.75rem;line-height:1.7;display:none"></div>
        </div>
      </div>

      <div class="admin-section">
        <div class="admin-stitle">RD Decay Settings</div>
        <div class="form-card" style="border-color:rgba(201,160,220,.15);max-width:480px">
          <p style="font-family:'DM Mono',monospace;font-size:.65rem;color:var(--muted);margin-bottom:.9rem;line-height:1.6">RD increases each inactive period using the Glicko-2 formula <strong style="color:var(--text)">œÜ* = ‚àö(œÜ¬≤ + œÉ¬≤)</strong>. Default: 4 hours ¬∑ Max RD: 200 ¬∑ Hidden from leaderboard if RD &gt; 100.</p>
          <div id="decay-info" style="font-family:'DM Mono',monospace;font-size:.62rem;color:var(--muted);line-height:1.8;padding:.6rem .8rem;background:rgba(0,0,0,.2);border:1px solid var(--border);margin-bottom:.9rem">
            Loading current settings‚Ä¶
          </div>
          <div class="field">
            <label>Decay Period</label>
            <div style="display:flex;gap:.6rem">
              <input type="number" id="decay-amount" value="4" min="1" style="width:90px;flex-shrink:0;flex:none">
              <select id="decay-unit">
                <option value="minutes">Minutes</option>
                <option value="hours" selected>Hours</option>
                <option value="days">Days</option>
              </select>
            </div>
          </div>
          <button class="btn" onclick="saveDecay()">Save Decay Settings</button>
          <div class="msg" id="decay-msg"></div>
        </div>
      </div>

      <div class="admin-section">
        <div class="admin-stitle">Repair Ratings</div>
        <div class="form-card" style="border-color:rgba(201,160,220,.15);max-width:480px">
          <p style="font-family:'DM Mono',monospace;font-size:.65rem;color:var(--muted);margin-bottom:.9rem;line-height:1.6">Recalculates every player's rating and RD directly from their last stored match result, then applies any accumulated decay since that match. Use this to fix any players whose RD was incorrectly reset.</p>
          <button class="btn-admin" onclick="repairAllRatings()" style="font-size:.68rem;padding:.65rem 1.2rem">üîß Repair All Ratings From Match History</button>
          <div class="msg" id="repair-msg" style="margin-top:.65rem"></div>
        </div>
      </div>

      <div class="admin-section">
        <div class="admin-stitle">Manage Players</div>
        <div id="admin-players-list"><div class="loading">Loading</div></div>
      </div>

      <div class="admin-section">
        <div class="admin-stitle">Match Log (Delete &amp; Recalculate)</div>
        <p style="font-family:'DM Mono',monospace;font-size:.62rem;color:var(--muted);margin-bottom:.75rem;line-height:1.5">Deleting a match will recalculate all ratings and RD from that point forward, including time-based decay.</p>
        <div id="admin-matches-list"><div class="loading">Loading</div></div>
      </div>

    </div>
  </div>

  <!-- PONG -->
  <div id="panel-pong" class="panel">
    <div style="display:flex;flex-direction:column;align-items:center;gap:.75rem;padding:.5rem 0">
      <div style="font-family:'DM Mono',monospace;font-size:.6rem;letter-spacing:.12em;text-transform:uppercase;color:var(--muted)">Every point scored = faster ball ¬∑ Mouse / ‚Üë‚Üì arrows / touch to move</div>
      <div style="position:relative;display:inline-block">
        <canvas id="pong-canvas" width="600" height="400" style="display:block;border:1px solid var(--border);background:#0d080b;max-width:100%;touch-action:none;"></canvas>
        <div id="pong-overlay" style="position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;background:rgba(13,8,11,.85)">
          <div id="pong-overlay-title" style="font-family:'Bebas Neue',sans-serif;font-size:2.8rem;color:var(--accent);letter-spacing:.1em">PONG</div>
          <div id="pong-overlay-sub" style="font-family:'DM Mono',monospace;font-size:.65rem;color:var(--muted);margin-top:.25rem;letter-spacing:.08em;text-align:center;padding:0 1rem">Click or tap to start</div>
          <div style="font-family:'DM Mono',monospace;font-size:.58rem;color:var(--muted);margin-top:.4rem;letter-spacing:.06em;text-align:center;line-height:1.8">
            üñ± Mouse ¬∑ ‚Üë‚Üì Arrow keys ¬∑ W/S keys<br>üì± Touch &amp; drag on mobile
          </div>
          <button id="pong-start-btn" onclick="startPong()" style="margin-top:1.2rem;background:var(--accent);color:#1e1018;border:none;font-family:'DM Mono',monospace;font-size:.72rem;letter-spacing:.1em;text-transform:uppercase;padding:.65rem 1.6rem;cursor:pointer;">‚ñ∂ START</button>
        </div>
      </div>
      <div style="display:flex;gap:2rem;font-family:'DM Mono',monospace;font-size:.62rem;color:var(--muted);letter-spacing:.07em">
        <span>YOU <span id="pong-score-player" style="color:var(--accent);font-size:1.1rem;font-family:'Bebas Neue',sans-serif">0</span></span>
        <span>CPU <span id="pong-score-cpu" style="color:var(--loss);font-size:1.1rem;font-family:'Bebas Neue',sans-serif">0</span></span>
        <span>SPEED <span id="pong-speed-display" style="color:var(--win);font-size:1.1rem;font-family:'Bebas Neue',sans-serif">1√ó</span></span>
      </div>
    </div>
  </div>
</main>

<!-- PROFILE MODAL -->
<div class="modal-overlay" id="profile-overlay" onclick="closeProfile(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="mh-left">
        <div class="m-av-wrap" id="m-av-wrap">
          <div class="m-av-ph" id="m-av-ph">?</div>
          <label class="m-av-upload" title="Upload photo">+<input type="file" class="m-av-input" id="m-av-input" accept="image/*"></label>
        </div>
        <div class="m-player-info">
          <div class="m-player-name" id="profile-name">‚Äî</div>
          <div class="m-stats" id="profile-stats"></div>
          <div class="m-quote" id="profile-quote" style="display:none"></div>
          <div class="quote-row">
            <input type="text" id="quote-input-modal" placeholder='"Leaderboard quote‚Ä¶"'>
            <button class="btn" onclick="saveQuoteModal()">Save</button>
          </div>
          <div class="msg" id="quote-msg-modal" style="margin-top:.35rem;padding:.3rem .6rem;font-size:.58rem"></div>
          <div class="upload-prog" id="upload-prog">Uploading‚Ä¶</div>
        </div>
      </div>
      <button class="m-close" onclick="document.getElementById('profile-overlay').classList.remove('open')">‚úï</button>
    </div>
    <div class="modal-body">
      <div class="chart-section">
        <div class="chart-lbl">Rating History</div>
        <div class="chart-outer" id="chart-outer">
          <div class="chart-wrap" id="chart-wrap">
            <canvas id="rating-chart"></canvas>
            <div class="chart-tip" id="chart-tip"></div>
          </div>
        </div>
      </div>
      <div id="profile-matches"></div>
    </div>
  </div>
</div>

<!-- CROP MODAL -->
<div class="am-overlay" id="crop-overlay" style="z-index:400">
  <div style="background:var(--surface);border:1px solid var(--border);width:100%;max-width:380px;animation:mIn .2s ease">
    <div style="padding:1rem 1.25rem;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between">
      <span style="font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:.08em;color:var(--text)">Crop Photo</span>
      <button class="m-close" onclick="closeCropModal()">‚úï</button>
    </div>
    <div style="padding:1.25rem">
      <p style="font-family:'DM Mono',monospace;font-size:.6rem;color:var(--muted);margin-bottom:.85rem;line-height:1.6">Drag to reposition ¬∑ Scroll or pinch to zoom</p>
      <div style="display:flex;justify-content:center;margin-bottom:1rem">
        <div id="crop-viewport" style="width:240px;height:240px;border-radius:50%;overflow:hidden;border:2px solid var(--accent);position:relative;cursor:grab;background:#111;touch-action:none;flex-shrink:0">
          <img id="crop-img" style="position:absolute;transform-origin:top left;user-select:none;-webkit-user-drag:none;pointer-events:none" draggable="false">
        </div>
      </div>
      <div style="margin-bottom:1rem">
        <label style="display:block;font-family:'DM Mono',monospace;font-size:.56rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:.35rem">Zoom</label>
        <input type="range" id="crop-zoom" min="1" max="4" step="0.01" value="1" style="width:100%;padding:0;height:3px;accent-color:var(--accent)">
      </div>
      <div style="display:flex;gap:.6rem">
        <button class="btn" id="crop-confirm-btn" onclick="confirmCrop()">Use Photo</button>
        <button class="btn-ghost" onclick="closeCropModal()">Cancel</button>
      </div>
      <div class="msg" id="crop-msg" style="margin-top:.65rem"></div>
    </div>
  </div>
</div>

<!-- ADMIN LOGIN MODAL -->
<div class="am-overlay" id="admin-login-overlay" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="am-box">
    <h2>Admin Login</h2>
    <div class="field"><label>Password</label>
      <input type="password" id="admin-pw" placeholder="Enter password‚Ä¶" onkeydown="if(event.key==='Enter')submitAdminLogin()">
    </div>
    <div style="display:flex;gap:.65rem">
      <button class="btn" onclick="submitAdminLogin()">Login</button>
      <button class="btn-ghost" onclick="document.getElementById('admin-login-overlay').classList.remove('open')">Cancel</button>
    </div>
    <div class="msg" id="admin-login-msg" style="margin-top:.65rem"></div>
  </div>
</div>

<!-- EDIT PLAYER MODAL -->
<div class="am-overlay" id="admin-edit-overlay" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="am-box">
    <h2>Edit Player Stats</h2>
    <input type="hidden" id="edit-pid">
    <div class="field"><label>Rating</label><input type="number" id="edit-rating" step="0.1"></div>
    <div class="field"><label>RD</label><input type="number" id="edit-rd" step="0.1"></div>
    <div class="field"><label>Wins</label><input type="number" id="edit-wins" step="1" min="0"></div>
    <div class="field"><label>Losses</label><input type="number" id="edit-losses" step="1" min="0"></div>
    <div style="display:flex;gap:.65rem">
      <button class="btn" onclick="submitEditPlayer()">Save Changes</button>
      <button class="btn-ghost" onclick="document.getElementById('admin-edit-overlay').classList.remove('open')">Cancel</button>
    </div>
    <div class="msg" id="edit-player-msg" style="margin-top:.65rem"></div>
  </div>
</div>

<script type="module">
// ‚îÄ‚îÄ FIREBASE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const FIREBASE_CONFIG = {
  apiKey:"AIzaSyCHRQOLzC0DcuZv4aCqsL4EM_IVthiZSIc",
  authDomain:"tttiw-6d44e.firebaseapp.com",
  projectId:"tttiw-6d44e",
  storageBucket:"tttiw-6d44e.firebasestorage.app",
  messagingSenderId:"902138155809",
  appId:"1:902138155809:web:0860c66b77d07746952460"
};
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import{getFirestore,collection,doc,addDoc,setDoc,updateDoc,deleteDoc,getDocs,onSnapshot,query,orderBy,serverTimestamp,runTransaction}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
const app=initializeApp(FIREBASE_CONFIG);
const db=getFirestore(app);

// ‚îÄ‚îÄ STATE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let players=[],matches=[],isAdmin=false,curProfileId=null;
const ADMIN_PW='pppaddle',SIGMA=0.06,RD_MAX=200;

// Show subtitle on wider screens
const mq=window.matchMedia('(min-width:520px)');
const toggleSub=()=>document.getElementById('header-sub-text').style.display=mq.matches?'block':'none';
mq.addEventListener('change',toggleSub); toggleSub();

// ‚îÄ‚îÄ ADMIN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.openAdminLogin=function(){
  if(isAdmin){
    isAdmin=false;
    const lbl=document.querySelector('#admin-btn .admin-btn-label');
    if(lbl)lbl.textContent=' Admin';
    document.getElementById('admin-btn').classList.remove('on');
    document.getElementById('admin-tab-btn').style.display='none';
    showPanel('leaderboard',document.querySelector('nav button'));return;
  }
  document.getElementById('admin-pw').value='';document.getElementById('admin-login-msg').style.display='none';
  document.getElementById('admin-login-overlay').classList.add('open');
  setTimeout(()=>document.getElementById('admin-pw').focus(),120);
};
window.submitAdminLogin=function(){
  if(document.getElementById('admin-pw').value===ADMIN_PW){
    isAdmin=true;document.getElementById('admin-login-overlay').classList.remove('open');
    const lbl=document.querySelector('#admin-btn .admin-btn-label');
    if(lbl)lbl.textContent=' Logout';
    document.getElementById('admin-btn').classList.add('on');
    document.getElementById('admin-tab-btn').style.display='';
    renderAdminPanel();
  }else{const m=document.getElementById('admin-login-msg');m.textContent='Incorrect password.';m.className='msg err';m.style.display='block';}
};

// ‚îÄ‚îÄ LISTENERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
onSnapshot(query(collection(db,'players'),orderBy('rating','desc')),snap=>{
  players=snap.docs.map(d=>({firestoreId:d.id,...d.data()}));
  renderLeaderboard();renderPlayersList();renderMatchSelects();updateDecayStatus();
  if(isAdmin)renderAdminPanel();
},err=>console.error(err));

onSnapshot(query(collection(db,'matches'),orderBy('date','desc')),snap=>{
  matches=snap.docs.map(d=>({firestoreId:d.id,...d.data()}));
  renderHistory();if(isAdmin)renderAdminPanel();
},err=>console.error(err));

onSnapshot(doc(db,'config','decay'),snap=>{
  if(snap.exists()){
    const d=snap.data();
    const amt=d.amount||7, unt=d.unit||'days';
    document.getElementById('decay-amount').value=amt;
    const sel=document.getElementById('decay-unit');
    if(sel){for(let o of sel.options){if(o.value===unt){o.selected=true;break;}}}
  }
  applyDecayLocally();updateDecayStatus();
  updateDecayInfo();
});
setInterval(updateDecayStatus,1000);
setInterval(applyDecayLocally,5000);

function updateDecayInfo(){
  const di=document.getElementById('decay-info');
  if(!di)return;
  const a=document.getElementById('decay-amount').value||'7';
  const u=document.getElementById('decay-unit').value||'days';
  di.textContent=`Decay period: ${a} ${u} ¬∑ Max RD: 200 ¬∑ Players hidden if RD > 100`;
}

// ‚îÄ‚îÄ DECAY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function decayMs(){
  const a=parseFloat(document.getElementById('decay-amount').value)||7;
  const u=document.getElementById('decay-unit').value||'days';
  if(u==='minutes')return a*6e4;
  if(u==='hours')return a*36e5;
  return a*864e5;
}
// Global decay epoch: periods are aligned to midnight Jan 1 2025 UTC.
// Every player decays on the same universal ticks regardless of when they last played.
// e.g. with 4hr periods: ticks at 12am, 4am, 8am, 12pm, 4pm, 8pm every day.
const DECAY_EPOCH=new Date('2025-01-01T00:00:00Z').getTime();

function currentDecayPeriod(ms){
  // Which global tick number are we at right now?
  return Math.floor((Date.now()-DECAY_EPOCH)/ms);
}

function computeDecay(p){
  const ms=decayMs();
  // Find the player's most recent match timestamp from in-memory matches array
  // Use it as a floor ‚Äî lastDecayAt can never be earlier than the last match
  const pid=p.firestoreId;
  let lastMatchTs=0;
  for(const m of matches){
    if(m.p1id===pid||m.p2id===pid){
      const ts=m.date?.toDate?m.date.toDate().getTime():new Date(m.date).getTime();
      if(ts>lastMatchTs)lastMatchTs=ts;
    }
  }
  // basePeriod: use the LATER of lastDecayAt and last match time
  // so a stale lastDecayAt can never count periods before the last match
  const lastProcessed=Math.max(p.lastDecayAt||DECAY_EPOCH, lastMatchTs||DECAY_EPOCH);
  const basePeriod=Math.floor((lastProcessed-DECAY_EPOCH)/ms);
  const nowPeriod=currentDecayPeriod(ms);
  const per=nowPeriod-basePeriod;
  if(per<=0)return null;

  let phi=p.rd/173.7178,phiMax=RD_MAX/173.7178;
  for(let i=0;i<per;i++){phi=Math.sqrt(phi*phi+SIGMA*SIGMA);if(phi>=phiMax){phi=phiMax;break;}}

  // newLast = timestamp of the most recent completed global tick
  const newLast=DECAY_EPOCH+nowPeriod*ms;
  return{newRD:Math.round(Math.min(phi*173.7178,RD_MAX)*10)/10,newLast};
}
function applyDecayLocally(){
  const ranked=players.filter(p=>p.rd<=100).sort((a,b)=>b.rating-a.rating);
  const topBefore=ranked[0]||null;
  players.forEach(p=>{
    const r=computeDecay(p);if(!r)return;
    p.rd=r.newRD;p.lastDecayAt=r.newLast;
    const upd={rd:r.newRD,lastDecayAt:r.newLast};
    // If this player was #1 and just decayed above RD 100, end their streak
    if(topBefore&&p.firestoreId===topBefore.firestoreId&&r.newRD>100&&p.no1Since){
      const dur=Date.now()-(p.no1Since||Date.now());
      const prev=p.longestNo1Ms||0;
      upd.no1Since=null;
      if(dur>prev)upd.longestNo1Ms=dur;
      p.no1Since=null;if(dur>prev)p.longestNo1Ms=dur;
    }
    updateDoc(doc(db,'players',p.firestoreId),upd).catch(()=>{});
  });
}
function updateDecayStatus(){
  const el=document.getElementById('decay-status');
  if(!el)return;
  const ms=decayMs(),now=Date.now();
  const a=document.getElementById('decay-amount').value||'4';
  const u=document.getElementById('decay-unit').value||'hours';
  const lbl=a+u.charAt(0).toUpperCase();
  // Next global tick aligned to epoch
  const nowPeriod=Math.floor((now-DECAY_EPOCH)/ms);
  const nextTick=DECAY_EPOCH+(nowPeriod+1)*ms;
  const diff=nextTick-now;
  if(diff>0){const h=Math.floor(diff/36e5),m=Math.floor((diff%36e5)/6e4),s=Math.floor((diff%6e4)/1e3);el.textContent='DECAY¬∑'+lbl+'¬∑NEXT '+(h>0?h+'h'+m+'m':m+'m'+s+'s');}
  else el.textContent='DECAY¬∑'+lbl;
}

// ‚îÄ‚îÄ DECAY SETTINGS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.saveDecay=async function(){
  const amount=parseFloat(document.getElementById('decay-amount').value);
  const unit=document.getElementById('decay-unit').value;
  if(!amount||amount<=0){showMsg('decay-msg','Enter a valid period.',true);return;}
  try{
    await setDoc(doc(db,'config','decay'),{amount,unit});
    showMsg('decay-msg',`Decay set to every ${amount} ${unit}.`);
    updateDecayInfo();
  }catch(e){showMsg('decay-msg','Error: '+e.message,true);}
};

function playerStateFromHistory(allMatchesBefore, pid) {
  let rating=1500, rd=120, wins=0, losses=0, lastMatchAt=null;
  for(const m of allMatchesBefore){
    if(m.p1id===pid){rating=m.p1newRating;rd=m.p1newRD;wins++;lastMatchAt=m.date?.toDate?m.date.toDate().getTime():new Date(m.date).getTime();}
    else if(m.p2id===pid){rating=m.p2newRating;rd=m.p2newRD;losses++;lastMatchAt=m.date?.toDate?m.date.toDate().getTime():new Date(m.date).getTime();}
  }
  return{rating,rd,wins,losses,lastMatchAt};
}

function applyDecayToPlayer(p, nowMs, periodMs){
  if(!p.lastMatchAt||periodMs<=0)return;
  const periods=Math.floor((nowMs-p.lastMatchAt)/periodMs);
  if(periods<=0)return;
  let phi=p.rd/173.7178;
  const phiMax=RD_MAX/173.7178;
  for(let i=0;i<periods;i++){phi=Math.sqrt(phi*phi+SIGMA*SIGMA);if(phi>=phiMax){phi=phiMax;break;}}
  p.rd=Math.round(Math.min(phi*173.7178,RD_MAX)*10)/10;
}

// ‚îÄ‚îÄ GLICKO-2 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const toG2=(r,rd)=>({mu:(r-1500)/173.7178,phi:rd/173.7178});
const frG2=(mu,phi)=>({r:mu*173.7178+1500,rd:phi*173.7178});
const gFn=phi=>1/Math.sqrt(1+3*phi*phi/(Math.PI*Math.PI));
const eFn=(mu,mj,pj)=>1/(1+Math.exp(-gFn(pj)*(mu-mj)));
function g2Update(player,opps){
  const{mu,phi}=toG2(player.rating,player.rd);
  if(!opps.length)return{rating:player.rating,rd:Math.min(RD_MAX,Math.sqrt(phi*phi+SIGMA*SIGMA)*173.7178)};
  let vI=0,ds=0;
  for(const o of opps){const{mu:mj,phi:pj}=toG2(o.rating,o.rd),gj=gFn(pj),ej=eFn(mu,mj,pj);vI+=gj*gj*ej*(1-ej);ds+=gj*(o.s-ej);}
  const v=1/vI,ps=Math.sqrt(phi*phi+SIGMA*SIGMA),pn=1/Math.sqrt(1/(ps*ps)+1/v),mn=mu+pn*pn*ds;
  const r=frG2(mn,pn);return{rating:Math.round(r.r*10)/10,rd:Math.round(r.rd*10)/10};
}

// ‚îÄ‚îÄ LEADERBOARD ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderLeaderboard(){
  const sorted=[...players].sort((a,b)=>b.rating-a.rating);
  document.getElementById('lb-loading').style.display='none';
  if(!sorted.length){document.getElementById('lb-table').style.display='none';document.getElementById('lb-empty').style.display='block';return;}
  document.getElementById('lb-empty').style.display='none';document.getElementById('lb-table').style.display='table';
  const vis=sorted.filter(p=>p.rd<=100);
  let lbQ=document.getElementById('lb-quote');
  if(!lbQ){lbQ=document.createElement('div');lbQ.id='lb-quote';lbQ.className='lb-quote';document.getElementById('panel-leaderboard').insertBefore(lbQ,document.getElementById('lb-loading'));}
  const top=vis[0];
  if(top?.quote){lbQ.innerHTML=`"${esc(top.quote)}" <span class="qa">‚Äî ${esc(top.name)}</span>`;lbQ.style.display='block';}else lbQ.style.display='none';
  if(!vis.length){document.getElementById('lb-table').style.display='none';let hn=document.getElementById('lb-hidden-note');if(!hn){hn=document.createElement('div');hn.id='lb-hidden-note';hn.className='empty';document.getElementById('panel-leaderboard').appendChild(hn);}hn.style.display='block';hn.textContent=sorted.length+' player(s) exist but all have RD>100. Play more games!';return;}
  const hn=document.getElementById('lb-hidden-note');if(hn)hn.style.display='none';
  document.getElementById('lb-body').innerHTML=vis.map((p,i)=>{
    const rc=i===0?'top1':i===1?'top2':i===2?'top3':'';
    const av=p.photoURL?`<img class="lb-avatar" src="${esc(p.photoURL)}" alt="">`:`<div class="lb-av-ph">${esc(p.name.charAt(0).toUpperCase())}</div>`;
    const seasons=p.seasons||[];
    const lastS=seasons.length?seasons[seasons.length-1]:null;
    const sBadge=lastS?(()=>{const rk=lastS.rank,cls=rk===1?'rank1':rk===2?'rank2':rk===3?'rank3':'rankN',emoji=rk===1?'ü•á':rk===2?'ü•à':rk===3?'ü•â':'';return`<span class="s-badge ${cls}" title="Last season: ${esc(lastS.seasonName||'Season '+lastS.seasonNum)}" style="font-size:.6rem;padding:.12rem .35rem">${emoji}${emoji?'':('#'+rk)}</span>`})():'';
    const no1Since=p.no1Since||null;
    const no1Tag=i===0?`<span class="no1-timer" data-since="${no1Since||Date.now()}" style="font-family:'DM Mono',monospace;font-size:.55rem;color:var(--accent3);margin-left:.35rem;letter-spacing:.03em">üëë ‚Äî</span>`:'';
    return`<tr onclick="window.openProfile('${p.firestoreId}')"><td class="rank ${rc}">${i+1}</td><td><div class="pname-cell">${av}<span class="player-name">${esc(p.name)}</span>${sBadge}${no1Tag}</div></td><td><span class="rating-val">${Math.round(p.rating)}</span></td><td><span class="rd-val">¬±${Math.round(p.rd)}</span></td><td><span class="record-badge"><span class="w">${p.wins}W</span><span class="l">${p.losses}L</span></span></td></tr>`;
  }).join('')+(sorted.length>vis.length?`<tr><td colspan="5" style="font-family:'DM Mono',monospace;font-size:.58rem;color:var(--muted);padding:.55rem .7rem;text-align:center">${sorted.length-vis.length} hidden (RD>100)</td></tr>`:'');
}

// ‚îÄ‚îÄ PLAYERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.addPlayer=async function(){
  const name=document.getElementById('player-name').value.trim();
  if(!name){showMsg('player-msg','Name required.',true);return;}
  if(players.find(p=>p.name.toLowerCase()===name.toLowerCase())){showMsg('player-msg','Already exists.',true);return;}
  const btn=document.getElementById('add-player-btn');btn.disabled=true;
  try{await addDoc(collection(db,'players'),{name,rating:1500,rd:120,wins:0,losses:0,lastDecayAt:Date.now(),createdAt:serverTimestamp()});document.getElementById('player-name').value='';showMsg('player-msg',name+' added!');}
  catch(e){showMsg('player-msg','Error: '+e.message,true);}finally{btn.disabled=false;}
};

function makeCard(p){
  const wr=(p.wins+p.losses)>0?Math.round(p.wins/(p.wins+p.losses)*100):0;
  const wc=wr>=60?'var(--win)':wr>=40?'var(--text)':'var(--loss)';
  const rdH=p.rd>100,rdC=rdH?'var(--loss)':p.rd>80?'var(--accent)':'var(--win)';
  const{ls,la}=pStats(p.firestoreId),sc=ls>=5?'var(--win)':ls>=3?'var(--accent)':'var(--text)';
  const av=p.photoURL?`<img class="pc-avatar" src="${esc(p.photoURL)}" alt="">`:`<div class="pc-av-ph">${esc(p.name.charAt(0).toUpperCase())}</div>`;
  const seasons=p.seasons||[];
  let badgesHtml='',histHtml='';
  if(seasons.length){
    badgesHtml=`<div class="season-badges">`+seasons.slice().reverse().slice(0,4).map(s=>{
      const rk=s.rank,cls=rk===1?'rank1':rk===2?'rank2':rk===3?'rank3':'rankN';
      const emoji=rk===1?'ü•á':rk===2?'ü•à':rk===3?'ü•â':'';
      return`<span class="s-badge ${cls}" title="${esc(s.seasonName||'Season')}">${emoji}${emoji?'':('#'+rk)} ${esc(s.seasonName||('S'+s.seasonNum))}</span>`;
    }).join('')+`</div>`;
    const opts=seasons.slice().reverse().map((s,i)=>`<option value="${i}">${esc(s.seasonName||('Season '+s.seasonNum))} ‚Äî #${s.rank}</option>`).join('');
    histHtml=`<div class="s-history-wrap">
      <select class="s-history-select" onchange="showSeasonData(this,'s-data-${p.firestoreId}')" onclick="event.stopPropagation()">
        <option value="">üìã Previous seasons‚Ä¶</option>${opts}
      </select>
      <div class="s-history-data" id="s-data-${p.firestoreId}" style="display:none"></div>
    </div>`;
  }
  return`<div class="player-card" onclick="window.openProfile('${p.firestoreId}')">
    <div class="pc-header">${av}<div class="pc-name-block"><div class="pc-name">${esc(p.name)}</div>${rdH?'<span class="pc-tag">HIDDEN</span>':''}</div></div>
    ${badgesHtml}
    <div class="pc-stats">
      <div class="pc-stat"><span class="pc-stat-l">Rating</span><span class="pc-stat-v" style="color:var(--accent)">${Math.round(p.rating)}</span></div>
      <div class="pc-stat"><span class="pc-stat-l">RD</span><span class="pc-stat-v" style="color:${rdC}">¬±${Math.round(p.rd)}</span></div>
      <div class="pc-stat"><span class="pc-stat-l">Record</span><span class="pc-stat-v">${p.wins}W‚Äì${p.losses}L</span></div>
      <div class="pc-stat"><span class="pc-stat-l">Win%</span><span class="pc-stat-v" style="color:${wc}">${wr}%</span></div>
      <div class="pc-stat"><span class="pc-stat-l">Streak</span><span class="pc-stat-v" style="color:${sc}">${ls>0?ls+'W':'‚Äî'}</span></div>
      <div class="pc-stat"><span class="pc-stat-l">Longest #1</span><span class="pc-stat-v" style="color:var(--accent3);font-size:.95rem">${(()=>{const vis=[...players].filter(x=>x.rd<=100).sort((a,b)=>b.rating-a.rating);const isTop=vis[0]?.firestoreId===p.firestoreId;const since=p.no1Since||null;return isTop?`<span class="no1-timer" data-since="${since||Date.now()}">üëë ‚Äî</span>`:fmtDur(p.longestNo1Ms||la);})()}</span></div>
    </div>
    <div class="pc-foot"><span class="pc-hint">TAP TO VIEW PROFILE</span></div>
    ${histHtml}
  </div>`;
}
function renderPlayersList(){
  const sorted=[...players].sort((a,b)=>b.rating-a.rating);
  const html=sorted.length?`<div class="cards-label">ALL PLAYERS (${sorted.length})</div><div class="cards-grid">${sorted.map(makeCard).join('')}</div>`:'<div class="empty">No players yet.</div>';
  const mob=document.getElementById('players-list-mobile'),des=document.getElementById('players-list-desktop');
  if(mob)mob.innerHTML=html;if(des)des.innerHTML=html;
}

// ‚îÄ‚îÄ SEASON HISTORY DROPDOWN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.showSeasonData=function(sel,dataId){
  const el=document.getElementById(dataId);if(!el)return;
  if(!sel.value){el.style.display='none';return;}
  const idx=parseInt(sel.value);
  const pid=dataId.replace('s-data-','');
  const p=players.find(x=>x.firestoreId===pid);
  if(!p||!p.seasons){el.style.display='none';return;}
  const seasons=p.seasons.slice().reverse();
  const s=seasons[idx];if(!s){el.style.display='none';return;}
  const rk=s.rank,emoji=rk===1?'ü•á ':rk===2?'ü•à ':rk===3?'ü•â ':'';
  const ended=s.endedAt?new Date(s.endedAt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'‚Äî';
  el.style.display='block';
  el.innerHTML=`<strong>${emoji}${esc(s.seasonName||('Season '+s.seasonNum))}</strong><br>
    Final Rank: <strong style="color:${rk===1?'var(--accent)':rk===2?'#c0c0c0':rk===3?'#cd7f32':'var(--text)'}">#${rk}</strong><br>
    Final Rating: <strong style="color:var(--accent)">${Math.round(s.rating)}</strong> ¬±${Math.round(s.rd)}<br>
    Record: <strong>${s.wins}W ‚Äì ${s.losses}L</strong><br>
    Season ended: ${ended}`;
};

function pStats(fid){
  const ids=new Set(players.map(x=>x.firestoreId));
  const pm=[...matches].filter(m=>ids.has(m.p1id)&&ids.has(m.p2id)&&(m.p1id===fid||m.p2id===fid)).sort((a,b)=>toTs(a)-toTs(b));
  let ls=0,cs=0;pm.forEach(m=>{const w=m.p1id===fid?m.score===1:m.score===0;w?(cs++,ls=Math.max(ls,cs)):cs=0;});
  let la=0;
  const all=[...matches].filter(m=>ids.has(m.p1id)&&ids.has(m.p2id)).sort((a,b)=>toTs(a)-toTs(b));
  if(all.length&&players.length>=2){
    // Track both rating and RD per player so we can check leaderboard eligibility (RD<=100)
    const rs={},rds={};
    players.forEach(p=>{rs[p.firestoreId]=1500;rds[p.firestoreId]=350;}); // 350=unranked default before first match
    // Seed everyone at baseline before any matches ‚Äî replay will build up correct values
    // Don't seed from p1newRD of first match as those stored values may be stale
    const seen=new Set();
    all.forEach(m=>{
      if(!seen.has(m.p1id)){rs[m.p1id]=m.p1oldRating;seen.add(m.p1id);}
      if(!seen.has(m.p2id)){rs[m.p2id]=m.p2oldRating;seen.add(m.p2id);}
    });
    const periodMs=decayMs();
    // Returns the #1 ranked player among those with RD<=100, or null if nobody qualifies
    const top=()=>{
      let best=null,bestR=-Infinity;
      for(const[id,r] of Object.entries(rs)){if(rds[id]<=100&&r>bestR){bestR=r;best=id;}}
      return best;
    };
    let a1=null,lastTs=null;
    all.forEach(m=>{
      const ts=toTs(m);
      // Before applying this match's results, check if RD decay since last match
      // pushed anyone off the leaderboard ‚Äî if that knocked fid off #1, end streak
      if(lastTs!==null&&periodMs>0){
        const periods=Math.floor((ts-lastTs)/periodMs);
        if(periods>0){
          // Check if fid was #1 before decay
          const wasFidTop=top()===fid;
          // Apply decay to all players
          for(const id of Object.keys(rds)){
            let phi=rds[id]/173.7178;
            const phiMax=RD_MAX/173.7178;
            for(let i=0;i<periods;i++){phi=Math.sqrt(phi*phi+SIGMA*SIGMA);if(phi>=phiMax){phi=phiMax;break;}}
            rds[id]=Math.min(phi*173.7178,RD_MAX);
          }
          // If fid was #1 and decay knocked it off leaderboard, end streak at decay point
          if(wasFidTop&&top()!==fid){
            if(a1!==null){la=Math.max(la,lastTs+periods*periodMs-a1);a1=null;}
          }
        }
      }
      const pt=top();
      rs[m.p1id]=m.p1newRating;rs[m.p2id]=m.p2newRating;
      // Use stored newRD from match, falling back to current player doc RD as ground truth
      const p1LiveRd=players.find(x=>x.firestoreId===m.p1id)?.rd;
      const p2LiveRd=players.find(x=>x.firestoreId===m.p2id)?.rd;
      rds[m.p1id]=m.p1newRD??p1LiveRd??rds[m.p1id];
      rds[m.p2id]=m.p2newRD??p2LiveRd??rds[m.p2id];
      const nt=top();
      if(pt===fid&&nt!==fid){if(a1!==null){la=Math.max(la,ts-a1);a1=null;}}
      else if(pt!==fid&&nt===fid)a1=ts;
      lastTs=ts;
    });
    // If still #1 now (with current live RD after live decay)
    // Use the live player doc RD as the definitive current value (post-repair)
    const livePlayer=players.find(x=>x.firestoreId===fid);
    const liveRd=livePlayer?.rd??rds[fid];
    if(top()===fid&&liveRd<=100&&a1!==null)la=Math.max(la,Date.now()-a1);
    else if(a1!==null){la=Math.max(la,0);} // streak ended (RD decay or displaced), don't extend
  }
  return{ls,la};
}
function toTs(m){return m.date?.toDate?m.date.toDate().getTime():new Date(m.date).getTime();}
function fmtDur(ms){if(ms<=0)return'‚Äî';const d=Math.floor(ms/864e5),h=Math.floor((ms%864e5)/36e5);if(d>0)return d+'d '+h+'h';const m2=Math.floor((ms%36e5)/6e4);if(h>0)return h+'h '+m2+'m';return m2+'m';}
function tickNo1Timers(){
  const now=Date.now();
  document.querySelectorAll('.no1-timer[data-since]').forEach(el=>{
    const since=parseInt(el.dataset.since);
    if(!since)return;
    el.textContent='üëë '+fmtDur(now-since);
  });
}
setInterval(tickNo1Timers,1000);

// ‚îÄ‚îÄ SEASON LOGIC ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let seasonConfig={name:'',deadline:null,seasonNum:1};

onSnapshot(doc(db,'config','season'),snap=>{
  if(snap.exists()){
    const d=snap.data();
    seasonConfig={name:d.name||'',deadline:d.deadline||null,seasonNum:d.seasonNum||1};
  }
  updateSeasonCountdown();
  if(isAdmin)populateSeasonAdmin();
});
setInterval(updateSeasonCountdown,1000);

function updateSeasonCountdown(){
  const el=document.getElementById('season-countdown');
  if(!el||!seasonConfig.deadline){lockMatchForm(false);return el&&(el.style.display='none');}
  const now=Date.now(),dl=new Date(seasonConfig.deadline).getTime(),diff=dl-now;
  if(diff<=0){
    el.textContent='SEASON ENDED';el.style.display='';el.className='';
    el.style.cssText='font-size:.55rem;color:var(--loss);font-family:\'DM Mono\',monospace;letter-spacing:.07em;white-space:nowrap;border:1px solid rgba(217,83,79,.4);padding:.25rem .5rem;';
    lockMatchForm(true);
    return;
  }
  lockMatchForm(false);
  el.style.display='';
  const days=Math.floor(diff/864e5),hrs=Math.floor((diff%864e5)/36e5),mins=Math.floor((diff%36e5)/6e4),secs=Math.floor((diff%6e4)/1e3);
  const urgent=diff<86400000;
  el.className=urgent?'urgent':'';
  const label=seasonConfig.name?`${seasonConfig.name} ¬∑ `:'';
  if(days>0)el.textContent=label+'ENDS '+days+'d '+hrs+'h';
  else el.textContent=label+'ENDS '+hrs+'h '+mins+'m '+secs+'s';
}

function populateSeasonAdmin(){
  const nameEl=document.getElementById('season-name-input'),dlEl=document.getElementById('season-deadline-input');
  if(nameEl&&seasonConfig.name)nameEl.value=seasonConfig.name;
  if(dlEl&&seasonConfig.deadline){
    try{const d=new Date(seasonConfig.deadline);const local=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16);dlEl.value=local;}catch(e){}
  }
  const sa=document.getElementById('season-status-admin');
  if(sa){
    if(seasonConfig.deadline){
      const dl=new Date(seasonConfig.deadline),now=Date.now(),diff=dl.getTime()-now;
      sa.style.display='block';
      sa.innerHTML=diff>0?`Current season: <strong style="color:var(--admin)">${esc(seasonConfig.name||'Unnamed')}</strong><br>Ends: <strong>${dl.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'})}</strong>`:`Season <strong style="color:var(--loss)">${esc(seasonConfig.name||'Unnamed')}</strong> has ended. Ready to reset!`;
    }else sa.style.display='none';
  }
}

window.saveSeason=async function(){
  const name=document.getElementById('season-name-input').value.trim();
  const dlRaw=document.getElementById('season-deadline-input').value;
  if(!dlRaw){showMsg('season-msg','Set a deadline date.',true);return;}
  const deadline=new Date(dlRaw).toISOString();
  try{
    await setDoc(doc(db,'config','season'),{name:name||'Season',deadline,seasonNum:seasonConfig.seasonNum||1});
    showMsg('season-msg','Season saved!');
  }catch(e){showMsg('season-msg','Error: '+e.message,true);}
};

window.triggerSeasonReset=async function(){
  if(!confirm(`This will:\n1. Save each player's rank, stats & full match history for this season\n2. Reset ALL ratings to 1500, RD to 120, wins/losses to 0\n3. Clear all matches from the active log\n\nSeason: "${seasonConfig.name||'Current'}"\n\nThis cannot be undone. Continue?`))return;
  const btn=document.getElementById('reset-season-btn');btn.disabled=true;btn.textContent='Archiving‚Ä¶';
  try{
    const sNum=seasonConfig.seasonNum||1;
    const sName=seasonConfig.name||('Season '+sNum);
    const endedAt=new Date().toISOString();

    const ranked=[...players].filter(p=>p.rd<=100).sort((a,b)=>b.rating-a.rating);
    const rankMap={};ranked.forEach((p,i)=>rankMap[p.firestoreId]=i+1);
    players.forEach(p=>{if(!rankMap[p.firestoreId])rankMap[p.firestoreId]=ranked.length+1;});

    const matchesSnap=await getDocs(query(collection(db,'matches'),orderBy('date','asc')));
    const allMatches=matchesSnap.docs.map(d=>({firestoreId:d.id,...d.data()}));

    function computeSeasonStats(pid){
      const pm=allMatches.filter(m=>m.p1id===pid||m.p2id===pid);
      let ls=0,cs=0;
      pm.forEach(m=>{const w=m.winnerId===pid;w?(cs++,ls=Math.max(ls,cs)):cs=0;});
      let la=0;
      if(allMatches.length&&players.length>=2){
        // Track both rating and RD ‚Äî only RD<=100 players count for #1
        const rs={},rds={};
        players.forEach(p=>{rs[p.firestoreId]=1500;rds[p.firestoreId]=350;});
        const seen=new Set();
        allMatches.forEach(m=>{
          if(!seen.has(m.p1id)){rs[m.p1id]=m.p1oldRating;rds[m.p1id]=m.p1newRD??120;seen.add(m.p1id);}
          if(!seen.has(m.p2id)){rs[m.p2id]=m.p2oldRating;rds[m.p2id]=m.p2newRD??120;seen.add(m.p2id);}
        });
        const periodMs=decayMs();
        const top=()=>{
          let best=null,bestR=-Infinity;
          for(const[id,r] of Object.entries(rs)){if(rds[id]<=100&&r>bestR){bestR=r;best=id;}}
          return best;
        };
        let a1=null,lastTs=null;
        allMatches.forEach(m=>{
          const ts=m.date?.toDate?m.date.toDate().getTime():new Date(m.date).getTime();
          // Apply RD decay between matches ‚Äî if it knocks pid off leaderboard, end streak
          if(lastTs!==null&&periodMs>0){
            const periods=Math.floor((ts-lastTs)/periodMs);
            if(periods>0){
              const wasPidTop=top()===pid;
              for(const id of Object.keys(rds)){
                let phi=rds[id]/173.7178;
                const phiMax=RD_MAX/173.7178;
                for(let i=0;i<periods;i++){phi=Math.sqrt(phi*phi+SIGMA*SIGMA);if(phi>=phiMax){phi=phiMax;break;}}
                rds[id]=Math.min(phi*173.7178,RD_MAX);
              }
              if(wasPidTop&&top()!==pid){
                if(a1!==null){la=Math.max(la,lastTs+periods*periodMs-a1);a1=null;}
              }
            }
          }
          const pt=top();
          rs[m.p1id]=m.p1newRating;rs[m.p2id]=m.p2newRating;
          rds[m.p1id]=m.p1newRD??rds[m.p1id];rds[m.p2id]=m.p2newRD??rds[m.p2id];
          const nt=top();
          if(pt===pid&&nt!==pid){if(a1!==null){la=Math.max(la,ts-a1);a1=null;}}
          else if(pt!==pid&&nt===pid)a1=ts;
          lastTs=ts;
        });
        const endTs=endedAt?new Date(endedAt).getTime():Date.now();
        if(top()===pid&&rds[pid]<=100&&a1!==null)la=Math.max(la,endTs-a1);
      }
      const sorted=pm.slice().sort((a,b)=>(a.date?.toDate?a.date.toDate():new Date(a.date))-(b.date?.toDate?b.date.toDate():new Date(b.date)));
      const chartPts=[];
      if(sorted.length){
        chartPts.push({rating:sorted[0].p1id===pid?sorted[0].p1oldRating:sorted[0].p2oldRating,label:'Start'});
        sorted.forEach(m=>{
          const i1=m.p1id===pid;
          const ts=m.date?.toDate?m.date.toDate():new Date(m.date);
          chartPts.push({rating:i1?m.p1newRating:m.p2newRating,won:m.winnerId===pid,label:i1?m.p2name:m.p1name,date:ts.toISOString()});
        });
      }
      return{ls,la,chartPts};
    }

    await Promise.all(players.map(async p=>{
      const pid=p.firestoreId;
      const{ls,la,chartPts}=computeSeasonStats(pid);
      const myMatches=allMatches
        .filter(m=>m.p1id===pid||m.p2id===pid)
        .map(m=>({
          opponent:m.p1id===pid?m.p2name:m.p1name,
          won:m.winnerId===pid,
          matchScore:m.matchScore||null,
          delta:m.p1id===pid?m.p1delta:m.p2delta,
          oldRating:m.p1id===pid?m.p1oldRating:m.p2oldRating,
          newRating:m.p1id===pid?m.p1newRating:m.p2newRating,
          date:m.date?.toDate?m.date.toDate().toISOString():new Date(m.date).toISOString(),
        }));
      await setDoc(doc(db,'players',pid,'seasonMatches',String(sNum)),{
        seasonNum:sNum,seasonName:sName,endedAt,
        matches:myMatches,
        chartPts,
        longestWinStreak:ls,
        longestNo1Ms:la,
      });
      const existing=p.seasons||[];
      const entry={seasonNum:sNum,seasonName:sName,rank:rankMap[pid],rating:p.rating,rd:p.rd,wins:p.wins,losses:p.losses,endedAt,longestWinStreak:ls,longestNo1Ms:la};
      return updateDoc(doc(db,'players',pid),{
        rating:1500,rd:120,wins:0,losses:0,lastDecayAt:Date.now(),
        seasons:[...existing,entry]
      });
    }));

    await Promise.all(matchesSnap.docs.map(d=>deleteDoc(doc(db,'matches',d.id))));
    await setDoc(doc(db,'config','season'),{name:'',deadline:null,seasonNum:sNum+1});
    showMsg('season-msg',`Season "${sName}" archived with full match history! All stats reset.`);
  }catch(e){showMsg('season-msg','Error: '+e.message,true);}
  finally{btn.disabled=false;btn.textContent='‚ö° Reset Season Now';}
};

// ‚îÄ‚îÄ MATCH LOCK ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function lockMatchForm(locked){
  const btn=document.getElementById('submit-match-btn');
  const panel=document.getElementById('panel-match');
  if(!btn||!panel)return;
  btn.disabled=locked;
  let notice=document.getElementById('match-lock-notice');
  if(locked){
    if(!notice){
      notice=document.createElement('div');
      notice.id='match-lock-notice';
      notice.style.cssText='font-family:\'DM Mono\',monospace;font-size:.68rem;color:var(--loss);border:1px solid rgba(217,83,79,.3);background:rgba(217,83,79,.07);padding:.75rem 1rem;margin-bottom:1rem;letter-spacing:.04em;';
      notice.textContent='‚ö† Season has ended. Match submission is locked until the admin resets the season.';
      panel.querySelector('.form-card').prepend(notice);
    }
  } else {
    if(notice)notice.remove();
  }
}

// ‚îÄ‚îÄ SUBMIT MATCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.submitMatch=async function(){
  if(seasonConfig.deadline){
    const diff=new Date(seasonConfig.deadline).getTime()-Date.now();
    if(diff<=0){showMsg('match-msg','Season has ended. No matches can be submitted until the admin resets the season.',true);return;}
  }
  const wid=document.getElementById('match-winner').value,lid=document.getElementById('match-loser').value;
  if(wid===lid){showMsg('match-msg','Select two different players.',true);return;}
  const btn=document.getElementById('submit-match-btn');btn.disabled=true;showMsg('match-msg','Submitting‚Ä¶');
  try{await runTransaction(db,async tx=>{
    const[ws,ls]=await Promise.all([tx.get(doc(db,'players',wid)),tx.get(doc(db,'players',lid))]);
    if(!ws.exists()||!ls.exists())throw new Error('Player not found');
    const w=ws.data(),l=ls.data();
    const uw=g2Update(w,[{rating:l.rating,rd:l.rd,s:1}]),ul=g2Update(l,[{rating:w.rating,rd:w.rd,s:0}]);
    const now=Date.now();
    // Determine current #1 before and after this match
    const allSnap=await getDocs(query(collection(db,'players')));
    const allP=allSnap.docs.map(d=>({id:d.id,...d.data()}));
    const ranked=p=>p.rd<=100;
    const topBefore=allP.filter(ranked).sort((a,b)=>b.rating-a.rating)[0];
    // Simulate post-match ratings to find new #1
    const simP=allP.map(p=>{
      if(p.id===wid)return{...p,rating:uw.rating,rd:uw.rd};
      if(p.id===lid)return{...p,rating:ul.rating,rd:ul.rd};
      return p;
    });
    const topAfter=simP.filter(ranked).sort((a,b)=>b.rating-a.rating)[0];
    const wUpdate={rating:uw.rating,rd:uw.rd,wins:w.wins+1};
    const lUpdate={rating:ul.rating,rd:ul.rd,losses:l.losses+1};
    // If #1 changed, finalize old #1 streak and start new one
    if(topBefore?.id!==topAfter?.id){
      if(topBefore){
        const oldTop=allP.find(p=>p.id===topBefore.id);
        if(oldTop?.no1Since){
          const dur=now-(oldTop.no1Since||now);
          const prev=oldTop.longestNo1Ms||0;
          const upd={no1Since:null};
          if(dur>prev)upd.longestNo1Ms=dur;
          if(oldTop.id===wid)Object.assign(wUpdate,upd);
          else if(oldTop.id===lid)Object.assign(lUpdate,upd);
          else await tx.update(doc(db,'players',oldTop.id),upd);
        }
      }
      if(topAfter){
        const newTopData=allP.find(p=>p.id===topAfter.id);
        const no1Since=newTopData?.no1Since||now;
        if(topAfter.id===wid)wUpdate.no1Since=no1Since;
        else if(topAfter.id===lid)lUpdate.no1Since=no1Since;
        else await tx.update(doc(db,'players',topAfter.id),{no1Since});
      }
    }
    tx.update(doc(db,'players',wid),wUpdate);
    tx.update(doc(db,'players',lid),lUpdate);
    const sc=document.getElementById('match-score').value.trim();
    tx.set(doc(collection(db,'matches')),{winnerId:wid,loserId:lid,winnerName:w.name,loserName:l.name,p1id:wid,p2id:lid,p1name:w.name,p2name:l.name,score:1,matchScore:sc||null,p1delta:Math.round((uw.rating-w.rating)*10)/10,p2delta:Math.round((ul.rating-l.rating)*10)/10,p1newRD:uw.rd,p2newRD:ul.rd,p1oldRating:w.rating,p1newRating:uw.rating,p2oldRating:l.rating,p2newRating:ul.rating,date:serverTimestamp()});
  });document.getElementById('match-score').value='';const wn=players.find(p=>p.firestoreId===wid);showMsg('match-msg',(wn?.name||'Winner')+' wins!');}
  catch(e){showMsg('match-msg','Error: '+e.message,true);}finally{btn.disabled=false;}
};
function renderMatchSelects(){
  const opts=players.map(p=>`<option value="${p.firestoreId}">${esc(p.name)} (${Math.round(p.rating)})</option>`).join('');
  document.getElementById('match-winner').innerHTML=opts||'<option disabled>No players yet</option>';
  document.getElementById('match-loser').innerHTML=opts||'<option disabled>No players yet</option>';
}

// ‚îÄ‚îÄ HISTORY ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderHistoryFilter(){
  const sel=document.getElementById('history-filter'),cur=sel.value;
  sel.innerHTML='<option value="all">All Players</option>'+players.map(p=>`<option value="${p.firestoreId}">${esc(p.name)}</option>`).join('');
  sel.value=players.find(p=>p.firestoreId===cur)?cur:'all';
}
window.renderHistory=function(){
  renderHistoryFilter();const flt=document.getElementById('history-filter').value,el=document.getElementById('history-list');
  const ids=new Set(players.map(p=>p.firestoreId));
  let ms=matches.filter(m=>ids.has(m.p1id)&&ids.has(m.p2id));if(flt!=='all')ms=ms.filter(m=>m.p1id===flt||m.p2id===flt);
  if(!ms.length){el.innerHTML='<div class="empty">No matches yet.</div>';return;}
  el.innerHTML=ms.map(m=>{
    const ts=m.date?.toDate?m.date.toDate():new Date(m.date);
    const ds=ts.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}),ti=ts.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
    const d1=(m.p1delta>=0?'+':'')+m.p1delta,d2=(m.p2delta>=0?'+':'')+m.p2delta;
    return`<div class="match-row">
      <div class="match-player"><span class="name">${esc(m.p1name)}</span><span class="delta ${m.p1delta>=0?'pos':'neg'}">${d1} (${Math.round(m.p1oldRating)}‚Üí${Math.round(m.p1newRating)})</span><span class="rdi">RD:¬±${Math.round(m.p1newRD)}</span></div>
      <div class="match-mid"><div class="match-result"><span class="ws">WIN</span>${m.matchScore?`<span class="match-score-lbl">${esc(m.matchScore)}</span>`:'<span style="font-size:.8rem;color:var(--muted)">vs</span>'}<span class="ls">LOSS</span></div><div class="match-date-lbl">${ds} ${ti}</div></div>
      <div class="match-player" style="text-align:right"><span class="name">${esc(m.p2name)}</span><span class="delta ${m.p2delta>=0?'pos':'neg'}">${d2} (${Math.round(m.p2oldRating)}‚Üí${Math.round(m.p2newRating)})</span><span class="rdi">RD:¬±${Math.round(m.p2newRD)}</span></div>
      <div class="match-meta-col">${ds}<br>${ti}${m.matchScore?'<br>'+esc(m.matchScore):''}</div>
    </div>`;
  }).join('');
};

// ‚îÄ‚îÄ ADMIN PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function renderAdminPanel(){
  if(!isAdmin)return;
  populateSeasonAdmin();
  updateDecayInfo();
  const sorted=[...players].sort((a,b)=>b.rating-a.rating);
  const pl=document.getElementById('admin-players-list');
  if(pl)pl.innerHTML=sorted.length?sorted.map(p=>`<div class="admin-prow"><span class="admin-pname">${esc(p.name)}</span><span class="admin-prating">${Math.round(p.rating)} ¬±${Math.round(p.rd)}</span><button class="btn-admin" onclick="openEditPlayer('${p.firestoreId}')">Edit Stats</button><button class="btn-danger" onclick="adminRemovePlayer('${p.firestoreId}','${esc(p.name)}')">Remove</button></div>`).join(''):'<div class="empty">No players.</div>';
  const ml=document.getElementById('admin-matches-list');
  if(ml)ml.innerHTML=matches.length?matches.slice(0,60).map(m=>{
    const ts=m.date?.toDate?m.date.toDate():new Date(m.date);
    return`<div class="admin-mrow"><div class="admin-minfo"><strong>${esc(m.p1name)} beat ${esc(m.p2name)}</strong>${m.matchScore?' ¬∑ '+esc(m.matchScore):''}<br>${ts.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}</div><button class="btn-danger" onclick="adminRemoveMatch('${m.firestoreId}')">Delete</button></div>`;
  }).join(''):'<div class="empty">No matches.</div>';
}

window.adminRemovePlayer=async function(fid,name){
  if(!confirm(`Remove "${name}"? Match history remains.`))return;
  try{await deleteDoc(doc(db,'players',fid));}catch(e){alert('Error: '+e.message);}
};

window.adminRemoveMatch=async function(fid){
  if(!confirm('Delete this match and recalculate all affected ratings?'))return;
  try{
    const matchesSnap=await getDocs(query(collection(db,'matches'),orderBy('date','asc')));
    const allMatches=matchesSnap.docs.map(d=>({firestoreId:d.id,...d.data()}));
    const deletedIdx=allMatches.findIndex(m=>m.firestoreId===fid);
    if(deletedIdx===-1){alert('Match not found.');return;}
    const deletedMatch=allMatches[deletedIdx];
    await deleteDoc(doc(db,'matches',fid));
    const matchesBefore=allMatches.slice(0,deletedIdx);
    const matchesAfter=allMatches.slice(deletedIdx+1);

    // Only the two players in the deleted match are directly affected.
    // We replay ONLY their matches in matchesAfter ‚Äî all other players and matches are untouched.
    const pid1=deletedMatch.p1id, pid2=deletedMatch.p2id;

    // Reconstruct each affected player's state from stored match history up to (not including) deleted match
    const s1=playerStateFromHistory(matchesBefore,pid1);
    const s2=playerStateFromHistory(matchesBefore,pid2);

    if(matchesAfter.length===0){
      // Nothing after ‚Äî just rewind both players
      await Promise.all([
        updateDoc(doc(db,'players',pid1),{rating:s1.rating,rd:s1.rd,wins:s1.wins,losses:s1.losses,lastDecayAt:s1.lastMatchAt||Date.now()}),
        updateDoc(doc(db,'players',pid2),{rating:s2.rating,rd:s2.rd,wins:s2.wins,losses:s2.losses,lastDecayAt:s2.lastMatchAt||Date.now()}),
      ]);
      alert('Match deleted. Ratings rewound to previous state.');
      return;
    }

    // Build a state map for just the two affected players
    const periodMs=decayMs();
    const pmap={
      [pid1]:{...s1,firestoreId:pid1},
      [pid2]:{...s2,firestoreId:pid2},
    };

    // Walk matchesAfter in chronological order.
    // - Matches involving pid1 or pid2: recalculate and rewrite.
    // - Matches between two other players: read stored opponent ratings/RDs so we know
    //   what pid1/pid2's opponent was rated at that moment (use stored values ‚Äî those
    //   players were unaffected so their stored match data is still correct).
    const matchUpdates=[];
    const playerUpdates={};

    for(const m of matchesAfter){
      const involvesP1=m.p1id===pid1||m.p2id===pid1;
      const involvesP2=m.p1id===pid2||m.p2id===pid2;
      if(!involvesP1&&!involvesP2)continue; // unrelated match ‚Äî skip entirely

      const ts=m.date?.toDate?m.date.toDate().getTime():new Date(m.date).getTime();
      const isWinner1=m.p1id===pid1||m.p1id===pid2; // whichever of our two is p1 (p1 is always winner)
      const ourId=involvesP1?pid1:pid2;
      const oppId=isWinner1?m.p2id:m.p1id;
      const ourState=pmap[ourId];

      // Apply decay to our player since their last match
      applyDecayToPlayer(ourState,ts,periodMs);

      // Opponent's rating/RD: use stored pre-match values from the match record itself
      // (they are unaffected, so their stored data is the ground truth)
      const oppRating=isWinner1?m.p2oldRating:m.p1oldRating;
      const oppRD=isWinner1?(m.p2newRD??120):(m.p1newRD??120); // their RD at that match (stored)

      // Determine if our player won this match
      const ourPlayerWon=(m.p1id===ourId); // p1 is always winner in stored data

      const newState=g2Update(ourState,[{rating:oppRating,rd:oppRD,s:ourPlayerWon?1:0}]);
      const oldRating=ourState.rating;
      const delta=Math.round((newState.rating-oldRating)*10)/10;

      // Update in-memory state
      pmap[ourId].rating=newState.rating;
      pmap[ourId].rd=newState.rd;
      if(ourPlayerWon)pmap[ourId].wins=(pmap[ourId].wins||0)+1;
      else pmap[ourId].losses=(pmap[ourId].losses||0)+1;
      pmap[ourId].lastMatchAt=ts;

      // Rewrite just the fields for our player in this match document
      if(m.p1id===ourId){
        matchUpdates.push(updateDoc(doc(db,'matches',m.firestoreId),{
          p1delta:delta,p1oldRating:oldRating,p1newRating:newState.rating,p1newRD:newState.rd
        }));
      } else {
        matchUpdates.push(updateDoc(doc(db,'matches',m.firestoreId),{
          p2delta:delta,p2oldRating:oldRating,p2newRating:newState.rating,p2newRD:newState.rd
        }));
      }
      playerUpdates[ourId]=pmap[ourId];
    }

    // Write final player states for only the two affected players
    const writes=Object.values(playerUpdates).map(p=>
      updateDoc(doc(db,'players',p.firestoreId),{
        rating:p.rating,rd:p.rd,wins:p.wins||0,losses:p.losses||0,lastDecayAt:p.lastMatchAt||Date.now()
      })
    );
    // If one of the two players had no matches after either, still rewind them
    if(!playerUpdates[pid1])writes.push(updateDoc(doc(db,'players',pid1),{rating:s1.rating,rd:s1.rd,wins:s1.wins,losses:s1.losses,lastDecayAt:s1.lastMatchAt||Date.now()}));
    if(!playerUpdates[pid2])writes.push(updateDoc(doc(db,'players',pid2),{rating:s2.rating,rd:s2.rd,wins:s2.wins,losses:s2.losses,lastDecayAt:s2.lastMatchAt||Date.now()}));

    await Promise.all([...writes,...matchUpdates]);
    alert('Match deleted and ratings recalculated from that point forward.');
  }catch(e){alert('Error: '+e.message);console.error(e);}
};

// ‚îÄ‚îÄ REPAIR RATINGS FAILSAFE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Derives each player's true rating+RD purely from their last stored match record
// (which always has correct p1newRating/p1newRD/p2newRating/p2newRD), then applies
// decay since that match. Never uses the player doc's current rating/rd as input.
window.repairAllRatings=async function(){
  if(!confirm('Recalculate all ratings and RDs from match history? This will fix any incorrectly reset values.'))return;
  const btn=document.querySelector('[onclick="repairAllRatings()"]');
  if(btn){btn.disabled=true;btn.textContent='Repairing‚Ä¶';}
  try{
    // Fetch all matches in chronological order
    const matchesSnap=await getDocs(query(collection(db,'matches'),orderBy('date','asc')));
    const allMatches=matchesSnap.docs.map(d=>({firestoreId:d.id,...d.data()}));

    // For each player, find their last match and read the stored post-match rating+RD directly
    // The stored p1newRating/p1newRD etc. are always correct ‚Äî they come from the Glicko-2
    // calculation at match submission time and are never modified by decay code.
    const lastMatchState={}; // pid -> {rating, rd, lastMatchAt, wins, losses}
    for(const m of allMatches){
      const ts=m.date?.toDate?m.date.toDate().getTime():new Date(m.date).getTime();
      if(!lastMatchState[m.p1id]){lastMatchState[m.p1id]={rating:1500,rd:120,wins:0,losses:0,lastMatchAt:null};}
      if(!lastMatchState[m.p2id]){lastMatchState[m.p2id]={rating:1500,rd:120,wins:0,losses:0,lastMatchAt:null};}
      lastMatchState[m.p1id].rating=m.p1newRating;
      lastMatchState[m.p1id].rd=m.p1newRD;
      lastMatchState[m.p1id].wins=(lastMatchState[m.p1id].wins||0)+1;
      lastMatchState[m.p1id].lastMatchAt=ts;
      lastMatchState[m.p2id].rating=m.p2newRating;
      lastMatchState[m.p2id].rd=m.p2newRD;
      lastMatchState[m.p2id].losses=(lastMatchState[m.p2id].losses||0)+1;
      lastMatchState[m.p2id].lastMatchAt=ts;
    }

    const now=Date.now();
    const periodMs=decayMs();
    const updates=[];

    for(const p of players){
      const state=lastMatchState[p.firestoreId];
      if(!state){
        // Player has never played ‚Äî their current stored values are correct, skip
        continue;
      }
      // Apply decay since last match using the correct post-match RD as baseline
      let rd=state.rd;
      if(state.lastMatchAt&&periodMs>0){
        const periods=Math.floor((now-state.lastMatchAt)/periodMs);
        if(periods>0){
          let phi=rd/173.7178;
          const phiMax=RD_MAX/173.7178;
          for(let i=0;i<periods;i++){phi=Math.sqrt(phi*phi+SIGMA*SIGMA);if(phi>=phiMax){phi=phiMax;break;}}
          rd=Math.round(Math.min(phi*173.7178,RD_MAX)*10)/10;
        }
      }
      updates.push(updateDoc(doc(db,'players',p.firestoreId),{
        rating:state.rating,
        rd:rd,
        wins:state.wins,
        losses:state.losses,
        lastDecayAt:state.lastMatchAt||now,
      }));
    }

    // Also recalculate longestNo1Ms and no1Since for each player from match history
    // Replay all matches in order tracking who was #1 with RD<=100
    const repairRs={},repairRds={};
    players.forEach(p=>{repairRs[p.firestoreId]=1500;repairRds[p.firestoreId]=350;});
    // Seed from first appearance
    const repairSeen=new Set();
    for(const m of allMatches){
      if(!repairSeen.has(m.p1id)){repairRs[m.p1id]=m.p1oldRating;repairRds[m.p1id]=m.p1newRD??120;repairSeen.add(m.p1id);}
      if(!repairSeen.has(m.p2id)){repairRs[m.p2id]=m.p2oldRating;repairRds[m.p2id]=m.p2newRD??120;repairSeen.add(m.p2id);}
    }
    const repairTop=()=>{let best=null,bestR=-Infinity;for(const[id,r] of Object.entries(repairRs)){if(repairRds[id]<=100&&r>bestR){bestR=r;best=id;}}return best;};
    const no1Starts={},longestNo1={};
    let lastRepairTs=null;
    const repairPeriodMs=decayMs();
    // Seed initial #1 from very first match
    if(allMatches.length){
      const firstTs=allMatches[0].date?.toDate?allMatches[0].date.toDate().getTime():new Date(allMatches[0].date).getTime();
      const initialTop=repairTop();
      if(initialTop)no1Starts[initialTop]=firstTs;
    }
    for(const m of allMatches){
      const ts=m.date?.toDate?m.date.toDate().getTime():new Date(m.date).getTime();
      // Apply decay between matches
      if(lastRepairTs!==null&&repairPeriodMs>0){
        const periods=Math.floor((ts-lastRepairTs)/repairPeriodMs);
        if(periods>0){
          const wasTop=repairTop();
          for(const id of Object.keys(repairRds)){
            let phi=repairRds[id]/173.7178;const phiMax=RD_MAX/173.7178;
            for(let i=0;i<periods;i++){phi=Math.sqrt(phi*phi+SIGMA*SIGMA);if(phi>=phiMax){phi=phiMax;break;}}
            repairRds[id]=Math.min(phi*173.7178,RD_MAX);
          }
          const nowTop=repairTop();
          if(wasTop!==nowTop){
            if(wasTop&&no1Starts[wasTop]!=null){const dur=lastRepairTs+periods*repairPeriodMs-no1Starts[wasTop];longestNo1[wasTop]=Math.max(longestNo1[wasTop]||0,dur);delete no1Starts[wasTop];}
            if(nowTop&&no1Starts[nowTop]==null)no1Starts[nowTop]=lastRepairTs+periods*repairPeriodMs;
          }
        }
      }
      const pt=repairTop();
      repairRs[m.p1id]=m.p1newRating;repairRs[m.p2id]=m.p2newRating;
      repairRds[m.p1id]=m.p1newRD??repairRds[m.p1id];repairRds[m.p2id]=m.p2newRD??repairRds[m.p2id];
      const nt=repairTop();
      if(pt!==nt){
        if(pt&&no1Starts[pt]!=null){const dur=ts-no1Starts[pt];longestNo1[pt]=Math.max(longestNo1[pt]||0,dur);delete no1Starts[pt];}
        if(nt&&no1Starts[nt]==null)no1Starts[nt]=ts;
      }
      lastRepairTs=ts;
    }
    // Finalize anyone still #1 now
    const currentTop=repairTop();
    for(const[pid,since] of Object.entries(no1Starts)){
      if(pid!==currentTop){
        const dur=now-(since||now);longestNo1[pid]=Math.max(longestNo1[pid]||0,dur);
        delete no1Starts[pid];
      }
      // current #1 stays in no1Starts with their continuous streak start time
    }
    // Add no1Since and longestNo1Ms to the updates ‚Äî always write for every player
    for(const p of players){
      const isCurrentTop=p.firestoreId===currentTop&&repairRds[p.firestoreId]<=100;
      const no1Since=isCurrentTop?(no1Starts[p.firestoreId]||now):null;
      const longestMs=longestNo1[p.firestoreId]||0;
      updates.push(updateDoc(doc(db,'players',p.firestoreId),{
        no1Since:no1Since,
        ...(longestMs>0?{longestNo1Ms:longestMs}:{})
      }));
    }

    await Promise.all(updates);
    showMsg('repair-msg',`Repaired ${updates.length} player(s) from match history.`);
  }catch(e){
    showMsg('repair-msg','Error: '+e.message,true);
  }finally{
    if(btn){btn.disabled=false;btn.textContent='üîß Repair All Ratings From Match History';}
  }
};

window.openEditPlayer=function(fid){
  const p=players.find(x=>x.firestoreId===fid);if(!p)return;
  document.getElementById('edit-pid').value=fid;
  document.getElementById('edit-rating').value=Math.round(p.rating);
  document.getElementById('edit-rd').value=Math.round(p.rd);
  document.getElementById('edit-wins').value=p.wins;
  document.getElementById('edit-losses').value=p.losses;
  document.getElementById('edit-player-msg').style.display='none';
  document.getElementById('admin-edit-overlay').classList.add('open');
};
window.submitEditPlayer=async function(){
  const fid=document.getElementById('edit-pid').value,rating=parseFloat(document.getElementById('edit-rating').value),rd=parseFloat(document.getElementById('edit-rd').value),wins=parseInt(document.getElementById('edit-wins').value),losses=parseInt(document.getElementById('edit-losses').value);
  if([rating,rd,wins,losses].some(isNaN)){showMsg('edit-player-msg','Invalid values.',true);return;}
  try{await updateDoc(doc(db,'players',fid),{rating,rd,wins,losses});showMsg('edit-player-msg','Saved!');setTimeout(()=>document.getElementById('admin-edit-overlay').classList.remove('open'),1200);}
  catch(e){showMsg('edit-player-msg','Error: '+e.message,true);}
};

// ‚îÄ‚îÄ PROFILE PICTURE ‚Äî CROP & RESIZE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
const MAX_FILE_MB=5;
const OUT_SIZE=400;
let cropState={file:null,imgW:0,imgH:0,scale:1,minScale:1,ox:0,oy:0};

document.getElementById('m-av-input').addEventListener('change',function(e){
  const file=e.target.files[0];
  this.value='';
  if(!file)return;
  if(!file.type.startsWith('image/')){showUploadErr('Only image files are supported.');return;}
  if(file.size>MAX_FILE_MB*1024*1024){showUploadErr(`File too large (max ${MAX_FILE_MB}MB).`);return;}
  openCropModal(file);
});

function showUploadErr(msg){
  const prog=document.getElementById('upload-prog');
  prog.style.display='block';prog.style.color='var(--loss)';prog.textContent='‚ö† '+msg;
  setTimeout(()=>{prog.style.display='none';prog.style.color='';},4000);
}

function openCropModal(file){
  cropState.file=file;
  const url=URL.createObjectURL(file);
  const img=document.getElementById('crop-img');
  img.onload=()=>{
    cropState.imgW=img.naturalWidth;cropState.imgH=img.naturalHeight;
    const vp=240;
    const minS=Math.max(vp/cropState.imgW,vp/cropState.imgH);
    cropState.minScale=minS;cropState.scale=minS;
    cropState.ox=(vp-cropState.imgW*minS)/2;cropState.oy=(vp-cropState.imgH*minS)/2;
    applyCropTransform();
    document.getElementById('crop-zoom').min=minS;document.getElementById('crop-zoom').max=minS*4;
    document.getElementById('crop-zoom').step=minS*0.005;document.getElementById('crop-zoom').value=minS;
    document.getElementById('crop-msg').style.display='none';document.getElementById('crop-confirm-btn').disabled=false;
  };
  img.src=url;
  document.getElementById('crop-overlay').classList.add('open');
}

window.closeCropModal=function(){
  document.getElementById('crop-overlay').classList.remove('open');
  const img=document.getElementById('crop-img');
  if(img.src.startsWith('blob:'))URL.revokeObjectURL(img.src);
};

function applyCropTransform(){
  const img=document.getElementById('crop-img');
  img.style.width=cropState.imgW+'px';img.style.height=cropState.imgH+'px';
  img.style.transform=`translate(${cropState.ox}px,${cropState.oy}px) scale(${cropState.scale})`;
}

function clampOffsets(){
  const vp=240,s=cropState.scale,iw=cropState.imgW,ih=cropState.imgH;
  const minX=vp-iw*s,minY=vp-ih*s;
  cropState.ox=Math.min(0,Math.max(minX,cropState.ox));
  cropState.oy=Math.min(0,Math.max(minY,cropState.oy));
}

document.getElementById('crop-zoom').addEventListener('input',function(){
  const newS=parseFloat(this.value),vp=240;
  const cx=vp/2,cy=vp/2;
  const imgCx=(cx-cropState.ox)/cropState.scale,imgCy=(cy-cropState.oy)/cropState.scale;
  cropState.scale=newS;cropState.ox=cx-imgCx*newS;cropState.oy=cy-imgCy*newS;
  clampOffsets();applyCropTransform();
});

(function(){
  const vp=document.getElementById('crop-viewport');
  let dragging=false,startX,startY,startOx,startOy;
  vp.addEventListener('mousedown',e=>{dragging=true;startX=e.clientX;startY=e.clientY;startOx=cropState.ox;startOy=cropState.oy;vp.style.cursor='grabbing';e.preventDefault();});
  window.addEventListener('mousemove',e=>{if(!dragging)return;cropState.ox=startOx+(e.clientX-startX);cropState.oy=startOy+(e.clientY-startY);clampOffsets();applyCropTransform();});
  window.addEventListener('mouseup',()=>{dragging=false;vp.style.cursor='grab';});
  let lastTouches=null;
  vp.addEventListener('touchstart',e=>{lastTouches=e.touches;if(e.touches.length===1){startX=e.touches[0].clientX;startY=e.touches[0].clientY;startOx=cropState.ox;startOy=cropState.oy;}e.preventDefault();},{passive:false});
  vp.addEventListener('touchmove',e=>{
    if(e.touches.length===1&&lastTouches?.length===1){cropState.ox=startOx+(e.touches[0].clientX-startX);cropState.oy=startOy+(e.touches[0].clientY-startY);clampOffsets();applyCropTransform();}
    else if(e.touches.length===2&&lastTouches?.length===2){
      const d0=Math.hypot(lastTouches[0].clientX-lastTouches[1].clientX,lastTouches[0].clientY-lastTouches[1].clientY);
      const d1=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY);
      const factor=d1/d0;
      const newS=Math.min(Math.max(cropState.scale*factor,cropState.minScale),cropState.minScale*4);
      const vp2=240,cx=(e.touches[0].clientX+e.touches[1].clientX)/2,cy=(e.touches[0].clientY+e.touches[1].clientY)/2;
      const rect=document.getElementById('crop-viewport').getBoundingClientRect();
      const lcx=cx-rect.left,lcy=cy-rect.top;
      const imgCx=(lcx-cropState.ox)/cropState.scale,imgCy=(lcy-cropState.oy)/cropState.scale;
      cropState.scale=newS;cropState.ox=lcx-imgCx*newS;cropState.oy=lcy-imgCy*newS;clampOffsets();applyCropTransform();
      document.getElementById('crop-zoom').value=newS;
    }
    lastTouches=e.touches;e.preventDefault();
  },{passive:false});
  vp.addEventListener('wheel',e=>{
    e.preventDefault();
    const factor=e.deltaY<0?1.08:0.93;
    const newS=Math.min(Math.max(cropState.scale*factor,cropState.minScale),cropState.minScale*4);
    const rect=vp.getBoundingClientRect();
    const lcx=e.clientX-rect.left,lcy=e.clientY-rect.top;
    const imgCx=(lcx-cropState.ox)/cropState.scale,imgCy=(lcy-cropState.oy)/cropState.scale;
    cropState.scale=newS;cropState.ox=lcx-imgCx*newS;cropState.oy=lcy-imgCy*newS;clampOffsets();applyCropTransform();
    document.getElementById('crop-zoom').value=newS;
  },{passive:false});
})();

window.confirmCrop=async function(){
  const btn=document.getElementById('crop-confirm-btn');
  btn.disabled=true;btn.textContent='Processing‚Ä¶';
  try{
    const img=document.getElementById('crop-img');
    const vp=240;
    const canvas=document.createElement('canvas');
    canvas.width=OUT_SIZE;canvas.height=OUT_SIZE;
    const ctx=canvas.getContext('2d');
    const srcX=-cropState.ox/cropState.scale;
    const srcY=-cropState.oy/cropState.scale;
    const srcW=vp/cropState.scale;
    const srcH=vp/cropState.scale;
    ctx.drawImage(img,srcX,srcY,srcW,srcH,0,0,OUT_SIZE,OUT_SIZE);
    const base64=canvas.toDataURL('image/jpeg',0.82);
    closeCropModal();
    if(!curProfileId)return;
    const prog=document.getElementById('upload-prog');
    prog.style.color='';prog.style.display='block';prog.textContent='Saving‚Ä¶';
    await updateDoc(doc(db,'players',curProfileId),{photoURL:base64});
    prog.textContent='Photo updated!';
    const wrap=document.getElementById('m-av-wrap'),uploadBtn=wrap.querySelector('.m-av-upload');
    let avImg=wrap.querySelector('.m-avatar');
    if(!avImg){avImg=document.createElement('img');avImg.className='m-avatar';const ph=wrap.querySelector('.m-av-ph');if(ph)ph.replaceWith(avImg);else wrap.insertBefore(avImg,uploadBtn);}
    avImg.src=base64;
    setTimeout(()=>{prog.style.display='none';},2500);
    btn.disabled=false;btn.textContent='Use Photo';
  }catch(err){
    console.error(err);
    document.getElementById('crop-msg').textContent='Error: '+err.message;
    document.getElementById('crop-msg').className='msg err';
    document.getElementById('crop-msg').style.display='block';
    btn.disabled=false;btn.textContent='Use Photo';
  }
};

// ‚îÄ‚îÄ PROFILE MODAL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
window.openProfile=async function(fid){
  const p=players.find(x=>x.firestoreId===fid);if(!p)return;curProfileId=fid;
  const wrap=document.getElementById('m-av-wrap'),uploadBtn=wrap.querySelector('.m-av-upload');
  const old=wrap.querySelector('.m-avatar,.m-av-ph');if(old)old.remove();
  if(p.photoURL){const img=document.createElement('img');img.className='m-avatar';img.src=p.photoURL;wrap.insertBefore(img,uploadBtn);}
  else{const ph=document.createElement('div');ph.className='m-av-ph';ph.textContent=p.name.charAt(0).toUpperCase();wrap.insertBefore(ph,uploadBtn);}
  document.getElementById('profile-name').textContent=p.name;
  document.getElementById('quote-input-modal').value=p.quote||'';
  document.getElementById('quote-msg-modal').style.display='none';
  document.getElementById('upload-prog').style.display='none';
  document.getElementById('m-av-input').value='';
  const qEl=document.getElementById('profile-quote');
  if(p.quote){qEl.innerHTML=`"${esc(p.quote)}" <span class="qa">‚Äî ${esc(p.name)}</span>`;qEl.style.display='block';}else qEl.style.display='none';
  const wr=(p.wins+p.losses)>0?Math.round(p.wins/(p.wins+p.losses)*100):0,wc=wr>=60?'green':wr>=40?'neutral':'red';
  const{ls,la}=pStats(fid);
  document.getElementById('profile-stats').innerHTML=`
    <div class="m-stat"><span class="m-stat-l">Rating</span><span class="m-stat-v">${Math.round(p.rating)}</span></div>
    <div class="m-stat"><span class="m-stat-l">RD</span><span class="m-stat-v neutral">¬±${Math.round(p.rd)}</span></div>
    <div class="m-stat"><span class="m-stat-l">Record</span><span class="m-stat-v neutral">${p.wins}W‚Äì${p.losses}L</span></div>
    <div class="m-stat"><span class="m-stat-l">Win%</span><span class="m-stat-v ${wc}">${wr}%</span></div>
    <div class="m-stat"><span class="m-stat-l">Streak</span><span class="m-stat-v ${ls>=5?'green':ls>=3?'':'neutral'}">${ls>0?ls+'W':'‚Äî'}</span></div>
    <div class="m-stat"><span class="m-stat-l">Longest #1</span><span class="m-stat-v" style="color:var(--accent3);font-size:1rem">${(()=>{const vis=[...players].filter(x=>x.rd<=100).sort((a,b)=>b.rating-a.rating);const isTop=vis[0]?.firestoreId===fid;const since=p.no1Since||null;return isTop?`<span class="no1-timer counting" data-since="${since||Date.now()}">üëë ‚Äî</span>`:fmtDur(p.longestNo1Ms||la);})()}</span></div>`;

  const ids=new Set(players.map(x=>x.firestoreId));
  const pm=[...matches].filter(m=>ids.has(m.p1id)&&ids.has(m.p2id)&&(m.p1id===fid||m.p2id===fid)).sort((a,b)=>toTs(a)-toTs(b));
  const start=pm.length>0?(pm[0].p1id===fid?pm[0].p1oldRating:pm[0].p2oldRating):p.rating;
  const pts=[{rating:start,label:'Start'}];
  pm.forEach(m=>{const i1=m.p1id===fid,ts=m.date?.toDate?m.date.toDate():new Date(m.date);pts.push({rating:i1?m.p1newRating:m.p2newRating,won:m.winnerId===fid,label:i1?m.p2name:m.p1name,date:ts.toISOString()});});
  drawChart(pts);

  function renderCurrentMatches(){
    return pm.length?[...pm].reverse().map(m=>{
      const i1=m.p1id===fid,won=i1?m.score===1:m.score===0,opp=i1?m.p2name:m.p1name,delta=i1?m.p1delta:m.p2delta,oldR=i1?m.p1oldRating:m.p2oldRating,newR=i1?m.p1newRating:m.p2newRating;
      const ts=m.date?.toDate?m.date.toDate():new Date(m.date),ds=ts.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}),ti=ts.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}),df=(delta>=0?'+':'')+delta;
      return`<div class="pm-row"><span class="pm-badge ${won?'win':'loss'}">${won?'WIN':'LOSS'}</span><div class="pm-info"><span class="pm-opp">vs ${esc(opp)}${m.matchScore?' <span style="font-family:\'DM Mono\',monospace;font-size:.58rem;color:var(--muted)">'+esc(m.matchScore)+'</span>':''}</span><span class="pm-date">${ds} ¬∑ ${ti}</span></div><span class="pm-delta ${delta>=0?'pos':'neg'}">${df}<br><span style="font-size:.6rem;color:var(--muted)">${Math.round(oldR)}‚Üí${Math.round(newR)}</span></span></div>`;
    }).join(''):'<div class="empty">No matches this season yet.</div>';
  }

  const seasons=p.seasons||[];
  let seasonSelectorHtml='';
  if(seasons.length){
    const opts=seasons.slice().reverse().map(s=>{
      const emoji=s.rank===1?'ü•á':s.rank===2?'ü•à':s.rank===3?'ü•â':'';
      return`<option value="${s.seasonNum}">${emoji}${esc(s.seasonName||('Season '+s.seasonNum))} ‚Äî #${s.rank}</option>`;
    }).join('');
    seasonSelectorHtml=`<div style="display:flex;align-items:center;gap:.65rem;margin-bottom:.75rem;flex-wrap:wrap">
      <div class="chart-lbl" style="margin:0">Match History</div>
      <select id="profile-season-sel" style="width:auto;flex:1;min-width:160px;font-size:.68rem;padding:.35rem .65rem" onchange="loadProfileSeason('${fid}',this.value)">
        <option value="current">üìÖ Current Season</option>
        ${opts}
      </select>
    </div>`;
  } else {
    seasonSelectorHtml=`<div class="chart-lbl" style="margin-bottom:.65rem">Match History</div>`;
  }

  document.getElementById('profile-matches').innerHTML=`${seasonSelectorHtml}<div id="profile-matches-list">${renderCurrentMatches()}</div>`;
  document.getElementById('profile-overlay').classList.add('open');
};

window.loadProfileSeason=async function(fid,val){
  const el=document.getElementById('profile-matches-list');
  if(val==='current'){
    const ids=new Set(players.map(x=>x.firestoreId));
    const pm=[...matches].filter(m=>ids.has(m.p1id)&&ids.has(m.p2id)&&(m.p1id===fid||m.p2id===fid)).sort((a,b)=>toTs(a)-toTs(b));
    const p=players.find(x=>x.firestoreId===fid);
    const start=pm.length>0?(pm[0].p1id===fid?pm[0].p1oldRating:pm[0].p2oldRating):(p?.rating||1500);
    const pts=[{rating:start,label:'Start'}];
    pm.forEach(m=>{const i1=m.p1id===fid,ts=m.date?.toDate?m.date.toDate():new Date(m.date);pts.push({rating:i1?m.p1newRating:m.p2newRating,won:m.winnerId===fid,label:i1?m.p2name:m.p1name,date:ts.toISOString()});});
    drawChart(pts);
    const sorted=[...pm].reverse();
    el.innerHTML=sorted.length?sorted.map(m=>{
      const i1=m.p1id===fid,won=i1?m.score===1:m.score===0,opp=i1?m.p2name:m.p1name,delta=i1?m.p1delta:m.p2delta,oldR=i1?m.p1oldRating:m.p2oldRating,newR=i1?m.p1newRating:m.p2newRating;
      const ts=m.date?.toDate?m.date.toDate():new Date(m.date),ds=ts.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}),df=(delta>=0?'+':'')+delta;
      return`<div class="pm-row"><span class="pm-badge ${won?'win':'loss'}">${won?'WIN':'LOSS'}</span><div class="pm-info"><span class="pm-opp">vs ${esc(opp)}${m.matchScore?' <span style="font-family:\'DM Mono\',monospace;font-size:.58rem;color:var(--muted)">'+esc(m.matchScore)+'</span>':''}</span><span class="pm-date">${ds}</span></div><span class="pm-delta ${delta>=0?'pos':'neg'}">${df}<br><span style="font-size:.6rem;color:var(--muted)">${Math.round(oldR)}‚Üí${Math.round(newR)}</span></span></div>`;
    }).join(''):'<div class="empty">No matches this season yet.</div>';
    return;
  }
  el.innerHTML='<div class="loading" style="padding:1.5rem">Loading</div>';
  try{
    const snap=await getDocs(collection(db,'players',fid,'seasonMatches'));
    const archiveDoc=snap.docs.find(d=>d.id===String(val));
    if(!archiveDoc){el.innerHTML='<div class="empty">No match data saved for this season.</div>';return;}
    const data=archiveDoc.data();
    const ms=data.matches||[];
    if(data.chartPts&&data.chartPts.length){drawChart(data.chartPts);}else{drawChart([]);}
    const p=players.find(x=>x.firestoreId===fid);
    const sEntry=(p?.seasons||[]).find(s=>s.seasonNum===parseInt(val));
    let headerHtml='';
    if(sEntry){
      const emoji=sEntry.rank===1?'ü•á':sEntry.rank===2?'ü•à':sEntry.rank===3?'ü•â':'';
      const ended=sEntry.endedAt?new Date(sEntry.endedAt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'';
      const streakHtml=sEntry.longestWinStreak>0?` ¬∑ Best streak <strong style="color:var(--win)">${sEntry.longestWinStreak}W</strong>`:'';
      const no1Html=sEntry.longestNo1Ms>0?` ¬∑ Longest #1 <strong style="color:var(--accent3)">${fmtDur(sEntry.longestNo1Ms)}</strong>`:'';
      headerHtml=`<div style="font-family:'DM Mono',monospace;font-size:.62rem;color:var(--muted);padding:.55rem .75rem;background:rgba(0,0,0,.2);border:1px solid var(--border);margin-bottom:.65rem;line-height:1.8">
        ${emoji} <strong style="color:var(--text)">${esc(sEntry.seasonName||'Season '+sEntry.seasonNum)}</strong> ¬∑ Final rank <strong style="color:var(--accent)">#${sEntry.rank}</strong> ¬∑ ${sEntry.wins}W‚Äì${sEntry.losses}L ¬∑ Rating <strong style="color:var(--accent)">${Math.round(sEntry.rating)}</strong>${streakHtml}${no1Html}${ended?' ¬∑ Ended '+ended:''}
      </div>`;
    }
    if(!ms.length){el.innerHTML=headerHtml+'<div class="empty">No matches recorded for this season.</div>';return;}
    const sorted=[...ms].sort((a,b)=>new Date(b.date)-new Date(a.date));
    el.innerHTML=headerHtml+sorted.map(m=>{
      const ds=new Date(m.date).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'});
      const df=(m.delta>=0?'+':'')+m.delta;
      return`<div class="pm-row"><span class="pm-badge ${m.won?'win':'loss'}">${m.won?'WIN':'LOSS'}</span><div class="pm-info"><span class="pm-opp">vs ${esc(m.opponent)}${m.matchScore?' <span style="font-family:\'DM Mono\',monospace;font-size:.58rem;color:var(--muted)">'+esc(m.matchScore)+'</span>':''}</span><span class="pm-date">${ds}</span></div><span class="pm-delta ${m.delta>=0?'pos':'neg'}">${df}<br><span style="font-size:.6rem;color:var(--muted)">${Math.round(m.oldRating)}‚Üí${Math.round(m.newRating)}</span></span></div>`;
    }).join('');
  }catch(e){el.innerHTML=`<div class="empty">Error loading: ${esc(e.message)}</div>`;}
};

window.saveQuoteModal=async function(){
  if(!curProfileId)return;const q=document.getElementById('quote-input-modal').value.trim();
  try{await updateDoc(doc(db,'players',curProfileId),{quote:q||null});const p=players.find(x=>x.firestoreId===curProfileId);if(p)p.quote=q||null;
    const qEl=document.getElementById('profile-quote');if(q){qEl.innerHTML=`"${esc(q)}" <span class="qa">‚Äî ${esc(p?.name||'')}</span>`;qEl.style.display='block';}else qEl.style.display='none';
    showMsg('quote-msg-modal',q?'Quote saved!':'Quote cleared.');}
  catch(e){showMsg('quote-msg-modal','Error: '+e.message,true);}
};

window.closeProfile=function(e){if(e.target===document.getElementById('profile-overlay'))document.getElementById('profile-overlay').classList.remove('open');};
document.addEventListener('keydown',e=>{if(e.key==='Escape'){['profile-overlay','admin-login-overlay','admin-edit-overlay','crop-overlay'].forEach(id=>document.getElementById(id).classList.remove('open'));}});

// ‚îÄ‚îÄ CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function drawChart(points){
  const PAD={top:16,right:22,bottom:26,left:46},H=175,MIN_PX=54;
  const outer=document.getElementById('chart-outer'),newOuter=outer.cloneNode(false);
  while(outer.firstChild)newOuter.appendChild(outer.firstChild);outer.parentNode.replaceChild(newOuter,outer);
  const wrap=document.getElementById('chart-wrap'),canvas=document.getElementById('rating-chart'),tip=document.getElementById('chart-tip');
  const W=Math.max(newOuter.clientWidth||580,PAD.left+PAD.right+(points.length>1?(points.length-1)*MIN_PX:200));
  wrap.style.width=W+'px';wrap.style.height=H+'px';canvas.width=W;canvas.height=H;
  const ctx=canvas.getContext('2d'),cW=W-PAD.left-PAD.right,cH=H-PAD.top-PAD.bottom;
  const ratings=points.map(p=>p.rating),minR=Math.min(...ratings),maxR=Math.max(...ratings),range=maxR-minR||50,rPad=range*.18,lo=minR-rPad,hi=maxR+rPad;
  const xOf=i=>PAD.left+(points.length>1?(i/(points.length-1))*cW:cW/2);
  const yOf=r=>PAD.top+(1-(r-lo)/(hi-lo))*cH;
  function redraw(hl){
    ctx.clearRect(0,0,W,H);
    for(let g=0;g<=4;g++){const y=PAD.top+(g/4)*cH;ctx.strokeStyle='rgba(74,42,56,.9)';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(PAD.left,y);ctx.lineTo(W-PAD.right,y);ctx.stroke();ctx.fillStyle='#8a6a78';ctx.font='9px DM Mono,monospace';ctx.textAlign='right';ctx.fillText(Math.round(hi-(g/4)*(hi-lo)),PAD.left-4,y+3);}
    if(points.length<2){ctx.fillStyle='#8a6a78';ctx.font='11px DM Mono,monospace';ctx.textAlign='center';ctx.fillText('Play more matches to see history',W/2,H/2);return;}
    for(let i=1;i<points.length;i++){const pv=points[i-1],cv=points[i],col=cv.won?'#7ec8a0':'#ff4757';ctx.beginPath();ctx.moveTo(xOf(i-1),yOf(pv.rating));ctx.lineTo(xOf(i),yOf(cv.rating));ctx.lineTo(xOf(i),H-PAD.bottom);ctx.lineTo(xOf(i-1),H-PAD.bottom);ctx.closePath();ctx.fillStyle=cv.won?'rgba(126,200,160,.1)':'rgba(217,83,79,.1)';ctx.fill();ctx.beginPath();ctx.moveTo(xOf(i-1),yOf(pv.rating));ctx.lineTo(xOf(i),yOf(cv.rating));ctx.strokeStyle=col;ctx.lineWidth=2;ctx.stroke();}
    for(let i=0;i<points.length;i++){const pt=points[i],col=i===0?'#8a6a78':(pt.won?'#7ec8a0':'#ff4757'),isHl=i===hl;if(isHl){ctx.beginPath();ctx.arc(xOf(i),yOf(pt.rating),8,0,Math.PI*2);ctx.fillStyle=i===0?'rgba(138,106,120,.2)':(pt.won?'rgba(126,200,160,.2)':'rgba(217,83,79,.2)');ctx.fill();}ctx.beginPath();ctx.arc(xOf(i),yOf(pt.rating),isHl?5:3.5,0,Math.PI*2);ctx.fillStyle=col;ctx.fill();if(isHl){ctx.beginPath();ctx.arc(xOf(i),yOf(pt.rating),1.5,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();}}
    if(hl>=0){ctx.beginPath();ctx.moveTo(xOf(hl),PAD.top);ctx.lineTo(xOf(hl),H-PAD.bottom);ctx.strokeStyle='rgba(255,255,255,.07)';ctx.lineWidth=1;ctx.setLineDash([3,4]);ctx.stroke();ctx.setLineDash([]);}
  }
  function showTip(idx){const pt=points[idx],col=idx===0?'#8a6a78':(pt.won?'#7ec8a0':'#ff4757');let html=`<span style="font-family:'Bebas Neue',sans-serif;font-size:1rem;color:${col}">${Math.round(pt.rating)}</span>`;if(idx===0)html+=`<br><span style="color:#8a6a78">Starting rating</span>`;else{const d=new Date(pt.date),ds=pt.rating-points[idx-1].rating,df=(ds>=0?'+':'')+Math.round(ds),dt=d.toLocaleDateString('en-US',{month:'short',day:'numeric'});html+=`<br><span style="color:${col}">${pt.won?'WIN':'LOSS'}</span> vs ${esc(pt.label)}<br><span style="color:${col}">${df} pts</span> ¬∑ ${dt}`;}tip.innerHTML=html;tip.style.display='block';tip.style.left='-9999px';tip.style.top='-9999px';requestAnimationFrame(()=>{const dx=xOf(idx),dy=yOf(pt.rating),tw=tip.offsetWidth,th=tip.offsetHeight;let l=Math.max(PAD.left,Math.min(dx-tw/2,W-PAD.right-tw)),t=dy-th-10;if(t<PAD.top)t=dy+14;tip.style.left=l+'px';tip.style.top=t+'px';});}
  redraw(-1);let hl=-1;
  function near(cx){let b=-1,bd=Infinity;for(let i=0;i<points.length;i++){const d=Math.abs(xOf(i)-cx);if(d<bd){bd=d;b=i;}}return bd<34?b:-1;}
  function onMove(e){const r=canvas.getBoundingClientRect(),cx=(e.touches?e.touches[0].clientX:e.clientX)-r.left,idx=near(cx*(canvas.width/r.width));if(idx!==hl){hl=idx;redraw(idx);if(idx>=0)showTip(idx);else tip.style.display='none';}}
  function onLeave(){hl=-1;redraw(-1);tip.style.display='none';}
  newOuter.addEventListener('mousemove',onMove);newOuter.addEventListener('mouseleave',onLeave);newOuter.addEventListener('touchmove',onMove,{passive:true});newOuter.addEventListener('touchend',onLeave);
}

// ‚îÄ‚îÄ PONG ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let pongRaf=null,pongRunning=false,pongInited=false;
const PONG={
  W:600,H:400,PAD_W:10,PAD_H:70,BALL:8,
  BASE_SPEED:5,
  state:null
};

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// IMPORTANT: showPanel must be defined BEFORE initPong so the pong tab switch works correctly
window.showPanel=function(id,btn){
  document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));
  document.getElementById('panel-'+id).classList.add('active');
  btn.classList.add('active');
  if(id==='players')renderPlayersList();
  if(id==='history')renderHistory();
  if(id==='admin')renderAdminPanel();
  // Stop pong when leaving tab
  if(id!=='pong'&&pongRunning){pongRunning=false;if(pongRaf)cancelAnimationFrame(pongRaf);}
  if(id==='pong')initPong();
};

function initPong(){
  if(pongInited)return;
  pongInited=true;
  const canvas=document.getElementById('pong-canvas');

  // Mouse ‚Äî correct scale: multiply by (logical size / CSS rendered size)
  canvas.addEventListener('mousemove',e=>{
    if(!pongRunning||!PONG.state)return;
    const rect=canvas.getBoundingClientRect();
    // Canvas logical height is PONG.H=400, CSS rendered height is rect.height
    const y=(e.clientY-rect.top)*(PONG.H/rect.height);
    PONG.state.playerY=Math.max(PONG.PAD_H/2,Math.min(PONG.H-PONG.PAD_H/2,y));
  });

  // Touch ‚Äî same corrected scaling
  canvas.addEventListener('touchmove',e=>{
    if(!pongRunning||!PONG.state)return;
    e.preventDefault();
    const rect=canvas.getBoundingClientRect();
    const y=(e.touches[0].clientY-rect.top)*(PONG.H/rect.height);
    PONG.state.playerY=Math.max(PONG.PAD_H/2,Math.min(PONG.H-PONG.PAD_H/2,y));
  },{passive:false});

  // Keyboard ‚Äî track held keys for smooth movement, speed scales with ball speed
  const keysHeld=new Set();
  window.addEventListener('keydown',e=>{
    // Only prevent scroll if pong tab is active
    if(pongRunning&&(e.key==='ArrowUp'||e.key==='ArrowDown'))e.preventDefault();
    keysHeld.add(e.key);
  });
  window.addEventListener('keyup',e=>keysHeld.delete(e.key));

  // Apply keyboard input at ~60fps, independent of rAF loop
  setInterval(()=>{
    if(!pongRunning||!PONG.state)return;
    // Step size scales a bit with speed so you can keep up at high velocities
    const step=Math.max(14,PONG.state.speed*1.6);
    if(keysHeld.has('ArrowUp')||keysHeld.has('w')||keysHeld.has('W'))
      PONG.state.playerY=Math.max(PONG.PAD_H/2,PONG.state.playerY-step);
    if(keysHeld.has('ArrowDown')||keysHeld.has('s')||keysHeld.has('S'))
      PONG.state.playerY=Math.min(PONG.H-PONG.PAD_H/2,PONG.state.playerY+step);
  },16);

  // Click/tap overlay to start
  document.getElementById('pong-overlay').addEventListener('click',()=>{if(!pongRunning)startPong();});
}

function resetBall(dir=1){
  const angle=(Math.random()*60-30)*(Math.PI/180);
  const spd=PONG.state.speed;
  return{
    x:PONG.W/2,y:PONG.H/2,
    vx:Math.cos(angle)*spd*dir,
    vy:Math.sin(angle)*spd
  };
}

window.startPong=function(){
  if(pongRaf)cancelAnimationFrame(pongRaf);
  PONG.state={
    playerY:PONG.H/2,
    cpuY:PONG.H/2,
    scorePlayer:0,scoreCpu:0,
    speed:PONG.BASE_SPEED,
    totalPoints:0,
    flash:0,
  };
  Object.assign(PONG.state,{ball:resetBall(1)});
  document.getElementById('pong-overlay').style.display='none';
  pongRunning=true;
  pongLoop();
};

function pongLoop(){
  const canvas=document.getElementById('pong-canvas');
  const ctx=canvas.getContext('2d');
  const s=PONG.state;
  const{W,H,PAD_W,PAD_H,BALL}=PONG;
  const b=s.ball;

  // CPU AI
  const cpuSpeed=3+s.speed*0.35;
  if(b.x>W*0.5){
    if(s.cpuY<b.y-8)s.cpuY=Math.min(s.cpuY+cpuSpeed,H-PAD_H/2);
    else if(s.cpuY>b.y+8)s.cpuY=Math.max(s.cpuY-cpuSpeed,PAD_H/2);
  }

  // Move ball
  b.x+=b.vx;b.y+=b.vy;

  // Wall bounce
  if(b.y-BALL<0){b.y=BALL;b.vy=Math.abs(b.vy);}
  if(b.y+BALL>H){b.y=H-BALL;b.vy=-Math.abs(b.vy);}

  // Player paddle (left)
  const px=PAD_W+4;
  if(b.vx<0&&b.x-BALL<=px+PAD_W&&b.x+BALL>=px&&b.y>=s.playerY-PAD_H/2&&b.y<=s.playerY+PAD_H/2){
    b.x=px+PAD_W+BALL;
    const rel=(b.y-s.playerY)/(PAD_H/2);
    const angle=rel*65*(Math.PI/180);
    b.vx=Math.cos(angle)*s.speed;
    b.vy=Math.sin(angle)*s.speed;
    s.totalPoints++;s.scorePlayer++;
    s.speed+=0.4;
    s.flash=8;
    if(s.speed>28)s.speed=28;
    updatePongHUD(s);
  }

  // CPU paddle (right)
  const cx=W-PAD_W-4;
  if(b.vx>0&&b.x+BALL>=cx&&b.x-BALL<=cx+PAD_W&&b.y>=s.cpuY-PAD_H/2&&b.y<=s.cpuY+PAD_H/2){
    b.x=cx-BALL;
    const rel=(b.y-s.cpuY)/(PAD_H/2);
    const angle=rel*65*(Math.PI/180);
    b.vx=-Math.cos(angle)*s.speed;
    b.vy=Math.sin(angle)*s.speed;
  }

  // Score
  if(b.x+BALL<0){
    s.scoreCpu++;
    s.speed=Math.max(PONG.BASE_SPEED,s.speed-0.5);
    Object.assign(s,{ball:resetBall(1)});
    updatePongHUD(s);
  }
  if(b.x-BALL>W){
    s.scorePlayer++;s.totalPoints++;s.speed+=0.4;s.flash=8;
    if(s.speed>28)s.speed=28;
    Object.assign(s,{ball:resetBall(-1)});
    updatePongHUD(s);
  }

  // Draw
  ctx.clearRect(0,0,W,H);

  if(s.flash>0){ctx.fillStyle=`rgba(229,178,93,${s.flash*0.012})`;ctx.fillRect(0,0,W,H);s.flash--;}

  ctx.setLineDash([6,8]);ctx.strokeStyle='rgba(74,42,56,.8)';ctx.lineWidth=1;
  ctx.beginPath();ctx.moveTo(W/2,0);ctx.lineTo(W/2,H);ctx.stroke();ctx.setLineDash([]);

  const trailLen=Math.min(8,Math.floor(s.speed/3));
  for(let i=trailLen;i>0;i--){
    const alpha=0.06*(trailLen-i+1)/trailLen;
    ctx.beginPath();ctx.arc(b.x-b.vx*i*0.6,b.y-b.vy*i*0.6,BALL*(0.5+i/trailLen*0.5),0,Math.PI*2);
    ctx.fillStyle=`rgba(229,178,93,${alpha})`;ctx.fill();
  }

  ctx.beginPath();ctx.arc(b.x,b.y,BALL,0,Math.PI*2);
  ctx.fillStyle='#E5B25D';ctx.fill();

  const padR=4;
  roundRect(ctx,px,s.playerY-PAD_H/2,PAD_W,PAD_H,padR,'#E5B25D');
  roundRect(ctx,cx,s.cpuY-PAD_H/2,PAD_W,PAD_H,padR,'#d9534f');

  if(pongRunning)pongRaf=requestAnimationFrame(pongLoop);
}

function roundRect(ctx,x,y,w,h,r,color){
  ctx.beginPath();ctx.roundRect(x,y,w,h,r);ctx.fillStyle=color;ctx.fill();
}

function updatePongHUD(s){
  document.getElementById('pong-score-player').textContent=s.scorePlayer;
  document.getElementById('pong-score-cpu').textContent=s.scoreCpu;
  document.getElementById('pong-speed-display').textContent=(s.speed/PONG.BASE_SPEED).toFixed(1)+'√ó';
}

// ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function showMsg(id,text,isErr=false){const el=document.getElementById(id);el.textContent=text;el.className='msg'+(isErr?' err':'');el.style.display='block';if(!isErr)setTimeout(()=>{el.style.display='none';},3000);}
</script>
</body>
</html>