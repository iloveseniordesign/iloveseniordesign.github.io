<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TTTIW</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9Ii0xIDE1IDY1IDQwIj4KICA8ZyBmaWxsPSIjRTVCMjVEIiB0cmFuc2Zvcm09Im1hdHJpeCgwLjY3NDY1LCAwLCAwLCAwLjY3NDY1LCAwLCAxNykiPgogICAgPHBhdGggZD0iTTAsNTEuMTdsNTkuMjkuMzRMMjkuOTQsMCwwLDUxLjE3Wk0xMC41Nyw0NS4xNkwyOS44NywxMi4xNmwxOC45MiwzMy4yMS0zOC4yMi0uMjJaIi8+CiAgICA8cGF0aCBkPSJNNTYuNDMsNDkuODRsLTUzLjU2LS4zMUwyOS45MiwzLjMxbDI2LjUyLDQ2LjU0Wk00LjYxLDQ4LjU0bDUwLjA5LjI5TDI5LjkxLDUuMzEsNC42MSw0OC41NFpNNTMuMzgsNDguMDZsLTQ3LjQyLS4yN0wyOS45LDYuODVsMjMuNDgsNDEuMlpNNy42OSw0Ni43OWw0My45Ni4yNUwyOS44OSw4Ljg1LDcuNjksNDYuNzlaIi8+CiAgPC9nPgogIDxnPgogICAgPGcgZmlsbD0iI0U1QjI1RCIgdHJhbnNmb3JtPSJtYXRyaXgoMC41MDAyLCAwLCAwLCAwLjUwMDIsIDUuMjQ0MzM3LCAxNi4xNTk2NjIpIiBzdHlsZT0iIj4KICAgICAgPHBhdGggZD0iTTg1LjgzLDEuNjhoLS4yYy0xMy43NSwwLTI0Ljk1LDExLjE3LTI0Ljk5LDI0LjkyLS4wNCwxMy43OCwxMS4xNCwyNS4wMiwyNC45MywyNS4wNmguMmMxMy43NSwwLDI0Ljk1LTExLjE3LDI0Ljk5LTI0LjkyLjA0LTEzLjc4LTExLjE0LTI1LjAyLTI0LjkzLTI1LjA2Wk04Mi40OSw4LjA2bC0uMDksMTUuNDEtMTUuMy0uMDljLjY2LTMuNzksMi40Ni03LjI5LDUuMjMtMTAuMDcsMi44LTIuOCw2LjMzLTQuNiwxMC4xNi01LjI1Wk04Mi4zNiwyOS41NGwtLjA5LDE1LjcxYy0zLjc3LS43LTcuMy0yLjUzLTEwLjAxLTUuMjktMi44Ni0yLjg5LTQuNjUtNi41Ni01LjI0LTEwLjUxbDE1LjM0LjA5Wk04OC4zNSw0NS4zN2wuMDktMTUuNzksMTUuOTEuMDljLTEuMzIsOC4xMi03LjgzLDE0LjU0LTE2LDE1LjdaTTg4LjQ4LDIzLjVsLjA5LTE1LjQ5YzguMDUsMS4yNCwxNC40Myw3LjU3LDE1Ljc3LDE1LjU4bC0xNS44Ni0uMDlaIi8+CiAgICA8L2c+CiAgICA8cmVjdCBzdHlsZT0iZmlsbDogcmdiKDIyOSwgMTc4LCA5Myk7IHRyYW5zZm9ybS1ib3g6IGZpbGwtYm94OyB0cmFuc2Zvcm0tb3JpZ2luOiA1MCUgNTAlOyIgdHJhbnNmb3JtPSJtYXRyaXgoMC44NjYwMjYsIC0wLjUsIDAuNSwgMC44NjYwMjYsIC0xMC4yMDcxODMsIC0xMS44NjcyMjQpIiB4PSI2NC40MDQiIHk9IjQ5LjUxMiIgd2lkdGg9IjUiIGhlaWdodD0iMTQiIHJ4PSIxIiByeT0iMSIvPgogIDwvZz4KICA8cGF0aCBzdHlsZT0iZmlsbDogcmdiKDIyOSwgMTc4LCA5Myk7IiBkPSJNIDQ4LjU4NCA0MS45MzcgQyA1MS41OTUgNDIuMDAzIDUyLjQ4OSA0Mi43MiA1NC4wODkgNDUuMTU3IEwgNTguMzk2IDQyLjUzNCBDIDU3LjI0NyA0MC4wMTEgNTcuMjMzIDM4LjczNiA1OC44NDEgMzUuOTc5IEMgNTUuNzI5IDM3LjI4MiA0OC41NjkgNDEuOTUgNDguNTg0IDQxLjkzNyBaIi8+Cjwvc3ZnPg==">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;600&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #1e1018;
    --surface: #2a1520;
    --border: #4a2a38;
    --accent: #E5B25D;
    --accent2: #c0392b;
    --accent3: #c9a0dc;
    --text: #E1E2EF;
    --muted: #8a6a78;
    --win: #7ec8a0;
    --loss: #d9534f;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }
  body::before {
    content: '';
    position: fixed;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(ellipse at 30% 20%, rgba(229,178,93,0.06) 0%, transparent 50%),
                radial-gradient(ellipse at 70% 80%, rgba(53,30,41,0.8) 0%, transparent 50%);
    pointer-events: none;
    z-index: 0;
  }

  header {
    padding: 2rem 3rem 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: baseline;
    gap: 1.5rem;
    position: relative;
    z-index: 1;
    flex-wrap: wrap;
  }
  header h1 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 3.5rem;
    letter-spacing: 0.08em;
    color: var(--accent);
    line-height: 1;
  }
  header span {
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--muted);
    letter-spacing: 0.15em;
    text-transform: uppercase;
  }

  nav {
    display: flex;
    gap: 0;
    padding: 0 3rem;
    border-bottom: 1px solid var(--border);
    position: relative;
    z-index: 1;
  }
  nav button {
    background: none;
    border: none;
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 1rem 1.5rem;
    cursor: pointer;
    border-bottom: 2px solid transparent;
    transition: all 0.2s;
  }
  nav button.active { color: var(--accent); border-bottom-color: var(--accent); }
  nav button:hover:not(.active) { color: var(--text); }

  main {
    padding: 2rem 3rem;
    position: relative;
    z-index: 1;
    max-width: 1200px;
  }

  .panel { display: none; }
  .panel.active { display: block; }

  /* CONFIG BANNER */
  #config-banner {
    background: rgba(255,71,87,0.08);
    border: 1px solid var(--loss);
    padding: 1.2rem 1.5rem;
    margin-bottom: 1.5rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--loss);
    line-height: 1.7;
  }
  #config-banner strong { color: var(--accent); }

  /* LEADERBOARD */
  .lb-table { width: 100%; border-collapse: collapse; }
  .lb-table th {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
    text-align: left;
    padding: 0.75rem 1rem;
    border-bottom: 1px solid var(--border);
  }
  .lb-table td {
    padding: 1rem;
    border-bottom: 1px solid rgba(74,42,56,0.5);
    vertical-align: middle;
  }
  .lb-table tr:hover td { background: rgba(229,178,93,0.05); }
  .lb-table tbody tr { cursor: pointer; }
  .rank { font-family: 'Bebas Neue', sans-serif; font-size: 1.4rem; color: var(--muted); width: 3rem; }
  .rank.top1 { color: var(--accent); }
  .rank.top2 { color: #c0c0c0; }
  .rank.top3 { color: #cd7f32; }
  .player-name { font-size: 1rem; font-weight: 600; letter-spacing: 0.02em; }
  .rating-val { font-family: 'Bebas Neue', sans-serif; font-size: 1.8rem; color: var(--accent); letter-spacing: 0.05em; }
  .rd-val { font-family: 'DM Mono', monospace; font-size: 0.8rem; color: var(--muted); }
  .record-badge { font-family: 'DM Mono', monospace; font-size: 0.7rem; display: inline-flex; gap: 0.5rem; }
  .record-badge .w { color: var(--win); }
  .record-badge .l { color: var(--loss); }

  /* FORMS */
  .form-card {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 2rem;
    max-width: 500px;
    margin-bottom: 2rem;
  }
  .form-card h2 {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.5rem;
    letter-spacing: 0.08em;
    margin-bottom: 1.5rem;
    color: var(--text);
  }
  .field { margin-bottom: 1.2rem; }
  label {
    display: block;
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 0.5rem;
  }
  input, select {
    width: 100%;
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    font-family: 'DM Sans', sans-serif;
    font-size: 0.9rem;
    padding: 0.75rem 1rem;
    outline: none;
    transition: border-color 0.2s;
    appearance: none;
  }
  input:focus, select:focus { border-color: var(--accent); }
  input::placeholder { color: var(--muted); }

  .btn {
    background: var(--accent);
    color: #1e1018;
    border: none;
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    padding: 0.85rem 2rem;
    cursor: pointer;
    font-weight: 500;
    transition: all 0.15s;
    display: inline-block;
  }
  .btn:hover { background: #f5e6cc; }
  .btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .btn-danger {
    background: var(--loss);
    color: #fff;
    border: none;
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 0.4rem 0.8rem;
    cursor: pointer;
    transition: opacity 0.15s;
  }
  .btn-danger:hover { opacity: 0.8; }

  .msg {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    padding: 0.75rem 1rem;
    margin-top: 1rem;
    border-left: 3px solid var(--accent);
    background: rgba(229,178,93,0.07);
    color: var(--accent);
    display: none;
  }
  .msg.err { border-color: var(--loss); background: rgba(255,71,87,0.05); color: var(--loss); }

  /* HISTORY */
  .history-filters { display: flex; gap: 1rem; margin-bottom: 1.5rem; align-items: center; }
  .history-filters select { width: auto; min-width: 200px; }
  .match-row {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 1rem 1.5rem;
    margin-bottom: 0.5rem;
    display: grid;
    grid-template-columns: 1fr auto 1fr auto;
    align-items: center;
    gap: 1rem;
    transition: border-color 0.2s;
  }
  .match-row:hover { border-color: var(--border); }
  .match-player { display: flex; flex-direction: column; gap: 0.25rem; }
  .match-player .name { font-weight: 600; font-size: 0.95rem; }
  .match-player .delta { font-family: 'DM Mono', monospace; font-size: 0.75rem; }
  .match-player .delta.pos { color: var(--win); }
  .match-player .delta.neg { color: var(--loss); }
  .match-player .rd-info { font-family: 'DM Mono', monospace; font-size: 0.65rem; color: var(--muted); }
  .match-result { font-family: 'Bebas Neue', sans-serif; font-size: 2rem; text-align: center; color: var(--muted); letter-spacing: 0.1em; display: flex; align-items: center; gap: 0.5rem; white-space: nowrap; }
  .match-result .win-side { color: var(--win); }
  .match-result .loss-side { color: var(--loss); }
  .match-meta { text-align: right; font-family: 'DM Mono', monospace; font-size: 0.65rem; color: var(--muted); line-height: 1.6; }

  .empty {
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    color: var(--muted);
    text-align: center;
    padding: 3rem;
    border: 1px dashed var(--border);
  }

  /* LOADING SPINNER */
  .loading {
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    color: var(--muted);
    text-align: center;
    padding: 3rem;
    letter-spacing: 0.1em;
  }
  .loading::after {
    content: '';
    display: inline-block;
    width: 12px; height: 12px;
    border: 2px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    margin-left: 8px;
    vertical-align: middle;
    animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  @media (max-width: 700px) {
    header { padding: 1.5rem; flex-direction: column; gap: 0.5rem; }
    header h1 { font-size: 2.5rem; }
    nav { padding: 0 1rem; }
    main { padding: 1.5rem; }
    .match-row { grid-template-columns: 1fr 1fr; grid-template-rows: auto auto; }
  }

  /* PLAYER PROFILE MODAL */
  .modal-overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(5,5,10,0.85);
    backdrop-filter: blur(6px);
    z-index: 100;
    align-items: center;
    justify-content: center;
  }
  .modal-overlay.open { display: flex; }
  .modal {
    background: var(--surface);
    border: 1px solid var(--border);
    width: min(820px, 95vw);
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
    animation: modalIn 0.2s ease;
  }
  @keyframes modalIn { from { opacity: 0; transform: translateY(16px); } to { opacity: 1; transform: translateY(0); } }
  .modal-header {
    padding: 2rem 2rem 1.5rem;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
  }
  .modal-header-left { display: flex; flex-direction: column; gap: 0.4rem; }
  .modal-player-name { font-family: 'Bebas Neue', sans-serif; font-size: 2.5rem; letter-spacing: 0.06em; color: var(--text); line-height: 1; }
  .modal-player-stats { display: flex; gap: 2rem; flex-wrap: wrap; margin-top: 0.5rem; }
  .modal-stat { display: flex; flex-direction: column; gap: 0.2rem; }
  .modal-stat-label { font-family: 'DM Mono', monospace; font-size: 0.6rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); }
  .modal-stat-value { font-family: 'Bebas Neue', sans-serif; font-size: 1.6rem; color: var(--accent); line-height: 1; }
  .modal-stat-value.neutral { color: var(--text); }
  .modal-stat-value.green { color: var(--win); }
  .modal-stat-value.red { color: var(--loss); }
  .modal-close {
    background: none;
    border: 1px solid var(--border);
    color: var(--muted);
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    letter-spacing: 0.1em;
    padding: 0.5rem 0.8rem;
    cursor: pointer;
    flex-shrink: 0;
    transition: all 0.15s;
  }
  .modal-close:hover { border-color: var(--text); color: var(--text); }
  .modal-body { padding: 2rem; }

  .chart-section { margin-bottom: 2rem; }
  .chart-label { font-family: 'DM Mono', monospace; font-size: 0.65rem; letter-spacing: 0.12em; text-transform: uppercase; color: var(--muted); margin-bottom: 1rem; }
  .chart-outer { border: 1px solid var(--border); background: var(--bg); overflow-x: auto; overflow-y: hidden; position: relative; height: 220px; cursor: crosshair; }
  .chart-outer::-webkit-scrollbar { height: 5px; }
  .chart-outer::-webkit-scrollbar-track { background: var(--bg); }
  .chart-outer::-webkit-scrollbar-thumb { background: var(--border); }
  .chart-outer::-webkit-scrollbar-thumb:hover { background: var(--muted); }
  .chart-wrap { position: relative; display: inline-block; min-width: 100%; }
  .chart-tooltip {
    position: absolute;
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 0.5rem 0.8rem;
    font-family: 'DM Mono', monospace;
    font-size: 0.7rem;
    color: var(--text);
    pointer-events: none;
    z-index: 20;
    display: none;
    line-height: 1.6;
    white-space: nowrap;
    box-shadow: 0 4px 20px rgba(0,0,0,0.5);
  }

  .profile-match {
    display: grid;
    grid-template-columns: auto 1fr auto;
    align-items: center;
    gap: 1rem;
    padding: 0.85rem 0;
    border-bottom: 1px solid rgba(74,42,56,0.6);
  }
  .profile-match:last-child { border-bottom: none; }
  .pm-badge { font-family: 'Bebas Neue', sans-serif; font-size: 0.95rem; width: 3.2rem; text-align: center; padding: 0.3rem 0; letter-spacing: 0.05em; }
  .pm-badge.win  { color: var(--win);  background: rgba(71,255,184,0.08); }
  .pm-badge.loss { color: var(--loss); background: rgba(255,71,87,0.08); }
  .pm-info { display: flex; flex-direction: column; gap: 0.2rem; }
  .pm-opponent { font-weight: 600; font-size: 0.9rem; }
  .pm-date { font-family: 'DM Mono', monospace; font-size: 0.65rem; color: var(--muted); }
  .pm-delta { font-family: 'DM Mono', monospace; font-size: 0.85rem; text-align: right; white-space: nowrap; }
  .pm-delta.pos { color: var(--win); }
  .pm-delta.neg { color: var(--loss); }

  /* PLAYER CARDS (Players tab) */
  .player-cards-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.65rem;
    letter-spacing: 0.12em;
    color: var(--muted);
    margin-bottom: 1rem;
  }
  .player-cards-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(260px, 1fr));
    gap: 1rem;
  }
  .player-card {
    background: var(--surface);
    border: 1px solid var(--border);
    padding: 1.25rem;
    cursor: pointer;
    transition: border-color 0.2s, transform 0.15s;
    display: flex;
    flex-direction: column;
    gap: 0.9rem;
  }
  .player-card:hover { border-color: var(--accent); transform: translateY(-2px); box-shadow: 0 4px 24px rgba(229,178,93,0.12); }
  .player-card-top {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: 0.5rem;
  }
  .player-card-name {
    font-weight: 600;
    font-size: 1rem;
    letter-spacing: 0.02em;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
  }
  .player-card-tag {
    font-family: 'DM Mono', monospace;
    font-size: 0.55rem;
    letter-spacing: 0.1em;
    color: var(--loss);
    border: 1px solid var(--loss);
    padding: 0.15rem 0.4rem;
    flex-shrink: 0;
  }
  .player-card-stats {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 0.6rem 1rem;
  }
  .player-card-stat { display: flex; flex-direction: column; gap: 0.15rem; }
  .player-card-stat-label {
    font-family: 'DM Mono', monospace;
    font-size: 0.58rem;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: var(--muted);
  }
  .player-card-stat-val {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 1.3rem;
    line-height: 1;
  }
  .player-card-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-top: 0.25rem;
    padding-top: 0.75rem;
    border-top: 1px solid var(--border);
  }

  /* PLAYERS TAB TWO-COLUMN LAYOUT */
  .players-panel-layout {
    display: grid;
    grid-template-columns: 500px 1fr;
    gap: 2rem;
    align-items: start;
  }
  .players-forms-col { display: flex; flex-direction: column; }
  .players-cards-col { min-width: 0; }
  @media (max-width: 900px) {
    .players-panel-layout { grid-template-columns: 1fr; }
    .players-cards-col { display: none !important; }
    #players-list { display: block !important; }
  }
  @media (min-width: 901px) {
    #players-list { display: none !important; }
  }

  /* QUOTE */
  .lb-quote {
    font-family: 'DM Mono', monospace;
    font-size: 0.8rem;
    color: var(--muted);
    font-style: italic;
    margin-bottom: 1.5rem;
    padding: 0.9rem 1.2rem;
    border-left: 3px solid var(--accent);
    background: rgba(229,178,93,0.04);
    letter-spacing: 0.02em;
    line-height: 1.6;
  }
  .lb-quote .quote-attr { color: var(--accent); font-style: normal; }
  .modal-quote {
    font-family: 'DM Mono', monospace;
    font-size: 0.75rem;
    color: var(--muted);
    font-style: italic;
    margin-top: 0.75rem;
    line-height: 1.6;
    letter-spacing: 0.02em;
  }
  .modal-quote .quote-attr { color: var(--accent); font-style: normal; }

  /* MATCH SCORE */
  .match-score-display {
    font-family: 'Bebas Neue', sans-serif;
    font-size: 0.85rem;
    color: var(--muted);
    letter-spacing: 0.08em;
    margin-top: 0.15rem;
  }

  /* SCROLLBARS */
  ::-webkit-scrollbar { width: 8px; height: 8px; }
  ::-webkit-scrollbar-track { background: var(--bg); }
  ::-webkit-scrollbar-thumb { background: var(--border); border-radius: 0; }
  ::-webkit-scrollbar-thumb:hover { background: var(--muted); }
  ::-webkit-scrollbar-corner { background: var(--bg); }
  * { scrollbar-width: thin; scrollbar-color: var(--border) var(--bg); }
</style>
</head>
<body>

<header>
  <div style="display:flex;align-items:center;gap:1rem">
    <div style="height:44px;width:auto;display:flex;align-items:center">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="-1 15 65 40" style="height:44px;width:auto">
  <g fill="#E5B25D" transform="matrix(0.67465, 0, 0, 0.67465, 0, 17)">
    <path d="M0,51.17l59.29.34L29.94,0,0,51.17ZM10.57,45.16L29.87,12.16l18.92,33.21-38.22-.22Z"/>
    <path d="M56.43,49.84l-53.56-.31L29.92,3.31l26.52,46.54ZM4.61,48.54l50.09.29L29.91,5.31,4.61,48.54ZM53.38,48.06l-47.42-.27L29.9,6.85l23.48,41.2ZM7.69,46.79l43.96.25L29.89,8.85,7.69,46.79Z"/>
  </g>
  <g>
    <g fill="#E5B25D" transform="matrix(0.5002, 0, 0, 0.5002, 5.244337, 16.159662)">
      <path d="M85.83,1.68h-.2c-13.75,0-24.95,11.17-24.99,24.92-.04,13.78,11.14,25.02,24.93,25.06h.2c13.75,0,24.95-11.17,24.99-24.92.04-13.78-11.14-25.02-24.93-25.06ZM82.49,8.06l-.09,15.41-15.3-.09c.66-3.79,2.46-7.29,5.23-10.07,2.8-2.8,6.33-4.6,10.16-5.25ZM82.36,29.54l-.09,15.71c-3.77-.7-7.3-2.53-10.01-5.29-2.86-2.89-4.65-6.56-5.24-10.51l15.34.09ZM88.35,45.37l.09-15.79,15.91.09c-1.32,8.12-7.83,14.54-16,15.7ZM88.48,23.5l.09-15.49c8.05,1.24,14.43,7.57,15.77,15.58l-15.86-.09Z"/>
    </g>
    <rect style="fill: rgb(229, 178, 93); transform-box: fill-box; transform-origin: 50% 50%;" transform="matrix(0.866026, -0.5, 0.5, 0.866026, -10.207183, -11.867224)" x="64.404" y="49.512" width="5" height="14" rx="1" ry="1"/>
  </g>
  <path style="fill: rgb(229, 178, 93);" d="M 48.584 41.937 C 51.595 42.003 52.489 42.72 54.089 45.157 L 58.396 42.534 C 57.247 40.011 57.233 38.736 58.841 35.979 C 55.729 37.282 48.569 41.95 48.584 41.937 Z"/>
</svg>
    </div>
    <h1>TTTIW</h1>
  </div>
  <span style="color:var(--text)">Table Tennis · Texas Invention<span style="color:var(--accent)">Works</span><span style="color:var(--text)"> · Rating System</span></span>
  <span id="decay-status" style="margin-left:auto;font-size:0.65rem;color:var(--muted);font-family:'DM Mono',monospace;letter-spacing:0.1em"></span>
</header>

<nav>
  <button class="active" onclick="showPanel('leaderboard', this)">Leaderboard</button>
  <button onclick="showPanel('players', this)">Players</button>
  <button onclick="showPanel('match', this)">Submit Match</button>
  <button onclick="showPanel('history', this)">Match History</button>
</nav>

<main>
  <!-- CONFIG BANNER (shown until Firebase config is filled in) -->
  <div id="config-banner" style="display:none">
    ⚠ <strong>SETUP REQUIRED</strong> — Open this file and replace the Firebase config values at the top of the &lt;script&gt; block with your own project credentials from the Firebase Console → Project Settings → Your apps.
  </div>

  <!-- LEADERBOARD -->
  <div id="panel-leaderboard" class="panel active">
    <div id="lb-loading" class="loading">Loading leaderboard</div>
    <table class="lb-table" id="lb-table" style="display:none">
      <thead>
        <tr>
          <th>#</th>
          <th>Player</th>
          <th>Rating</th>
          <th>RD</th>
          <th>Record (W-L)</th>
        </tr>
      </thead>
      <tbody id="lb-body"></tbody>
    </table>
    <div id="lb-empty" class="empty" style="display:none">No players yet. Add some!</div>
  </div>

  <!-- ADD PLAYERS -->
  <div id="panel-players" class="panel">
    <div class="players-panel-layout">
      <div class="players-forms-col">
        <div class="form-card">
          <h2>Add Player</h2>
          <div class="field">
            <label>Player Name</label>
            <input type="text" id="player-name" placeholder="Enter name…">
          </div>
          <div class="field">
            <label>Starting Rating (default 1500)</label>
            <input type="number" id="player-rating" placeholder="1500">
          </div>
          <div class="field">
            <label>Starting RD (default 120)</label>
            <input type="number" id="player-rd" placeholder="120">
          </div>
          <button class="btn" id="add-player-btn" onclick="addPlayer()">Add Player</button>
          <div class="msg" id="player-msg"></div>
        </div>

        <div class="form-card" style="border-color:#2e2e4e">
          <h2>RD Decay Settings</h2>
          <p style="font-family:'DM Mono',monospace;font-size:0.7rem;color:var(--muted);margin-bottom:1.2rem;line-height:1.6">
            RD increases each inactive period using the Glicko-2 formula φ* = √(φ² + σ²).<br>
            Decay is computed lazily on each page load and match submission — no server cron needed.<br>
            Default RD: 120 · Max RD: 200 · Hidden from leaderboard if RD > 100.
          </p>
          <div class="field">
            <label>Decay Period (per inactive period)</label>
            <div style="display:flex;gap:0.5rem">
              <input type="number" id="decay-amount" min="0.01" step="0.01" placeholder="7" style="flex:1">
              <select id="decay-unit" style="width:120px">
                <option value="days">Days</option>
                <option value="hours">Hours</option>
                <option value="minutes">Minutes</option>
              </select>
            </div>
          </div>
          <button class="btn" onclick="saveDecaySettings()">Save Settings</button>
          <div class="msg" id="decay-msg"></div>
        </div>

        <!-- mobile-only player list -->
        <div id="players-list"></div>
      </div>

      <!-- desktop-only player cards column -->
      <div class="players-cards-col">
        <div id="players-list-inline"></div>
      </div>
    </div>
  </div>

  <!-- SUBMIT MATCH -->
  <div id="panel-match" class="panel">
    <div class="form-card">
      <h2>Submit Match Result</h2>
      <div class="field">
        <label>Winner</label>
        <select id="match-winner"></select>
      </div>
      <div class="field">
        <label>Loser</label>
        <select id="match-loser"></select>
      </div>
      <div class="field">
        <label>Score (optional, e.g. 11-7)</label>
        <input type="text" id="match-score" placeholder="e.g. 11-7, 3-2, …">
      </div>
      <button class="btn" id="submit-match-btn" onclick="submitMatch()">Submit</button>
      <div class="msg" id="match-msg"></div>
    </div>
  </div>

  <!-- HISTORY -->
  <div id="panel-history" class="panel">
    <div class="history-filters">
      <select id="history-filter" onchange="renderHistory()">
        <option value="all">All Players</option>
      </select>
    </div>
    <div id="history-list"><div class="loading">Loading matches</div></div>
  </div>
</main>

<!-- PLAYER PROFILE MODAL -->
<div class="modal-overlay" id="profile-overlay" onclick="closeProfile(event)">
  <div class="modal" id="profile-modal">
    <div class="modal-header">
      <div class="modal-header-left">
        <div class="modal-player-name" id="profile-name">—</div>
        <div class="modal-player-stats" id="profile-stats"></div>
        <div class="modal-quote" id="profile-quote" style="display:none"></div>
      </div>
      <button class="modal-close" onclick="document.getElementById('profile-overlay').classList.remove('open')">ESC ✕</button>
    </div>
    <div class="modal-body">
      <div class="chart-section">
        <div class="chart-label">Rating History</div>
        <div class="chart-outer" id="chart-outer">
          <div class="chart-wrap" id="chart-wrap">
            <canvas id="rating-chart"></canvas>
            <div class="chart-tooltip" id="chart-tooltip"></div>
          </div>
        </div>
      </div>
      <div class="chart-label" style="margin-bottom:1rem">Match History</div>
      <div id="profile-matches"></div>
    </div>
  </div>
</div>

<script type="module">
// ─────────────────────────────────────────────────────────────────────────────
// ❶  PASTE YOUR FIREBASE CONFIG HERE
//    Firebase Console → Project Settings → Your apps → SDK setup and config
// ─────────────────────────────────────────────────────────────────────────────
const FIREBASE_CONFIG = {
  apiKey:            "AIzaSyCHRQOLzC0DcuZv4aCqsL4EM_IVthiZSIc",
  authDomain:        "tttiw-6d44e.firebaseapp.com",
  projectId:         "tttiw-6d44e",
  storageBucket:     "tttiw-6d44e.firebasestorage.app",
  messagingSenderId: "902138155809",
  appId:             "1:902138155809:web:0860c66b77d07746952460"
};
// ─────────────────────────────────────────────────────────────────────────────

import { initializeApp }     from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import { getFirestore, collection, doc,
         addDoc, setDoc, updateDoc, deleteDoc,
         onSnapshot, query, orderBy,
         serverTimestamp, runTransaction }
                             from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

// Detect unconfigured state
const isConfigured = !Object.values(FIREBASE_CONFIG).some(v => v.startsWith("PASTE_"));
if (!isConfigured) {
  document.getElementById('config-banner').style.display = 'block';
}

let app, db;
let players = [];
let matches  = [];

if (isConfigured) {
  try {
    app = initializeApp(FIREBASE_CONFIG);
    db  = getFirestore(app);
    initListeners();
  } catch(e) {
    console.error(e);
  }
}

// ─── GLICKO-2 CONSTANTS ──────────────────────────────────────────────────────
const SIGMA_FIXED = 0.06;
const RD_MAX      = 200;

// ─── REAL-TIME LISTENERS ─────────────────────────────────────────────────────
function initListeners() {
  onSnapshot(
    query(collection(db, 'players'), orderBy('rating', 'desc')),
    (snap) => {
      players = snap.docs.map(d => ({ firestoreId: d.id, ...d.data() }));
      applyDecayLocally();
      renderLeaderboard();
      renderPlayersList();
      renderMatchSelects();
      updateDecayStatus();
    },
    (err) => { console.error('Players listener error:', err); }
  );

  onSnapshot(
    query(collection(db, 'matches'), orderBy('date', 'desc')),
    (snap) => {
      matches = snap.docs.map(d => ({ firestoreId: d.id, ...d.data() }));
      renderHistory();
    },
    (err) => { console.error('Matches listener error:', err); }
  );

  let decaySettingsReady = false;
  onSnapshot(doc(db, 'config', 'decay'), (snap) => {
    if (snap.exists()) {
      const data = snap.data();
      document.getElementById('decay-amount').value = data.amount || '7';
      document.getElementById('decay-unit').value   = data.unit   || 'days';
    }
    if (!decaySettingsReady) {
      decaySettingsReady = true;
      applyDecayLocally();
      updateDecayStatus();
    }
  });

  setInterval(updateDecayStatus, 1000);
  setInterval(applyDecayLocally, 5000);
}

// ─── RD DECAY ────────────────────────────────────────────────────────────────
function getDecayPeriodMs() {
  const amount = parseFloat(document.getElementById('decay-amount').value) || 7;
  const unit   = document.getElementById('decay-unit').value || 'days';
  if (unit === 'minutes') return amount * 60 * 1000;
  if (unit === 'hours')   return amount * 3600 * 1000;
  return amount * 86400 * 1000;
}

function computeDecay(player) {
  const now         = Date.now();
  const last        = player.lastDecayAt || now;
  const msPerPeriod = getDecayPeriodMs();
  const periods     = Math.floor((now - last) / msPerPeriod);
  if (periods <= 0) return null;

  let phi = player.rd / 173.7178;
  const phiMax = RD_MAX / 173.7178;
  for (let i = 0; i < periods; i++) {
    phi = Math.sqrt(phi * phi + SIGMA_FIXED * SIGMA_FIXED);
    if (phi >= phiMax) { phi = phiMax; break; }
  }
  const newRD          = Math.round(Math.min(phi * 173.7178, RD_MAX) * 10) / 10;
  const newLastDecayAt = last + periods * msPerPeriod;
  return { newRD, newLastDecayAt, periods };
}

function applyDecayLocally() {
  if (!db) return;
  const toUpdate = [];
  players.forEach(p => {
    const result = computeDecay(p);
    if (!result) return;
    p.rd          = result.newRD;
    p.lastDecayAt = result.newLastDecayAt;
    toUpdate.push({ firestoreId: p.firestoreId, rd: result.newRD, lastDecayAt: result.newLastDecayAt });
  });
  toUpdate.forEach(({ firestoreId, rd, lastDecayAt }) => {
    updateDoc(doc(db, 'players', firestoreId), { rd, lastDecayAt }).catch(console.error);
  });
}

function updateDecayStatus() {
  const statusEl = document.getElementById('decay-status');
  if (!statusEl || players.length === 0) return;
  const msPerPeriod = getDecayPeriodMs();
  const now         = Date.now();
  const nextDecay   = Math.min(...players.map(p => (p.lastDecayAt || now) + msPerPeriod - now));
  const amount      = document.getElementById('decay-amount').value || '7';
  const unit        = document.getElementById('decay-unit').value || 'days';
  const periodLabel = amount + unit.charAt(0).toUpperCase();

  if (nextDecay > 0) {
    const hrs  = Math.floor(nextDecay / 3600000);
    const mins = Math.floor((nextDecay % 3600000) / 60000);
    const secs = Math.floor((nextDecay % 60000) / 1000);
    const nextLabel = hrs > 0 ? hrs + 'h ' + mins + 'm' : mins + 'm ' + secs + 's';
    statusEl.textContent = 'DECAY · ' + periodLabel + ' · NEXT IN ' + nextLabel;
  } else {
    statusEl.textContent = 'DECAY · ' + periodLabel;
  }
}

// ─── GLICKO-2 MATH ───────────────────────────────────────────────────────────
function toGlicko2(r, rd)      { return { mu: (r - 1500) / 173.7178, phi: rd / 173.7178 }; }
function fromGlicko2(mu, phi)  { return { r: mu * 173.7178 + 1500, rd: phi * 173.7178 }; }
function g(phi)                { return 1 / Math.sqrt(1 + 3 * phi * phi / (Math.PI * Math.PI)); }
function E(mu, muJ, phiJ)      { return 1 / (1 + Math.exp(-g(phiJ) * (mu - muJ))); }

function glicko2Update(player, opponents) {
  const { mu, phi } = toGlicko2(player.rating, player.rd);
  if (opponents.length === 0) {
    return { rating: player.rating, rd: Math.min(RD_MAX, Math.sqrt(phi * phi + SIGMA_FIXED * SIGMA_FIXED) * 173.7178) };
  }
  let vInv = 0, delta_sum = 0;
  for (const opp of opponents) {
    const { mu: muJ, phi: phiJ } = toGlicko2(opp.rating, opp.rd);
    const gJ = g(phiJ), eJ = E(mu, muJ, phiJ);
    vInv      += gJ * gJ * eJ * (1 - eJ);
    delta_sum += gJ * (opp.s - eJ);
  }
  const v        = 1 / vInv;
  const phiStar  = Math.sqrt(phi * phi + SIGMA_FIXED * SIGMA_FIXED);
  const phiNew   = 1 / Math.sqrt(1 / (phiStar * phiStar) + 1 / v);
  const muNew    = mu + phiNew * phiNew * delta_sum;
  const res      = fromGlicko2(muNew, phiNew);
  return { rating: Math.round(res.r * 10) / 10, rd: Math.round(res.rd * 10) / 10 };
}

// ─── LEADERBOARD ─────────────────────────────────────────────────────────────
function renderLeaderboard() {
  const sorted  = [...players].sort((a, b) => b.rating - a.rating);
  const tbody   = document.getElementById('lb-body');
  const empty   = document.getElementById('lb-empty');
  const table   = document.getElementById('lb-table');
  const loading = document.getElementById('lb-loading');

  loading.style.display = 'none';

  if (sorted.length === 0) {
    table.style.display = 'none';
    empty.style.display = 'block';
    return;
  }
  empty.style.display = 'none';
  table.style.display = 'table';

  const visible = sorted.filter(p => p.rd <= 100);
  if (visible.length === 0 && sorted.length > 0) {
    table.style.display = 'none';
    let hiddenNote = document.getElementById('lb-hidden-note');
    if (!hiddenNote) {
      hiddenNote = document.createElement('div');
      hiddenNote.id = 'lb-hidden-note';
      hiddenNote.className = 'empty';
      document.getElementById('panel-leaderboard').appendChild(hiddenNote);
    }
    hiddenNote.style.display = 'block';
    hiddenNote.textContent = sorted.length + ' player(s) exist but all have RD > 100 (not enough matches to rank). Play more games!';
    return;
  }
  const hiddenNote = document.getElementById('lb-hidden-note');
  if (hiddenNote) hiddenNote.style.display = 'none';

  // Show #1 player's quote above the table
  let lbQuoteEl = document.getElementById('lb-quote');
  if (!lbQuoteEl) {
    lbQuoteEl = document.createElement('div');
    lbQuoteEl.id = 'lb-quote';
    lbQuoteEl.className = 'lb-quote';
    table.parentNode.insertBefore(lbQuoteEl, table);
  }
  const topPlayer = visible[0];
  if (topPlayer && topPlayer.quote) {
    lbQuoteEl.innerHTML = `"${esc(topPlayer.quote)}" <span class="quote-attr">— ${esc(topPlayer.name)}</span>`;
    lbQuoteEl.style.display = 'block';
  } else {
    lbQuoteEl.style.display = 'none';
  }

  tbody.innerHTML = visible.map((p, i) => {
    const rankClass = i === 0 ? 'top1' : i === 1 ? 'top2' : i === 2 ? 'top3' : '';
    return `<tr onclick="window.openProfile('${p.firestoreId}')">
      <td class="rank ${rankClass}">${i + 1}</td>
      <td class="player-name">${esc(p.name)}</td>
      <td><span class="rating-val">${Math.round(p.rating)}</span></td>
      <td><span class="rd-val">±${Math.round(p.rd)}</span></td>
      <td><span class="record-badge">
        <span class="w">${p.wins}W</span>
        <span class="l">${p.losses}L</span>
      </span></td>
    </tr>`;
  }).join('');

  if (sorted.length > visible.length) {
    const hiddenCount = sorted.length - visible.length;
    tbody.innerHTML += `<tr><td colspan="5" style="font-family:'DM Mono',monospace;font-size:0.65rem;color:var(--muted);padding:0.75rem 1rem;text-align:center">${hiddenCount} player(s) hidden (RD > 100 — not enough recent matches)</td></tr>`;
  }
}

// ─── PLAYERS PANEL ───────────────────────────────────────────────────────────
window.addPlayer = async function() {
  if (!db) return;
  const name   = document.getElementById('player-name').value.trim();
  const rating = parseFloat(document.getElementById('player-rating').value) || 1500;
  const rd     = parseFloat(document.getElementById('player-rd').value) || 120;
  if (!name) { showMsg('player-msg', 'Name required.', true); return; }
  if (players.find(p => p.name.toLowerCase() === name.toLowerCase())) {
    showMsg('player-msg', 'Player already exists.', true); return;
  }
  const btn = document.getElementById('add-player-btn');
  btn.disabled = true;
  try {
    await addDoc(collection(db, 'players'), {
      name, rating, rd, wins: 0, losses: 0,
      lastDecayAt: Date.now(),
      createdAt: serverTimestamp()
    });
    document.getElementById('player-name').value   = '';
    document.getElementById('player-rating').value = '';
    document.getElementById('player-rd').value     = '';
    showMsg('player-msg', `${name} added!`);
  } catch(e) {
    showMsg('player-msg', 'Error: ' + e.message, true);
  } finally {
    btn.disabled = false;
  }
};

window.removePlayer = async function(firestoreId) {
  if (!db || !confirm('Remove this player? Their match history will remain.')) return;
  try {
    await deleteDoc(doc(db, 'players', firestoreId));
  } catch(e) {
    alert('Error removing player: ' + e.message);
  }
};

window.saveQuote = async function(firestoreId) {
  if (!db) return;
  const input = document.getElementById('quote-input-' + firestoreId);
  const quote = input ? input.value.trim() : '';
  try {
    await updateDoc(doc(db, 'players', firestoreId), { quote: quote || null });
    // Update local copy
    const p = players.find(x => x.firestoreId === firestoreId);
    if (p) p.quote = quote || null;
    showMsg('quote-msg-' + firestoreId, quote ? 'Quote saved!' : 'Quote cleared.');
  } catch(e) {
    showMsg('quote-msg-' + firestoreId, 'Error: ' + e.message, true);
  }
};

// ─── PLAYER STAT HELPERS ─────────────────────────────────────────────────────
function computePlayerStats(firestoreId) {
  const playerIds = new Set(players.map(x => x.firestoreId));
  const pm = [...matches]
    .filter(m => playerIds.has(m.p1id) && playerIds.has(m.p2id))
    .filter(m => m.p1id === firestoreId || m.p2id === firestoreId)
    .sort((a, b) => {
      const ta = a.date?.toDate ? a.date.toDate() : new Date(a.date);
      const tb = b.date?.toDate ? b.date.toDate() : new Date(b.date);
      return ta - tb;
    });

  let longestStreak = 0, curStreak = 0;
  pm.forEach(m => {
    const isP1 = m.p1id === firestoreId;
    const won  = isP1 ? m.score === 1 : m.score === 0;
    if (won) { curStreak++; longestStreak = Math.max(longestStreak, curStreak); }
    else curStreak = 0;
  });

  let longestAtOne = 0;
  const allSortedMatches = [...matches]
    .filter(m => playerIds.has(m.p1id) && playerIds.has(m.p2id))
    .sort((a, b) => {
      const ta = a.date?.toDate ? a.date.toDate() : new Date(a.date);
      const tb = b.date?.toDate ? b.date.toDate() : new Date(b.date);
      return ta - tb;
    });

  if (allSortedMatches.length > 0 && players.length >= 2) {
    const ratingSnapshots = {};
    players.forEach(p => { ratingSnapshots[p.firestoreId] = 1500; });

    const seenPlayers = new Set();
    allSortedMatches.forEach(m => {
      if (!seenPlayers.has(m.p1id)) { ratingSnapshots[m.p1id] = m.p1oldRating; seenPlayers.add(m.p1id); }
      if (!seenPlayers.has(m.p2id)) { ratingSnapshots[m.p2id] = m.p2oldRating; seenPlayers.add(m.p2id); }
    });

    let atOneStart = null;
    const getTopPlayer = () => {
      let topId = null, topR = -Infinity;
      Object.entries(ratingSnapshots).forEach(([id, r]) => { if (r > topR) { topR = r; topId = id; } });
      return topId;
    };

    allSortedMatches.forEach(m => {
      const prevTop = getTopPlayer();
      ratingSnapshots[m.p1id] = m.p1newRating;
      ratingSnapshots[m.p2id] = m.p2newRating;
      const newTop = getTopPlayer();
      const ts = m.date?.toDate ? m.date.toDate() : new Date(m.date);

      if (prevTop === firestoreId && newTop !== firestoreId) {
        if (atOneStart !== null) {
          longestAtOne = Math.max(longestAtOne, ts.getTime() - atOneStart);
          atOneStart = null;
        }
      } else if (prevTop !== firestoreId && newTop === firestoreId) {
        atOneStart = ts.getTime();
      }
    });

    if (getTopPlayer() === firestoreId && atOneStart !== null) {
      longestAtOne = Math.max(longestAtOne, Date.now() - atOneStart);
    }
  }

  return { longestStreak, longestAtOne };
}

function formatDuration(ms) {
  if (ms <= 0) return '—';
  const days  = Math.floor(ms / 86400000);
  const hours = Math.floor((ms % 86400000) / 3600000);
  if (days > 0) return days + 'd ' + hours + 'h';
  const mins = Math.floor((ms % 3600000) / 60000);
  if (hours > 0) return hours + 'h ' + mins + 'm';
  return mins + 'm';
}

function renderPlayersList() {
  const el = document.getElementById('players-list');
  if (players.length === 0) { el.innerHTML = '<div class="empty">No players yet.</div>'; return; }

  const sorted = [...players].sort((a, b) => b.rating - a.rating);
  const cards  = sorted.map(p => {
    const winRate    = (p.wins + p.losses) > 0 ? Math.round(p.wins / (p.wins + p.losses) * 100) : 0;
    const winClass   = winRate >= 60 ? 'var(--win)' : winRate >= 40 ? 'var(--text)' : 'var(--loss)';
    const rdHidden   = p.rd > 100;
    const rdColor    = rdHidden ? 'var(--loss)' : p.rd > 80 ? 'var(--accent)' : 'var(--win)';
    const { longestStreak, longestAtOne } = computePlayerStats(p.firestoreId);
    const streakColor = longestStreak >= 5 ? 'var(--win)' : longestStreak >= 3 ? 'var(--accent)' : 'var(--text)';
    return `<div class="player-card" onclick="window.openProfile('${p.firestoreId}')">
      <div class="player-card-top">
        <span class="player-card-name">${esc(p.name)}</span>
        ${rdHidden ? '<span class="player-card-tag">HIDDEN</span>' : ''}
      </div>
      <div class="player-card-stats">
        <div class="player-card-stat">
          <span class="player-card-stat-label">Rating</span>
          <span class="player-card-stat-val" style="color:var(--accent)">${Math.round(p.rating)}</span>
        </div>
        <div class="player-card-stat">
          <span class="player-card-stat-label">RD</span>
          <span class="player-card-stat-val" style="color:${rdColor}">±${Math.round(p.rd)}</span>
        </div>
        <div class="player-card-stat">
          <span class="player-card-stat-label">Record</span>
          <span class="player-card-stat-val" style="color:var(--text)">${p.wins}W–${p.losses}L</span>
        </div>
        <div class="player-card-stat">
          <span class="player-card-stat-label">Win %</span>
          <span class="player-card-stat-val" style="color:${winClass}">${winRate}%</span>
        </div>
        <div class="player-card-stat">
          <span class="player-card-stat-label">Best Streak</span>
          <span class="player-card-stat-val" style="color:${streakColor}">${longestStreak > 0 ? longestStreak + 'W' : '—'}</span>
        </div>
        <div class="player-card-stat">
          <span class="player-card-stat-label">Longest #1</span>
          <span class="player-card-stat-val" style="color:var(--accent3);font-size:1rem;padding-top:0.2rem">${formatDuration(longestAtOne)}</span>
        </div>
      </div>
      <div class="player-card-footer">
        <span style="font-family:'DM Mono',monospace;font-size:0.6rem;color:var(--muted);letter-spacing:0.08em">CLICK TO VIEW PROFILE</span>
        <button class="btn-danger" onclick="event.stopPropagation();window.removePlayer('${p.firestoreId}')">Remove</button>
      </div>
      <div onclick="event.stopPropagation()" style="display:flex;flex-direction:column;gap:0.4rem;padding-top:0.5rem;border-top:1px solid var(--border)">
        <label style="margin-bottom:0">Player Quote</label>
        <div style="display:flex;gap:0.5rem">
          <input id="quote-input-${p.firestoreId}" type="text" placeholder='"Something memorable…"' value="${esc(p.quote || '')}" style="font-size:0.8rem;padding:0.5rem 0.75rem">
          <button class="btn" style="padding:0.5rem 0.8rem;font-size:0.65rem;white-space:nowrap" onclick="event.stopPropagation();window.saveQuote('${p.firestoreId}')">Save</button>
        </div>
        <div class="msg" id="quote-msg-${p.firestoreId}" style="margin-top:0;padding:0.4rem 0.75rem;font-size:0.65rem"></div>
      </div>
    </div>`;
  }).join('');

  const html = `<div class="player-cards-label">ALL PLAYERS (${players.length})</div><div class="player-cards-grid">${cards}</div>`;
  el.innerHTML = html;
  const inlineEl = document.getElementById('players-list-inline');
  if (inlineEl) inlineEl.innerHTML = html;
}

// ─── DECAY SETTINGS ──────────────────────────────────────────────────────────
window.saveDecaySettings = async function() {
  const amount = parseFloat(document.getElementById('decay-amount').value);
  const unit   = document.getElementById('decay-unit').value;
  if (!amount || amount < 0.01) { showMsg('decay-msg', 'Enter a valid period.', true); return; }
  try {
    if (db) {
      await setDoc(doc(db, 'config', 'decay'), { amount, unit });
    }
    const now = Date.now();
    await Promise.all(players.map(p =>
      updateDoc(doc(db, 'players', p.firestoreId), { lastDecayAt: now })
    ));
    showMsg('decay-msg', `Decay period set to ${amount} ${unit}. Timers reset.`);
  } catch(e) {
    showMsg('decay-msg', 'Error: ' + e.message, true);
  }
};

// ─── SUBMIT MATCH ─────────────────────────────────────────────────────────────
window.submitMatch = async function() {
  if (!db) return;
  const winnerId = document.getElementById('match-winner').value;
  const loserId  = document.getElementById('match-loser').value;
  if (winnerId === loserId) { showMsg('match-msg', 'Select two different players.', true); return; }

  const btn = document.getElementById('submit-match-btn');
  btn.disabled = true;
  showMsg('match-msg', 'Submitting…');

  try {
    const winnerRef = doc(db, 'players', winnerId);
    const loserRef  = doc(db, 'players', loserId);

    await runTransaction(db, async (tx) => {
      const [winnerSnap, loserSnap] = await Promise.all([tx.get(winnerRef), tx.get(loserRef)]);
      if (!winnerSnap.exists() || !loserSnap.exists()) throw new Error('Player not found');

      const winner = winnerSnap.data();
      const loser  = loserSnap.data();

      const updW = glicko2Update(winner, [{ rating: loser.rating, rd: loser.rd, s: 1 }]);
      const updL = glicko2Update(loser,  [{ rating: winner.rating, rd: winner.rd, s: 0 }]);

      const now = Date.now();
      tx.update(winnerRef, { rating: updW.rating, rd: updW.rd, wins:   winner.wins   + 1, lastDecayAt: now });
      tx.update(loserRef,  { rating: updL.rating, rd: updL.rd, losses: loser.losses  + 1, lastDecayAt: now });

      const matchScore = document.getElementById('match-score').value.trim();
      const matchRef = doc(collection(db, 'matches'));
      tx.set(matchRef, {
        winnerId, loserId,
        winnerName: winner.name, loserName: loser.name,
        p1id: winnerId, p2id: loserId,
        p1name: winner.name, p2name: loser.name,
        score: 1,
        matchScore: matchScore || null,
        p1delta: Math.round((updW.rating - winner.rating) * 10) / 10,
        p2delta: Math.round((updL.rating - loser.rating)  * 10) / 10,
        p1newRD: updW.rd, p2newRD: updL.rd,
        p1oldRating: winner.rating, p1newRating: updW.rating,
        p2oldRating: loser.rating,  p2newRating: updL.rating,
        date: serverTimestamp()
      });
    });

    const w = players.find(p => p.firestoreId === winnerId);
    const l = players.find(p => p.firestoreId === loserId);
    document.getElementById('match-score').value = '';
    showMsg('match-msg', `${w?.name || 'Winner'} wins!`);
  } catch(e) {
    showMsg('match-msg', 'Error: ' + e.message, true);
  } finally {
    btn.disabled = false;
  }
};

function renderMatchSelects() {
  const opts = players.map(p => `<option value="${p.firestoreId}">${esc(p.name)} (${Math.round(p.rating)})</option>`).join('');
  document.getElementById('match-winner').innerHTML = opts || '<option disabled>No players yet</option>';
  document.getElementById('match-loser').innerHTML  = opts || '<option disabled>No players yet</option>';
}

// ─── MATCH HISTORY ────────────────────────────────────────────────────────────
function renderHistoryFilter() {
  const sel = document.getElementById('history-filter');
  const cur = sel.value;
  sel.innerHTML = '<option value="all">All Players</option>' +
    players.map(p => `<option value="${p.firestoreId}">${esc(p.name)}</option>`).join('');
  sel.value = players.find(p => p.firestoreId === cur) ? cur : 'all';
}

window.renderHistory = function() {
  renderHistoryFilter();
  const filter    = document.getElementById('history-filter').value;
  const el        = document.getElementById('history-list');
  const playerIds = new Set(players.map(p => p.firestoreId));

  let ms = matches.filter(m => playerIds.has(m.p1id) && playerIds.has(m.p2id));
  if (filter !== 'all') ms = ms.filter(m => m.p1id === filter || m.p2id === filter);

  if (ms.length === 0) { el.innerHTML = '<div class="empty">No matches yet.</div>'; return; }

  el.innerHTML = ms.map(m => {
    const ts      = m.date?.toDate ? m.date.toDate() : new Date(m.date);
    const dateStr = ts.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
    const timeStr = ts.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit', second:'2-digit' });
    const d1str   = (m.p1delta >= 0 ? '+' : '') + m.p1delta;
    const d2str   = (m.p2delta >= 0 ? '+' : '') + m.p2delta;
    const scoreStr = m.matchScore ? `<span class="match-score-display">${esc(m.matchScore)}</span>` : '';
    return `<div class="match-row">
      <div class="match-player">
        <span class="name">${esc(m.p1name)}</span>
        <span class="delta ${m.p1delta >= 0 ? 'pos' : 'neg'}">${d1str} pts (${Math.round(m.p1oldRating)} → ${Math.round(m.p1newRating)})</span>
        <span class="rd-info">RD: ±${Math.round(m.p1newRD)}</span>
      </div>
      <div class="match-result"><span class="win-side">WIN</span><span style="font-size:0.9rem;color:var(--muted)">vs</span><span class="loss-side">LOSS</span></div>
      <div class="match-player" style="text-align:right">
        <span class="name">${esc(m.p2name)}</span>
        <span class="delta ${m.p2delta >= 0 ? 'pos' : 'neg'}">${d2str} pts (${Math.round(m.p2oldRating)} → ${Math.round(m.p2newRating)})</span>
        <span class="rd-info">RD: ±${Math.round(m.p2newRD)}</span>
      </div>
      <div class="match-meta">${dateStr}<br>${timeStr}${m.matchScore ? '<br>' + esc(m.matchScore) : ''}</div>
    </div>`;
  }).join('');
};

// ─── NAV ─────────────────────────────────────────────────────────────────────
window.showPanel = function(id, btn) {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('nav button').forEach(b => b.classList.remove('active'));
  document.getElementById('panel-' + id).classList.add('active');
  btn.classList.add('active');
  if (id === 'players') renderPlayersList();
  if (id === 'history') renderHistory();
};

// ─── HELPERS ─────────────────────────────────────────────────────────────────
function esc(s) {
  return String(s)
    .replace(/&/g,'&amp;')
    .replace(/</g,'&lt;')
    .replace(/>/g,'&gt;')
    .replace(/"/g,'&quot;');
}
function showMsg(id, text, isErr = false) {
  const el = document.getElementById(id);
  el.textContent = text;
  el.className = 'msg' + (isErr ? ' err' : '');
  el.style.display = 'block';
  if (!isErr) setTimeout(() => { el.style.display = 'none'; }, 3500);
}

// ─── PLAYER PROFILE MODAL ────────────────────────────────────────────────────
window.openProfile = function(firestoreId) {
  const p = players.find(x => x.firestoreId === firestoreId);
  if (!p) return;

  const playerIds     = new Set(players.map(x => x.firestoreId));
  const playerMatches = [...matches]
    .filter(m => playerIds.has(m.p1id) && playerIds.has(m.p2id))
    .filter(m => m.p1id === firestoreId || m.p2id === firestoreId)
    .sort((a, b) => {
      const ta = a.date?.toDate ? a.date.toDate() : new Date(a.date);
      const tb = b.date?.toDate ? b.date.toDate() : new Date(b.date);
      return ta - tb;
    });

  document.getElementById('profile-name').textContent = p.name;

  const quoteEl = document.getElementById('profile-quote');
  if (p.quote) {
    quoteEl.innerHTML = `"${esc(p.quote)}" <span class="quote-attr">— ${esc(p.name)}</span>`;
    quoteEl.style.display = 'block';
  } else {
    quoteEl.style.display = 'none';
  }

  const winRate  = (p.wins + p.losses) > 0 ? Math.round(p.wins / (p.wins + p.losses) * 100) : 0;
  const winClass = winRate >= 60 ? 'green' : winRate >= 40 ? 'neutral' : 'red';
  const { longestStreak, longestAtOne } = computePlayerStats(firestoreId);
  const streakColor = longestStreak >= 5 ? 'green' : longestStreak >= 3 ? '' : 'neutral';
  const atOneStr = formatDuration(longestAtOne);

  document.getElementById('profile-stats').innerHTML = `
    <div class="modal-stat"><span class="modal-stat-label">Rating</span><span class="modal-stat-value">${Math.round(p.rating)}</span></div>
    <div class="modal-stat"><span class="modal-stat-label">RD</span><span class="modal-stat-value neutral">±${Math.round(p.rd)}</span></div>
    <div class="modal-stat"><span class="modal-stat-label">Record</span><span class="modal-stat-value neutral">${p.wins}W – ${p.losses}L</span></div>
    <div class="modal-stat"><span class="modal-stat-label">Win Rate</span><span class="modal-stat-value ${winClass}">${winRate}%</span></div>
    <div class="modal-stat"><span class="modal-stat-label">Best Streak</span><span class="modal-stat-value ${streakColor}">${longestStreak > 0 ? longestStreak + 'W' : '—'}</span></div>
    <div class="modal-stat"><span class="modal-stat-label">Longest #1</span><span class="modal-stat-value" style="color:var(--accent3);font-size:1.2rem">${atOneStr}</span></div>
  `;

  const startRating = playerMatches.length > 0
    ? (playerMatches[0].p1id === firestoreId ? playerMatches[0].p1oldRating : playerMatches[0].p2oldRating)
    : p.rating;

  const points = [{ rating: startRating, label: 'Start' }];
  playerMatches.forEach(m => {
    const isP1 = m.p1id === firestoreId;
    const ts   = m.date?.toDate ? m.date.toDate() : new Date(m.date);
    points.push({
      rating: isP1 ? m.p1newRating : m.p2newRating,
      won:    isP1 ? m.score === 1  : m.score === 0,
      label:  isP1 ? m.p2name : m.p1name,
      date:   ts.toISOString()
    });
  });

  drawChart(points);

  const matchesEl = document.getElementById('profile-matches');
  if (playerMatches.length === 0) {
    matchesEl.innerHTML = '<div class="empty">No matches yet.</div>';
  } else {
    matchesEl.innerHTML = [...playerMatches].reverse().map(m => {
      const isP1     = m.p1id === firestoreId;
      const won      = isP1 ? m.score === 1 : m.score === 0;
      const opponent = isP1 ? m.p2name : m.p1name;
      const delta    = isP1 ? m.p1delta : m.p2delta;
      const oldR     = isP1 ? m.p1oldRating : m.p2oldRating;
      const newR     = isP1 ? m.p1newRating : m.p2newRating;
      const ts       = m.date?.toDate ? m.date.toDate() : new Date(m.date);
      const dateStr  = ts.toLocaleDateString('en-US', { month:'short', day:'numeric', year:'numeric' });
      const timeStr  = ts.toLocaleTimeString('en-US', { hour:'2-digit', minute:'2-digit' });
      const dStr     = (delta >= 0 ? '+' : '') + delta;
      return `<div class="profile-match">
        <span class="pm-badge ${won ? 'win' : 'loss'}">${won ? 'WIN' : 'LOSS'}</span>
        <div class="pm-info">
          <span class="pm-opponent">vs ${esc(opponent)}${m.matchScore ? ' <span style="font-family:\'DM Mono\',monospace;font-size:0.65rem;color:var(--muted);">' + esc(m.matchScore) + '</span>' : ''}</span>
          <span class="pm-date">${dateStr} · ${timeStr}</span>
        </div>
        <span class="pm-delta ${delta >= 0 ? 'pos' : 'neg'}">${dStr} pts<br><span style="font-size:0.7rem;color:var(--muted)">${Math.round(oldR)} → ${Math.round(newR)}</span></span>
      </div>`;
    }).join('');
  }

  document.getElementById('profile-overlay').classList.add('open');
};

function drawChart(points) {
  const MIN_PX = 64;
  const PAD    = { top: 20, right: 30, bottom: 30, left: 52 };
  const H      = 220;

  const outer     = document.getElementById('chart-outer');
  const chartWrap = document.getElementById('chart-wrap');
  const canvas    = document.getElementById('rating-chart');
  const tooltip   = document.getElementById('chart-tooltip');

  // Replace outer element to remove stale event listeners
  const newOuter = outer.cloneNode(false);
  while (outer.firstChild) newOuter.appendChild(outer.firstChild);
  outer.parentNode.replaceChild(newOuter, outer);

  const outerW = newOuter.clientWidth || 700;
  const minW   = PAD.left + PAD.right + (points.length > 1 ? (points.length - 1) * MIN_PX : 200);
  const W      = Math.max(outerW, minW);

  chartWrap.style.width  = W + 'px';
  chartWrap.style.height = H + 'px';
  canvas.width  = W;
  canvas.height = H;
  const ctx = canvas.getContext('2d');

  const chartW = W - PAD.left - PAD.right;
  const chartH = H - PAD.top  - PAD.bottom;
  const ratings = points.map(pt => pt.rating);
  const minR    = Math.min(...ratings), maxR = Math.max(...ratings);
  const range   = maxR - minR || 50;
  const rPad    = range * 0.18;
  const lo      = minR - rPad, hi = maxR + rPad;

  const xOf = i => PAD.left + (points.length > 1 ? (i / (points.length - 1)) * chartW : chartW / 2);
  const yOf = r => PAD.top  + (1 - (r - lo) / (hi - lo)) * chartH;

  function redraw(hlIdx) {
    ctx.clearRect(0, 0, W, H);
    for (let g = 0; g <= 4; g++) {
      const y = PAD.top + (g / 4) * chartH;
      ctx.strokeStyle = 'rgba(74,42,56,0.9)'; ctx.lineWidth = 1;
      ctx.beginPath(); ctx.moveTo(PAD.left, y); ctx.lineTo(W - PAD.right, y); ctx.stroke();
      ctx.fillStyle = '#8a6a78'; ctx.font = '10px DM Mono, monospace'; ctx.textAlign = 'right';
      ctx.fillText(Math.round(hi - (g / 4) * (hi - lo)), PAD.left - 6, y + 3);
    }
    if (points.length < 2) {
      ctx.fillStyle = '#8a6a78'; ctx.font = '12px DM Mono, monospace'; ctx.textAlign = 'center';
      ctx.fillText('Play more matches to see rating history', W / 2, H / 2);
      return;
    }
    for (let i = 1; i < points.length; i++) {
      const prev  = points[i - 1], cur = points[i];
      const color = cur.won ? 'var(--win)' : '#ff4757';
      ctx.beginPath();
      ctx.moveTo(xOf(i-1), yOf(prev.rating)); ctx.lineTo(xOf(i), yOf(cur.rating));
      ctx.lineTo(xOf(i), H - PAD.bottom); ctx.lineTo(xOf(i-1), H - PAD.bottom); ctx.closePath();
      ctx.fillStyle = cur.won ? 'rgba(126,200,160,0.1)' : 'rgba(217,83,79,0.1)'; ctx.fill();
      ctx.beginPath(); ctx.moveTo(xOf(i-1), yOf(prev.rating)); ctx.lineTo(xOf(i), yOf(cur.rating));
      ctx.strokeStyle = color; ctx.lineWidth = 2; ctx.stroke();
    }
    for (let i = 0; i < points.length; i++) {
      const pt    = points[i];
      const color = i === 0 ? '#8a6a78' : (pt.won ? 'var(--win)' : '#ff4757');
      const isHl  = i === hlIdx;
      if (isHl) {
        ctx.beginPath(); ctx.arc(xOf(i), yOf(pt.rating), 9, 0, Math.PI*2);
        ctx.fillStyle = i === 0 ? 'rgba(138,106,120,0.25)' : (pt.won ? 'rgba(126,200,160,0.25)' : 'rgba(217,83,79,0.25)');
        ctx.fill();
      }
      ctx.beginPath(); ctx.arc(xOf(i), yOf(pt.rating), isHl ? 5 : 4, 0, Math.PI*2);
      ctx.fillStyle = color; ctx.fill();
      if (isHl) {
        ctx.beginPath(); ctx.arc(xOf(i), yOf(pt.rating), 2, 0, Math.PI*2);
        ctx.fillStyle = '#fff'; ctx.fill();
      }
    }
    if (hlIdx >= 0) {
      ctx.beginPath(); ctx.moveTo(xOf(hlIdx), PAD.top); ctx.lineTo(xOf(hlIdx), H - PAD.bottom);
      ctx.strokeStyle = 'rgba(255,255,255,0.08)'; ctx.lineWidth = 1;
      ctx.setLineDash([4,4]); ctx.stroke(); ctx.setLineDash([]);
    }
  }

  function showTooltip(idx) {
    const pt       = points[idx];
    const colorHex = idx === 0 ? '#8a6a78' : (pt.won ? 'var(--win)' : '#ff4757');
    let html = `<span style="font-family:'Bebas Neue',sans-serif;font-size:1.15rem;color:${colorHex}">${Math.round(pt.rating)}</span>`;
    if (idx === 0) {
      html += `<br><span style="color:#8a6a78">Starting rating</span>`;
    } else {
      const d       = new Date(pt.date);
      const dStr    = pt.rating - points[idx-1].rating;
      const dFmt    = (dStr >= 0 ? '+' : '') + Math.round(dStr);
      const dateStr = d.toLocaleDateString('en-US', { month:'short', day:'numeric' });
      html += `<br><span style="color:${colorHex}">${pt.won ? 'WIN' : 'LOSS'}</span> vs ${esc(pt.label)}`;
      html += `<br><span style="color:${colorHex}">${dFmt} pts</span> · ${dateStr}`;
    }
    tooltip.innerHTML     = html;
    tooltip.style.display = 'block';
    tooltip.style.left    = '-9999px';
    tooltip.style.top     = '-9999px';
    requestAnimationFrame(() => {
      const dotX = xOf(idx), dotY = yOf(pt.rating);
      const tipW = tooltip.offsetWidth, tipH = tooltip.offsetHeight;
      let left = Math.max(PAD.left, Math.min(dotX - tipW / 2, W - PAD.right - tipW));
      let top  = dotY - tipH - 10;
      if (top < PAD.top) top = dotY + 14;
      tooltip.style.left = left + 'px';
      tooltip.style.top  = top  + 'px';
    });
  }

  redraw(-1);
  let curHl = -1;

  function getNearestIdx(canvasX) {
    let best = -1, bestD = Infinity;
    for (let i = 0; i < points.length; i++) {
      const d = Math.abs(xOf(i) - canvasX);
      if (d < bestD) { bestD = d; best = i; }
    }
    return bestD < 36 ? best : -1;
  }

  function onMove(e) {
    const rect    = canvas.getBoundingClientRect();
    const clientX = e.touches ? e.touches[0].clientX : e.clientX;
    const cx      = (clientX - rect.left) * (canvas.width / rect.width);
    const idx     = getNearestIdx(cx);
    if (idx !== curHl) {
      curHl = idx; redraw(idx);
      if (idx >= 0) showTooltip(idx); else tooltip.style.display = 'none';
    }
  }
  function onLeave() { curHl = -1; redraw(-1); tooltip.style.display = 'none'; }

  newOuter.addEventListener('mousemove', onMove);
  newOuter.addEventListener('mouseleave', onLeave);
  newOuter.addEventListener('touchmove', onMove, { passive: true });
  newOuter.addEventListener('touchend', onLeave);
}

window.closeProfile = function(e) {
  if (e.target === document.getElementById('profile-overlay'))
    document.getElementById('profile-overlay').classList.remove('open');
};

document.addEventListener('keydown', e => {
  if (e.key === 'Escape') document.getElementById('profile-overlay').classList.remove('open');
});
</script>
</body>
</html>