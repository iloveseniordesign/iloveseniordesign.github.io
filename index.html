<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>TTTIW</title>
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0idXRmLTgiPz4KPHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHZpZXdCb3g9Ii0xIDE1IDY1IDQwIj4KICA8ZyBmaWxsPSIjRTVCMjVEIiB0cmFuc2Zvcm09Im1hdHJpeCgwLjY3NDY1LCAwLCAwLCAwLjY3NDY1LCAwLCAxNykiPgogICAgPHBhdGggZD0iTTAsNTEuMTdsNTkuMjkuMzRMMjkuOTQsMCwwLDUxLjE3Wk0xMC41Nyw0NS4xNkwyOS44NywxMi4xNmwxOC45MiwzMy4yMS0zOC4yMi0uMjJaIi8+CiAgICA8cGF0aCBkPSJNNTYuNDMsNDkuODRsLTUzLjU2LS4zMUwyOS45MiwzLjMxbDI2LjUyLDQ2LjU0Wk00LjYxLDQ4LjU0bDUwLjA5LjI5TDI5LjkxLDUuMzEsNC42MSw0OC41NFpNNTMuMzgsNDguMDZsLTQ3LjQyLS4yN0wyOS45LDYuODVsMjMuNDgsNDEuMlpNNy42OSw0Ni43OWw0My45Ni4yNUwyOS44OSw4Ljg1LDcuNjksNDYuNzlaIi8+CiAgPC9nPgogIDxnPgogICAgPGcgZmlsbD0iI0U1QjI1RCIgdHJhbnNmb3JtPSJtYXRyaXgoMC41MDAyLCAwLCAwLCAwLjUwMDIsIDUuMjQ0MzM3LCAxNi4xNTk2NjIpIiBzdHlsZT0iIj4KICAgICAgPHBhdGggZD0iTTg1LjgzLDEuNjhoLS4yYy0xMy43NSwwLTI0Ljk1LDExLjE3LTI0Ljk5LDI0LjkyLS4wNCwxMy43OCwxMS4xNCwyNS4wMiwyNC45MywyNS4wNmguMmMxMy43NSwwLDI0Ljk1LTExLjE3LDI0Ljk5LTI0LjkyLjA0LTEzLjc4LTExLjE0LTI1LjAyLTI0LjkzLTI1LjA2Wk04Mi40OSw4LjA2bC0uMDksMTUuNDEtMTUuMy0uMDljLjY2LTMuNzksMi40Ni03LjI5LDUuMjMtMTAuMDcsMi44LTIuOCw2LjMzLTQuNiwxMC4xNi01LjI1Wk04Mi4zNiwyOS41NGwtLjA5LDE1LjcxYy0zLjc3LS43LTcuMy0yLjUzLTEwLjAxLTUuMjktMi44Ni0yLjg5LTQuNjUtNi41Ni01LjI0LTEwLjUxbDE1LjM0LjA5Wk04OC4zNSw0NS4zN2wuMDktMTUuNzksMTUuOTEuMDljLTEuMzIsOC4xMi03LjgzLDE0LjU0LTE2LDE1LjdaTTg4LjQ4LDIzLjVsLjA5LTE1LjQ5YzguMDUsMS4yNCwxNC40Myw3LjU3LDE1Ljc3LDE1LjU4bC0xNS44Ni0uMDlaIi8+CiAgICA8L2c+CiAgICA8cmVjdCBzdHlsZT0iZmlsbDogcmdiKDIyOSwgMTc4LCA5Myk7IHRyYW5zZm9ybS1ib3g6IGZpbGwtYm94OyB0cmFuc2Zvcm0tb3JpZ2luOiA1MCUgNTAlOyIgdHJhbnNmb3JtPSJtYXRyaXgoMC44NjYwMjYsIC0wLjUsIDAuNSwgMC44NjYwMjYsIC0xMC4yMDcxODMsIC0xMS44NjcyMjQpIiB4PSI2NC40MDQiIHk9IjQ5LjUxMiIgd2lkdGg9IjUiIGhlaWdodD0iMTQiIHJ4PSIxIiByeT0iMSIvPgogIDwvZz4KICA8cGF0aCBzdHlsZT0iZmlsbDogcmdiKDIyOSwgMTc4LCA5Myk7IiBkPSJNIDQ4LjU4NCA0MS45MzcgQyA1MS41OTUgNDIuMDAzIDUyLjQ4OSA0Mi43MiA1NC4wODkgNDUuMTU3IEwgNTguMzk2IDQyLjUzNCBDIDU3LjI0NyA0MC4wMTEgNTcuMjMzIDM4LjczNiA1OC44NDEgMzUuOTc5IEMgNTUuNzI5IDM3LjI4MiA0OC41NjkgNDEuOTUgNDguNTg0IDQxLjkzNyBaIi8+Cjwvc3ZnPg==">
<link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=DM+Mono:wght@300;400;500&family=DM+Sans:wght@300;400;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#1e1018; --surface:#2a1520; --border:#4a2a38;
  --accent:#E5B25D; --accent3:#c9a0dc;
  --text:#E1E2EF; --muted:#8a6a78;
  --win:#7ec8a0; --loss:#d9534f; --admin:#c9a0dc;
}
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0;}
html,body{width:100%;overflow-x:hidden;}
body{background:var(--bg);color:var(--text);font-family:'DM Sans',sans-serif;min-height:100vh;}
body::before{content:'';position:fixed;top:-50%;left:-50%;width:200%;height:200%;
  background:radial-gradient(ellipse at 30% 20%,rgba(229,178,93,.06) 0%,transparent 50%),
             radial-gradient(ellipse at 70% 80%,rgba(53,30,41,.8) 0%,transparent 50%);
  pointer-events:none;z-index:0;}

/* HEADER */
header{width:100%;padding:.9rem 1.25rem;border-bottom:1px solid var(--border);
  display:flex;align-items:center;gap:.75rem;position:relative;z-index:10;}
.header-logo{display:flex;align-items:center;gap:.6rem;flex-shrink:0;}
header h1{font-family:'Bebas Neue',sans-serif;font-size:2rem;letter-spacing:.08em;color:var(--accent);line-height:1;}
.header-sub{font-family:'DM Mono',monospace;font-size:.58rem;color:var(--muted);letter-spacing:.1em;text-transform:uppercase;}
.header-right{margin-left:auto;display:flex;align-items:center;gap:.6rem;flex-shrink:0;}
#decay-status{font-size:.55rem;color:var(--muted);font-family:'DM Mono',monospace;letter-spacing:.07em;white-space:nowrap;}

/* ADMIN BTN */
#admin-btn{background:none;border:1px solid var(--border);color:var(--muted);
  font-family:'DM Mono',monospace;font-size:.58rem;letter-spacing:.08em;text-transform:uppercase;
  padding:.35rem .65rem;cursor:pointer;transition:all .2s;white-space:nowrap;}
#admin-btn:hover{border-color:var(--admin);color:var(--admin);}
#admin-btn.on{border-color:var(--admin);color:var(--admin);background:rgba(201,160,220,.1);}

/* NAV */
nav{width:100%;border-bottom:1px solid var(--border);position:relative;z-index:9;
  display:flex;overflow-x:auto;overflow-y:hidden;-webkit-overflow-scrolling:touch;scrollbar-width:none;}
nav::-webkit-scrollbar{display:none;}
nav button{background:none;border:none;color:var(--muted);font-family:'DM Mono',monospace;
  font-size:.68rem;letter-spacing:.07em;text-transform:uppercase;padding:.8rem 1rem;
  cursor:pointer;border-bottom:2px solid transparent;transition:all .2s;white-space:nowrap;flex-shrink:0;}
nav button.active{color:var(--accent);border-bottom-color:var(--accent);}
nav button.admin-tab{color:var(--admin);opacity:.5;}
nav button.admin-tab.active{color:var(--admin);border-bottom-color:var(--admin);opacity:1;}
nav button:hover:not(.active){color:var(--text);}

/* MAIN */
main{padding:1.25rem;position:relative;z-index:1;width:100%;}
.panel{display:none;}.panel.active{display:block;}

/* LEADERBOARD */
.lb-table{width:100%;border-collapse:collapse;}
.lb-table th{font-family:'DM Mono',monospace;font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;
  color:var(--muted);text-align:left;padding:.55rem .7rem;border-bottom:1px solid var(--border);}
.lb-table td{padding:.7rem;border-bottom:1px solid rgba(74,42,56,.5);vertical-align:middle;}
.lb-table tr:hover td{background:rgba(229,178,93,.04);}
.lb-table tbody tr{cursor:pointer;}
.rank{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;color:var(--muted);width:2.2rem;}
.rank.top1{color:var(--accent);}.rank.top2{color:#c0c0c0;}.rank.top3{color:#cd7f32;}
.lb-avatar{width:30px;height:30px;border-radius:50%;object-fit:cover;border:1px solid var(--border);background:var(--surface);flex-shrink:0;}
.lb-av-ph{width:30px;height:30px;border-radius:50%;background:var(--surface);border:1px solid var(--border);
  display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:.8rem;color:var(--muted);flex-shrink:0;}
.player-name{font-size:.9rem;font-weight:600;letter-spacing:.02em;}
.pname-cell{display:flex;align-items:center;gap:.55rem;}
.rating-val{font-family:'Bebas Neue',sans-serif;font-size:1.5rem;color:var(--accent);letter-spacing:.05em;}
.rd-val{font-family:'DM Mono',monospace;font-size:.72rem;color:var(--muted);}
.record-badge{font-family:'DM Mono',monospace;font-size:.62rem;display:inline-flex;gap:.35rem;}
.record-badge .w{color:var(--win);}.record-badge .l{color:var(--loss);}

/* FORMS */
.form-card{background:var(--surface);border:1px solid var(--border);padding:1.25rem;margin-bottom:1.25rem;width:100%;}
.form-card h2{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;letter-spacing:.08em;margin-bottom:1rem;color:var(--text);}
.field{margin-bottom:.9rem;}
label{display:block;font-family:'DM Mono',monospace;font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:.35rem;}
input,select,textarea{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--text);
  font-family:'DM Sans',sans-serif;font-size:.88rem;padding:.6rem .85rem;outline:none;
  transition:border-color .2s;appearance:none;border-radius:0;}
input:focus,select:focus,textarea:focus{border-color:var(--accent);}
input::placeholder,textarea::placeholder{color:var(--muted);}

.btn{background:var(--accent);color:#1e1018;border:none;font-family:'DM Mono',monospace;
  font-size:.68rem;letter-spacing:.1em;text-transform:uppercase;padding:.7rem 1.4rem;
  cursor:pointer;font-weight:500;transition:all .15s;display:inline-block;border-radius:0;}
.btn:hover{background:#f5e6cc;}.btn:disabled{opacity:.4;cursor:not-allowed;}
.btn-ghost{background:none;border:1px solid var(--border);color:var(--muted);
  font-family:'DM Mono',monospace;font-size:.62rem;letter-spacing:.07em;text-transform:uppercase;
  padding:.45rem .85rem;cursor:pointer;transition:all .15s;border-radius:0;}
.btn-ghost:hover{border-color:var(--text);color:var(--text);}
.btn-danger{background:var(--loss);color:#fff;border:none;font-family:'DM Mono',monospace;
  font-size:.58rem;letter-spacing:.07em;text-transform:uppercase;padding:.38rem .65rem;
  cursor:pointer;transition:opacity .15s;border-radius:0;}
.btn-danger:hover{opacity:.8;}
.btn-admin{background:rgba(201,160,220,.12);color:var(--admin);border:1px solid var(--admin);
  font-family:'DM Mono',monospace;font-size:.58rem;letter-spacing:.07em;text-transform:uppercase;
  padding:.38rem .65rem;cursor:pointer;transition:all .15s;border-radius:0;}
.btn-admin:hover{background:rgba(201,160,220,.22);}

.msg{font-family:'DM Mono',monospace;font-size:.68rem;padding:.6rem .85rem;margin-top:.65rem;
  border-left:3px solid var(--accent);background:rgba(229,178,93,.07);color:var(--accent);display:none;}
.msg.err{border-color:var(--loss);background:rgba(255,71,87,.05);color:var(--loss);}

/* HISTORY */
.hist-filters{display:flex;gap:.65rem;margin-bottom:1rem;flex-wrap:wrap;}
.hist-filters select{width:auto;min-width:150px;flex:1;}
.match-row{background:var(--surface);border:1px solid var(--border);padding:.75rem .9rem;
  margin-bottom:.35rem;display:grid;grid-template-columns:1fr auto 1fr;align-items:center;gap:.4rem;}
.match-player{display:flex;flex-direction:column;gap:.15rem;}
.match-player .name{font-weight:600;font-size:.82rem;}
.match-player .delta{font-family:'DM Mono',monospace;font-size:.62rem;}
.match-player .delta.pos{color:var(--win);}.match-player .delta.neg{color:var(--loss);}
.match-player .rdi{font-family:'DM Mono',monospace;font-size:.56rem;color:var(--muted);}
.match-mid{text-align:center;}
.match-result{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;color:var(--muted);letter-spacing:.07em;
  display:flex;align-items:center;gap:.3rem;justify-content:center;white-space:nowrap;}
.match-result .ws{color:var(--win);font-size:.8rem;}.match-result .ls{color:var(--loss);font-size:.8rem;}
.match-score-lbl{font-size:1.2rem;}
.match-date-lbl{font-family:'DM Mono',monospace;font-size:.55rem;color:var(--muted);margin-top:.2rem;}

.empty{font-family:'DM Mono',monospace;font-size:.72rem;color:var(--muted);text-align:center;padding:2.5rem 1rem;border:1px dashed var(--border);}
.loading{font-family:'DM Mono',monospace;font-size:.72rem;color:var(--muted);text-align:center;padding:2.5rem;letter-spacing:.1em;}
.loading::after{content:'';display:inline-block;width:10px;height:10px;border:2px solid var(--border);
  border-top-color:var(--accent);border-radius:50%;margin-left:8px;vertical-align:middle;animation:spin .7s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* PLAYER CARDS */
.cards-label{font-family:'DM Mono',monospace;font-size:.58rem;letter-spacing:.1em;color:var(--muted);margin-bottom:.65rem;}
.cards-grid{display:grid;grid-template-columns:repeat(auto-fill,minmax(220px,1fr));gap:.65rem;}
.player-card{background:var(--surface);border:1px solid var(--border);padding:.9rem;cursor:pointer;
  transition:border-color .2s,transform .15s;display:flex;flex-direction:column;gap:.65rem;}
.player-card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 4px 18px rgba(229,178,93,.1);}
.pc-header{display:flex;align-items:center;gap:.65rem;}
.pc-avatar{width:42px;height:42px;border-radius:50%;object-fit:cover;border:2px solid var(--border);background:var(--bg);flex-shrink:0;}
.pc-av-ph{width:42px;height:42px;border-radius:50%;background:var(--bg);border:2px solid var(--border);
  display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:1rem;color:var(--muted);flex-shrink:0;}
.pc-name-block{min-width:0;}
.pc-name{font-weight:600;font-size:.9rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.pc-tag{font-family:'DM Mono',monospace;font-size:.48rem;letter-spacing:.07em;color:var(--loss);
  border:1px solid var(--loss);padding:.08rem .28rem;display:inline-block;margin-top:.12rem;}
.pc-stats{display:grid;grid-template-columns:1fr 1fr;gap:.45rem .65rem;}
.pc-stat{display:flex;flex-direction:column;gap:.08rem;}
.pc-stat-l{font-family:'DM Mono',monospace;font-size:.5rem;letter-spacing:.07em;text-transform:uppercase;color:var(--muted);}
.pc-stat-v{font-family:'Bebas Neue',sans-serif;font-size:1.1rem;line-height:1;}
.pc-foot{display:flex;align-items:center;justify-content:space-between;padding-top:.6rem;border-top:1px solid var(--border);}
.pc-hint{font-family:'DM Mono',monospace;font-size:.5rem;color:var(--muted);letter-spacing:.06em;}

/* SEASON BADGES */
.season-badges{display:flex;flex-wrap:wrap;gap:.3rem;margin-top:.35rem;}
.s-badge{font-family:'Bebas Neue',sans-serif;font-size:.7rem;letter-spacing:.06em;padding:.18rem .45rem;border-radius:2px;display:inline-flex;align-items:center;gap:.25rem;line-height:1;}
.s-badge.rank1{background:linear-gradient(135deg,#b8860b,#ffd700,#b8860b);color:#1a1000;box-shadow:0 1px 6px rgba(255,215,0,.35);}
.s-badge.rank2{background:linear-gradient(135deg,#666,#c0c0c0,#666);color:#0a0a0a;}
.s-badge.rank3{background:linear-gradient(135deg,#7a4a1e,#cd7f32,#7a4a1e);color:#1a0800;}
.s-badge.rankN{background:var(--surface);color:var(--muted);border:1px solid var(--border);}
.s-history-wrap{border-top:1px solid var(--border);padding-top:.6rem;margin-top:.1rem;}
.s-history-select{width:100%;background:var(--bg);border:1px solid var(--border);color:var(--muted);
  font-family:'DM Mono',monospace;font-size:.58rem;padding:.35rem .6rem;cursor:pointer;border-radius:0;appearance:none;}
.s-history-select:focus{border-color:var(--accent);outline:none;}
.s-history-data{font-family:'DM Mono',monospace;font-size:.62rem;color:var(--muted);line-height:1.7;margin-top:.4rem;padding:.5rem .65rem;background:rgba(0,0,0,.2);border:1px solid var(--border);}
.s-history-data strong{color:var(--text);}

/* SEASON COUNTDOWN in header */
#season-countdown{font-size:.55rem;color:var(--accent);font-family:'DM Mono',monospace;letter-spacing:.07em;white-space:nowrap;border:1px solid rgba(229,178,93,.3);padding:.25rem .5rem;}
#season-countdown.urgent{color:var(--loss);border-color:rgba(217,83,79,.4);animation:pulse 1.5s ease-in-out infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.6;}}

/* RULES */
.rules-wrap{max-width:580px;}
.rules-list{display:flex;flex-direction:column;}
.rule-item{display:flex;align-items:flex-start;gap:.9rem;padding:.9rem 0;border-bottom:1px solid var(--border);}
.rule-item:last-child{border-bottom:none;}
.rule-icon{font-family:'Bebas Neue',sans-serif;font-size:1rem;color:var(--accent);min-width:1.8rem;text-align:center;padding-top:.1rem;flex-shrink:0;}
.rule-title{font-weight:600;font-size:.88rem;color:var(--text);margin-bottom:.22rem;}
.rule-desc{font-family:'DM Mono',monospace;font-size:.65rem;color:var(--muted);line-height:1.6;}

/* PROFILE MODAL */
.modal-overlay{display:none;position:fixed;inset:0;background:rgba(5,5,10,.88);
  backdrop-filter:blur(6px);z-index:200;align-items:center;justify-content:center;padding:.75rem;}
.modal-overlay.open{display:flex;}
.modal{background:var(--surface);border:1px solid var(--border);width:100%;max-width:800px;
  max-height:92vh;overflow-y:auto;animation:mIn .2s ease;}
@keyframes mIn{from{opacity:0;transform:translateY(12px);}to{opacity:1;transform:translateY(0);}}
.modal-header{padding:1.25rem;border-bottom:1px solid var(--border);display:flex;align-items:flex-start;justify-content:space-between;gap:.75rem;}
.mh-left{display:flex;gap:.85rem;align-items:flex-start;flex:1;min-width:0;}
.m-av-wrap{position:relative;flex-shrink:0;}
.m-avatar{width:60px;height:60px;border-radius:50%;object-fit:cover;border:2px solid var(--border);display:block;}
.m-av-ph{width:60px;height:60px;border-radius:50%;background:var(--bg);border:2px solid var(--border);
  display:flex;align-items:center;justify-content:center;font-family:'Bebas Neue',sans-serif;font-size:1.3rem;color:var(--muted);}
.m-av-upload{position:absolute;bottom:-2px;right:-2px;width:20px;height:20px;background:var(--accent);
  border-radius:50%;display:flex;align-items:center;justify-content:center;cursor:pointer;
  font-size:.7rem;color:#1e1018;border:2px solid var(--surface);font-weight:700;line-height:1;}
.m-av-upload:hover{background:#f5e6cc;}
.m-av-input{display:none;}
.m-player-info{flex:1;min-width:0;}
.m-player-name{font-family:'Bebas Neue',sans-serif;font-size:1.9rem;letter-spacing:.06em;color:var(--text);line-height:1;word-break:break-word;}
.m-stats{display:flex;gap:1rem;flex-wrap:wrap;margin-top:.4rem;}
.m-stat{display:flex;flex-direction:column;gap:.12rem;}
.m-stat-l{font-family:'DM Mono',monospace;font-size:.52rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);}
.m-stat-v{font-family:'Bebas Neue',sans-serif;font-size:1.3rem;color:var(--accent);line-height:1;}
.m-stat-v.neutral{color:var(--text);}.m-stat-v.green{color:var(--win);}.m-stat-v.red{color:var(--loss);}
.m-close{background:none;border:1px solid var(--border);color:var(--muted);font-family:'DM Mono',monospace;
  font-size:.62rem;letter-spacing:.07em;padding:.35rem .65rem;cursor:pointer;flex-shrink:0;transition:all .15s;}
.m-close:hover{border-color:var(--text);color:var(--text);}
.modal-body{padding:1.25rem;}
.m-quote{font-family:'DM Mono',monospace;font-size:.68rem;color:var(--muted);font-style:italic;margin-top:.4rem;line-height:1.6;}
.m-quote .qa{color:var(--accent);font-style:normal;}
.quote-row{display:flex;gap:.4rem;margin-top:.45rem;}
.quote-row input{font-size:.72rem;padding:.38rem .6rem;}
.quote-row .btn{padding:.38rem .65rem;font-size:.56rem;}
.upload-prog{font-family:'DM Mono',monospace;font-size:.6rem;color:var(--accent);margin-top:.4rem;display:none;}

/* CHART */
.chart-section{margin-bottom:1.4rem;}
.chart-lbl{font-family:'DM Mono',monospace;font-size:.58rem;letter-spacing:.1em;text-transform:uppercase;color:var(--muted);margin-bottom:.65rem;}
.chart-outer{border:1px solid var(--border);background:var(--bg);overflow-x:auto;overflow-y:hidden;position:relative;height:175px;cursor:crosshair;}
.chart-outer::-webkit-scrollbar{height:3px;}.chart-outer::-webkit-scrollbar-track{background:var(--bg);}.chart-outer::-webkit-scrollbar-thumb{background:var(--border);}
.chart-wrap{position:relative;display:inline-block;min-width:100%;}
.chart-tip{position:absolute;background:var(--surface);border:1px solid var(--border);padding:.38rem .65rem;
  font-family:'DM Mono',monospace;font-size:.62rem;color:var(--text);pointer-events:none;
  z-index:20;display:none;line-height:1.6;white-space:nowrap;box-shadow:0 4px 14px rgba(0,0,0,.5);}

/* PROFILE MATCHES */
.pm-row{display:grid;grid-template-columns:auto 1fr auto;align-items:center;gap:.65rem;
  padding:.65rem 0;border-bottom:1px solid rgba(74,42,56,.6);}
.pm-row:last-child{border-bottom:none;}
.pm-badge{font-family:'Bebas Neue',sans-serif;font-size:.82rem;width:2.7rem;text-align:center;padding:.22rem 0;letter-spacing:.05em;}
.pm-badge.win{color:var(--win);background:rgba(71,255,184,.08);}
.pm-badge.loss{color:var(--loss);background:rgba(255,71,87,.08);}
.pm-info{display:flex;flex-direction:column;gap:.12rem;min-width:0;}
.pm-opp{font-weight:600;font-size:.82rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}
.pm-date{font-family:'DM Mono',monospace;font-size:.58rem;color:var(--muted);}
.pm-delta{font-family:'DM Mono',monospace;font-size:.75rem;text-align:right;white-space:nowrap;}
.pm-delta.pos{color:var(--win);}.pm-delta.neg{color:var(--loss);}

/* ADMIN PANEL */
.admin-section{margin-bottom:1.75rem;}
.admin-stitle{font-family:'Bebas Neue',sans-serif;font-size:1.2rem;letter-spacing:.08em;color:var(--admin);
  margin-bottom:.85rem;padding-bottom:.45rem;border-bottom:1px solid rgba(201,160,220,.2);}
.admin-prow{display:flex;align-items:center;gap:.65rem;padding:.65rem;background:var(--surface);
  border:1px solid var(--border);margin-bottom:.35rem;flex-wrap:wrap;}
.admin-prow:hover{border-color:var(--admin);}
.admin-pname{flex:1;font-weight:600;font-size:.88rem;min-width:80px;}
.admin-prating{font-family:'DM Mono',monospace;font-size:.7rem;color:var(--muted);}
.admin-mrow{display:flex;align-items:center;gap:.65rem;padding:.6rem .7rem;background:var(--surface);
  border:1px solid var(--border);margin-bottom:.35rem;flex-wrap:wrap;}
.admin-mrow:hover{border-color:var(--loss);}
.admin-minfo{flex:1;font-family:'DM Mono',monospace;font-size:.65rem;color:var(--muted);line-height:1.5;}
.admin-minfo strong{color:var(--text);font-family:'DM Sans',sans-serif;font-size:.82rem;}

/* ADMIN LOGIN / EDIT MODALS */
.am-overlay{display:none;position:fixed;inset:0;background:rgba(5,5,10,.92);z-index:300;align-items:center;justify-content:center;padding:.75rem;}
.am-overlay.open{display:flex;}
.am-box{background:var(--surface);border:1px solid var(--admin);padding:1.75rem;width:100%;max-width:350px;animation:mIn .2s ease;}
.am-box h2{font-family:'Bebas Neue',sans-serif;font-size:1.4rem;letter-spacing:.08em;color:var(--admin);margin-bottom:1.1rem;}

/* QUOTES */
.lb-quote{font-family:'DM Mono',monospace;font-size:.78rem;color:var(--muted);font-style:italic;
  margin-bottom:1.1rem;text-align:center;letter-spacing:.02em;line-height:1.6;opacity:.7;}
.lb-quote .qa{color:var(--muted);font-style:normal;opacity:.8;}

/* SCROLLBARS */
::-webkit-scrollbar{width:5px;height:5px;}
::-webkit-scrollbar-track{background:var(--bg);}
::-webkit-scrollbar-thumb{background:var(--border);}
::-webkit-scrollbar-thumb:hover{background:var(--muted);}
*{scrollbar-width:thin;scrollbar-color:var(--border) var(--bg);}

/* RESPONSIVE */
@media(min-width:480px){
  header{padding:1.1rem 1.75rem;}
  header h1{font-size:2.6rem;}
  main{padding:1.5rem 1.75rem;}
}
@media(min-width:640px){
  header{padding:1.2rem 2rem;}
  header h1{font-size:3rem;}
  nav{padding:0 2rem;}
  main{padding:1.75rem 2rem;}
  .match-row{grid-template-columns:1fr auto 1fr auto;}
  .match-meta-col{display:block;text-align:right;font-family:'DM Mono',monospace;font-size:.58rem;color:var(--muted);line-height:1.6;}
  .match-date-lbl{display:none;}
}
@media(min-width:900px){
  .players-layout{display:grid;grid-template-columns:360px 1fr;gap:1.5rem;align-items:start;}
  .players-sidebar-mobile{display:none;}
  #players-list-desktop{display:block;}
}
@media(max-width:899px){
  #players-list-desktop{display:none;}
  .players-sidebar-mobile{display:block;}
}
.match-meta-col{display:none;}
</style>
</head>
<body>

<header>
  <div class="header-logo">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="-1 15 65 40" style="height:32px;width:auto;flex-shrink:0">
      <g fill="#E5B25D" transform="matrix(0.67465,0,0,0.67465,0,17)">
        <path d="M0,51.17l59.29.34L29.94,0,0,51.17ZM10.57,45.16L29.87,12.16l18.92,33.21-38.22-.22Z"/>
        <path d="M56.43,49.84l-53.56-.31L29.92,3.31l26.52,46.54ZM4.61,48.54l50.09.29L29.91,5.31,4.61,48.54ZM53.38,48.06l-47.42-.27L29.9,6.85l23.48,41.2ZM7.69,46.79l43.96.25L29.89,8.85,7.69,46.79Z"/>
      </g>
      <g><g fill="#E5B25D" transform="matrix(0.5002,0,0,0.5002,5.244337,16.159662)">
        <path d="M85.83,1.68h-.2c-13.75,0-24.95,11.17-24.99,24.92-.04,13.78,11.14,25.02,24.93,25.06h.2c13.75,0,24.95-11.17,24.99-24.92.04-13.78-11.14-25.02-24.93-25.06ZM82.49,8.06l-.09,15.41-15.3-.09c.66-3.79,2.46-7.29,5.23-10.07,2.8-2.8,6.33-4.6,10.16-5.25ZM82.36,29.54l-.09,15.71c-3.77-.7-7.3-2.53-10.01-5.29-2.86-2.89-4.65-6.56-5.24-10.51l15.34.09ZM88.35,45.37l.09-15.79,15.91.09c-1.32,8.12-7.83,14.54-16,15.7ZM88.48,23.5l.09-15.49c8.05,1.24,14.43,7.57,15.77,15.58l-15.86-.09Z"/>
      </g>
      <rect style="fill:rgb(229,178,93);transform-box:fill-box;transform-origin:50% 50%;" transform="matrix(0.866026,-0.5,0.5,0.866026,-10.207183,-11.867224)" x="64.404" y="49.512" width="5" height="14" rx="1" ry="1"/>
      </g>
      <path style="fill:rgb(229,178,93);" d="M48.584,41.937C51.595,42.003,52.489,42.72,54.089,45.157L58.396,42.534C57.247,40.011,57.233,38.736,58.841,35.979C55.729,37.282,48.569,41.95,48.584,41.937Z"/>
    </svg>
    <h1>TTTIW</h1>
  </div>
  <span class="header-sub" style="display:none" id="header-sub-text">Table Tennis Â· Texas Invention<span style="color:var(--accent)">Works</span></span>
  <div class="header-right">
    <span id="decay-status"></span>
    <span id="season-countdown" style="display:none"></span>
    <button id="admin-btn" onclick="openAdminLogin()">âš™ Admin</button>
  </div>
</header>

<nav>
  <button class="active" onclick="showPanel('leaderboard',this)">Leaderboard</button>
  <button onclick="showPanel('players',this)">Players</button>
  <button onclick="showPanel('match',this)">Submit Match</button>
  <button onclick="showPanel('history',this)">Match History</button>
  <button onclick="showPanel('rules',this)">Rules</button>
  <button id="admin-tab-btn" class="admin-tab" onclick="showPanel('admin',this)" style="display:none">â˜… Admin</button>
</nav>

<main>
  <!-- LEADERBOARD -->
  <div id="panel-leaderboard" class="panel active">
    <div id="lb-loading" class="loading">Loading leaderboard</div>
    <table class="lb-table" id="lb-table" style="display:none">
      <thead><tr><th>#</th><th>Player</th><th>Rating</th><th>RD</th><th>Wâ€“L</th></tr></thead>
      <tbody id="lb-body"></tbody>
    </table>
    <div id="lb-empty" class="empty" style="display:none">No players yet.</div>
  </div>

  <!-- PLAYERS -->
  <div id="panel-players" class="panel">
    <div class="players-layout">
      <div class="players-sidebar">
        <div class="form-card">
          <h2>Add Player</h2>
          <div class="field"><label>Player Name</label><input type="text" id="player-name" placeholder="Enter nameâ€¦"></div>
          <button class="btn" id="add-player-btn" onclick="addPlayer()">Add Player</button>
          <div class="msg" id="player-msg"></div>
          <p style="font-family:'DM Mono',monospace;font-size:.58rem;color:var(--muted);margin-top:.65rem;line-height:1.7">
            New players start at <span style="color:var(--accent)">1500</span> Â· RD <span style="color:var(--accent)">120</span>.<br>
            Tap any player card to add a profile photo &amp; quote.
          </p>
        </div>
        <!-- Mobile cards -->
        <div class="players-sidebar-mobile" id="players-list-mobile"></div>
      </div>
      <!-- Desktop cards -->
      <div id="players-list-desktop"></div>
    </div>
  </div>

  <!-- SUBMIT MATCH -->
  <div id="panel-match" class="panel">
    <div style="max-width:460px">
      <div class="form-card">
        <h2>Submit Match Result</h2>
        <div class="field"><label>Winner</label><select id="match-winner"></select></div>
        <div class="field"><label>Loser</label><select id="match-loser"></select></div>
        <div class="field"><label>Score (optional)</label><input type="text" id="match-score" placeholder="e.g. 11-7"></div>
        <button class="btn" id="submit-match-btn" onclick="submitMatch()">Submit Match</button>
        <div class="msg" id="match-msg"></div>
      </div>
    </div>
  </div>

  <!-- HISTORY -->
  <div id="panel-history" class="panel">
    <div class="hist-filters">
      <select id="history-filter" onchange="renderHistory()"><option value="all">All Players</option></select>
    </div>
    <div id="history-list"><div class="loading">Loading matches</div></div>
  </div>

  <!-- RULES -->
  <div id="panel-rules" class="panel">
    <div class="rules-wrap">
      <div style="font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:.08em;color:var(--text);margin-bottom:1.1rem">House Rules</div>
      <div class="rules-list">
        <div class="rule-item"><div class="rule-icon">11</div><div><div class="rule-title">First to 11</div><div class="rule-desc">Win by reaching 11 points with a 2-point lead.</div></div></div>
        <div class="rule-item"><div class="rule-icon">2Ã—</div><div><div class="rule-title">2 Serves Each</div><div class="rule-desc">Players alternate with 2 serves per turn.</div></div></div>
        <div class="rule-item"><div class="rule-icon">âˆž</div><div><div class="rule-title">Deuce Serving</div><div class="rule-desc">At 10â€“10 (deuce), alternate serves every point.</div></div></div>
        <div class="rule-item"><div class="rule-icon">6â€³</div><div><div class="rule-title">Serve Height</div><div class="rule-desc">Ball must be struck 6 inches above the table surface.</div></div></div>
        <div class="rule-item"><div class="rule-icon">âš–</div><div><div class="rule-title">Fairness Rule</div><div class="rule-desc">Beating stronger players gains more rating points.</div></div></div>
      </div>
      <div style="font-family:'Bebas Neue',sans-serif;font-size:1.5rem;letter-spacing:.08em;color:var(--text);margin:1.75rem 0 1.1rem">Rating System</div>
      <div class="rules-list">
        <div class="rule-item"><div class="rule-icon" style="font-size:.8rem">RD</div><div><div class="rule-title">Rating Deviation</div><div class="rule-desc">RD measures confidence in a player's rating. High RD = fewer matches played, less certainty. New players start at RD 120. RD increases over inactivity. Players with RD&gt;100 are hidden from the leaderboard.</div></div></div>
        <div class="rule-item"><div class="rule-icon" style="font-size:.8rem">G2</div><div><div class="rule-title">Glicko-2 Algorithm</div><div class="rule-desc">Uses Glicko-2, an improvement on ELO. Every match updates both players' ratings based on expected outcome â€” upsets gain more, expected wins gain less. Starting rating: 1500.</div></div></div>
      </div>
    </div>
  </div>

  <!-- ADMIN -->
  <div id="panel-admin" class="panel">
    <div style="max-width:820px">
      <div class="admin-section">
        <div class="admin-stitle">Season Settings</div>
        <div class="form-card" style="border-color:rgba(201,160,220,.3);max-width:480px">
          <p style="font-family:'DM Mono',monospace;font-size:.65rem;color:var(--muted);margin-bottom:.9rem;line-height:1.6">Set a season end date. When the deadline passes, you can trigger a season reset â€” all ratings return to 1500, RD to 120, wins/losses to 0, and a snapshot of final rankings is saved to each player's history.</p>
          <div class="field">
            <label>Season Name</label>
            <input type="text" id="season-name-input" placeholder="e.g. Spring 2025">
          </div>
          <div class="field">
            <label>Season End Date</label>
            <input type="datetime-local" id="season-deadline-input">
          </div>
          <div style="display:flex;gap:.6rem;flex-wrap:wrap">
            <button class="btn" onclick="saveSeason()">Save Season Deadline</button>
            <button class="btn-danger" id="reset-season-btn" onclick="triggerSeasonReset()" style="padding:.7rem 1.2rem;font-size:.65rem">âš¡ Reset Season Now</button>
          </div>
          <div class="msg" id="season-msg"></div>
          <div id="season-status-admin" style="font-family:'DM Mono',monospace;font-size:.62rem;color:var(--muted);margin-top:.75rem;line-height:1.7;display:none"></div>
        </div>
      </div>
      <div class="admin-section">
        <div class="admin-stitle">RD Decay Settings</div>
        <div class="form-card" style="border-color:rgba(201,160,220,.15);max-width:480px">
          <p style="font-family:'DM Mono',monospace;font-size:.65rem;color:var(--muted);margin-bottom:.9rem;line-height:1.6">RD increases each inactive period using the Glicko-2 formula <strong style="color:var(--text)">Ï†* = âˆš(Ï†Â² + ÏƒÂ²)</strong>. Default: 7 days Â· Max RD: 200 Â· Hidden from leaderboard if RD &gt; 100.</p>
          <div id="decay-info" style="font-family:'DM Mono',monospace;font-size:.62rem;color:var(--muted);line-height:1.8;padding:.6rem .8rem;background:rgba(0,0,0,.2);border:1px solid var(--border)">
            Loading current settingsâ€¦
          </div>
        </div>
        <!-- hidden inputs keep the decay logic working -->
        <input type="hidden" id="decay-amount" value="7">
        <input type="hidden" id="decay-unit" value="days">
      </div>
      <div class="admin-section">
        <div class="admin-stitle">Manage Players</div>
        <div id="admin-players-list"><div class="loading">Loading</div></div>
      </div>
      <div class="admin-section">
        <div class="admin-stitle">Match Log (Delete Matches)</div>
        <p style="font-family:'DM Mono',monospace;font-size:.62rem;color:var(--muted);margin-bottom:.75rem;line-height:1.5">âš  Deleting a match does NOT recalculate ratings. Use with caution.</p>
        <div id="admin-matches-list"><div class="loading">Loading</div></div>
      </div>
    </div>
  </div>
</main>

<!-- PROFILE MODAL -->
<div class="modal-overlay" id="profile-overlay" onclick="closeProfile(event)">
  <div class="modal">
    <div class="modal-header">
      <div class="mh-left">
        <div class="m-av-wrap" id="m-av-wrap">
          <div class="m-av-ph" id="m-av-ph">?</div>
          <label class="m-av-upload" title="Upload photo">+<input type="file" class="m-av-input" id="m-av-input" accept="image/*"></label>
        </div>
        <div class="m-player-info">
          <div class="m-player-name" id="profile-name">â€”</div>
          <div class="m-stats" id="profile-stats"></div>
          <div class="m-quote" id="profile-quote" style="display:none"></div>
          <div class="quote-row">
            <input type="text" id="quote-input-modal" placeholder='"A memorable quoteâ€¦"'>
            <button class="btn" onclick="saveQuoteModal()">Save</button>
          </div>
          <div class="msg" id="quote-msg-modal" style="margin-top:.35rem;padding:.3rem .6rem;font-size:.58rem"></div>
          <div class="upload-prog" id="upload-prog">Uploadingâ€¦</div>
        </div>
      </div>
      <button class="m-close" onclick="document.getElementById('profile-overlay').classList.remove('open')">âœ•</button>
    </div>
    <div class="modal-body">
      <div class="chart-section">
        <div class="chart-lbl">Rating History</div>
        <div class="chart-outer" id="chart-outer">
          <div class="chart-wrap" id="chart-wrap">
            <canvas id="rating-chart"></canvas>
            <div class="chart-tip" id="chart-tip"></div>
          </div>
        </div>
      </div>
      <div class="chart-lbl" style="margin-bottom:.65rem">Match History</div>
      <div id="profile-matches"></div>
    </div>
  </div>
</div>

<!-- ADMIN LOGIN MODAL -->
<div class="am-overlay" id="admin-login-overlay" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="am-box">
    <h2>Admin Login</h2>
    <div class="field"><label>Password</label>
      <input type="password" id="admin-pw" placeholder="Enter passwordâ€¦" onkeydown="if(event.key==='Enter')submitAdminLogin()">
    </div>
    <div style="display:flex;gap:.65rem">
      <button class="btn" onclick="submitAdminLogin()">Login</button>
      <button class="btn-ghost" onclick="document.getElementById('admin-login-overlay').classList.remove('open')">Cancel</button>
    </div>
    <div class="msg" id="admin-login-msg" style="margin-top:.65rem"></div>
  </div>
</div>

<!-- EDIT PLAYER MODAL -->
<div class="am-overlay" id="admin-edit-overlay" onclick="if(event.target===this)this.classList.remove('open')">
  <div class="am-box">
    <h2>Edit Player Stats</h2>
    <input type="hidden" id="edit-pid">
    <div class="field"><label>Rating</label><input type="number" id="edit-rating" step="0.1"></div>
    <div class="field"><label>RD</label><input type="number" id="edit-rd" step="0.1"></div>
    <div class="field"><label>Wins</label><input type="number" id="edit-wins" step="1" min="0"></div>
    <div class="field"><label>Losses</label><input type="number" id="edit-losses" step="1" min="0"></div>
    <div style="display:flex;gap:.65rem">
      <button class="btn" onclick="submitEditPlayer()">Save Changes</button>
      <button class="btn-ghost" onclick="document.getElementById('admin-edit-overlay').classList.remove('open')">Cancel</button>
    </div>
    <div class="msg" id="edit-player-msg" style="margin-top:.65rem"></div>
  </div>
</div>

<script type="module">
// â”€â”€ FIREBASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const FIREBASE_CONFIG = {
  apiKey:"AIzaSyCHRQOLzC0DcuZv4aCqsL4EM_IVthiZSIc",
  authDomain:"tttiw-6d44e.firebaseapp.com",
  projectId:"tttiw-6d44e",
  storageBucket:"tttiw-6d44e.firebasestorage.app",
  messagingSenderId:"902138155809",
  appId:"1:902138155809:web:0860c66b77d07746952460"
};
import{initializeApp}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
import{getFirestore,collection,doc,addDoc,setDoc,updateDoc,deleteDoc,onSnapshot,query,orderBy,serverTimestamp,runTransaction}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";
import{getStorage,ref as sRef,uploadBytesResumable,getDownloadURL}from"https://www.gstatic.com/firebasejs/10.12.0/firebase-storage.js";

const app=initializeApp(FIREBASE_CONFIG);
const db=getFirestore(app);
const storage=getStorage(app);

// â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let players=[],matches=[],isAdmin=false,curProfileId=null;
const ADMIN_PW='pppaddle',SIGMA=0.06,RD_MAX=200;

// Show subtitle on wider screens
const mq=window.matchMedia('(min-width:520px)');
const toggleSub=()=>document.getElementById('header-sub-text').style.display=mq.matches?'block':'none';
mq.addEventListener('change',toggleSub); toggleSub();

// â”€â”€ ADMIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openAdminLogin=function(){
  if(isAdmin){isAdmin=false;document.getElementById('admin-btn').textContent='âš™ Admin';document.getElementById('admin-btn').classList.remove('on');document.getElementById('admin-tab-btn').style.display='none';showPanel('leaderboard',document.querySelector('nav button'));return;}
  document.getElementById('admin-pw').value='';document.getElementById('admin-login-msg').style.display='none';
  document.getElementById('admin-login-overlay').classList.add('open');
  setTimeout(()=>document.getElementById('admin-pw').focus(),120);
};
window.submitAdminLogin=function(){
  if(document.getElementById('admin-pw').value===ADMIN_PW){
    isAdmin=true;document.getElementById('admin-login-overlay').classList.remove('open');
    document.getElementById('admin-btn').textContent='âš™ Logout';document.getElementById('admin-btn').classList.add('on');
    document.getElementById('admin-tab-btn').style.display='';
    renderAdminPanel();
  }else{const m=document.getElementById('admin-login-msg');m.textContent='Incorrect password.';m.className='msg err';m.style.display='block';}
};

// â”€â”€ LISTENERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
onSnapshot(query(collection(db,'players'),orderBy('rating','desc')),snap=>{
  players=snap.docs.map(d=>({firestoreId:d.id,...d.data()}));
  applyDecayLocally();renderLeaderboard();renderPlayersList();renderMatchSelects();updateDecayStatus();
  if(isAdmin)renderAdminPanel();
},err=>console.error(err));

onSnapshot(query(collection(db,'matches'),orderBy('date','desc')),snap=>{
  matches=snap.docs.map(d=>({firestoreId:d.id,...d.data()}));
  renderHistory();if(isAdmin)renderAdminPanel();
},err=>console.error(err));

onSnapshot(doc(db,'config','decay'),snap=>{
  if(snap.exists()){const d=snap.data();document.getElementById('decay-amount').value=d.amount||'7';document.getElementById('decay-unit').value=d.unit||'days';}
  applyDecayLocally();updateDecayStatus();
  const di=document.getElementById('decay-info');
  if(di){const a=document.getElementById('decay-amount').value||'7',u=document.getElementById('decay-unit').value||'days';di.textContent=`Decay period: ${a} ${u} Â· Max RD: 200 Â· Players hidden if RD > 100`;}
});
setInterval(updateDecayStatus,1000);setInterval(applyDecayLocally,5000);

// â”€â”€ DECAY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function decayMs(){const a=parseFloat(document.getElementById('decay-amount').value)||7,u=document.getElementById('decay-unit').value||'days';if(u==='minutes')return a*6e4;if(u==='hours')return a*36e5;return a*864e5;}
function computeDecay(p){const now=Date.now(),last=p.lastDecayAt||now,ms=decayMs(),per=Math.floor((now-last)/ms);if(per<=0)return null;let phi=p.rd/173.7178,phiMax=RD_MAX/173.7178;for(let i=0;i<per;i++){phi=Math.sqrt(phi*phi+SIGMA*SIGMA);if(phi>=phiMax){phi=phiMax;break;}}return{newRD:Math.round(Math.min(phi*173.7178,RD_MAX)*10)/10,newLast:last+per*ms};}
function applyDecayLocally(){players.forEach(p=>{const r=computeDecay(p);if(!r)return;p.rd=r.newRD;p.lastDecayAt=r.newLast;updateDoc(doc(db,'players',p.firestoreId),{rd:r.newRD,lastDecayAt:r.newLast}).catch(()=>{});});}
function updateDecayStatus(){const el=document.getElementById('decay-status');if(!el||!players.length)return;const ms=decayMs(),now=Date.now(),next=Math.min(...players.map(p=>(p.lastDecayAt||now)+ms-now));const a=document.getElementById('decay-amount').value||'7',u=document.getElementById('decay-unit').value||'days',lbl=a+u.charAt(0).toUpperCase();if(next>0){const h=Math.floor(next/36e5),m=Math.floor((next%36e5)/6e4),s=Math.floor((next%6e4)/1e3);el.textContent='DECAYÂ·'+lbl+'Â·NEXT '+(h>0?h+'h'+m+'m':m+'m'+s+'s');}else el.textContent='DECAYÂ·'+lbl;}

// â”€â”€ GLICKO-2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const toG2=(r,rd)=>({mu:(r-1500)/173.7178,phi:rd/173.7178});
const frG2=(mu,phi)=>({r:mu*173.7178+1500,rd:phi*173.7178});
const gFn=phi=>1/Math.sqrt(1+3*phi*phi/(Math.PI*Math.PI));
const eFn=(mu,mj,pj)=>1/(1+Math.exp(-gFn(pj)*(mu-mj)));
function g2Update(player,opps){
  const{mu,phi}=toG2(player.rating,player.rd);
  if(!opps.length)return{rating:player.rating,rd:Math.min(RD_MAX,Math.sqrt(phi*phi+SIGMA*SIGMA)*173.7178)};
  let vI=0,ds=0;
  for(const o of opps){const{mu:mj,phi:pj}=toG2(o.rating,o.rd),gj=gFn(pj),ej=eFn(mu,mj,pj);vI+=gj*gj*ej*(1-ej);ds+=gj*(o.s-ej);}
  const v=1/vI,ps=Math.sqrt(phi*phi+SIGMA*SIGMA),pn=1/Math.sqrt(1/(ps*ps)+1/v),mn=mu+pn*pn*ds;
  const r=frG2(mn,pn);return{rating:Math.round(r.r*10)/10,rd:Math.round(r.rd*10)/10};
}

// â”€â”€ LEADERBOARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderLeaderboard(){
  const sorted=[...players].sort((a,b)=>b.rating-a.rating);
  document.getElementById('lb-loading').style.display='none';
  if(!sorted.length){document.getElementById('lb-table').style.display='none';document.getElementById('lb-empty').style.display='block';return;}
  document.getElementById('lb-empty').style.display='none';document.getElementById('lb-table').style.display='table';
  const vis=sorted.filter(p=>p.rd<=100);
  let lbQ=document.getElementById('lb-quote');
  if(!lbQ){lbQ=document.createElement('div');lbQ.id='lb-quote';lbQ.className='lb-quote';document.getElementById('panel-leaderboard').insertBefore(lbQ,document.getElementById('lb-loading'));}
  const top=vis[0];
  if(top?.quote){lbQ.innerHTML=`"${esc(top.quote)}" <span class="qa">â€” ${esc(top.name)}</span>`;lbQ.style.display='block';}else lbQ.style.display='none';
  if(!vis.length){document.getElementById('lb-table').style.display='none';let hn=document.getElementById('lb-hidden-note');if(!hn){hn=document.createElement('div');hn.id='lb-hidden-note';hn.className='empty';document.getElementById('panel-leaderboard').appendChild(hn);}hn.style.display='block';hn.textContent=sorted.length+' player(s) exist but all have RD>100. Play more games!';return;}
  const hn=document.getElementById('lb-hidden-note');if(hn)hn.style.display='none';
  document.getElementById('lb-body').innerHTML=vis.map((p,i)=>{
    const rc=i===0?'top1':i===1?'top2':i===2?'top3':'';
    const av=p.photoURL?`<img class="lb-avatar" src="${esc(p.photoURL)}" alt="">`:`<div class="lb-av-ph">${esc(p.name.charAt(0).toUpperCase())}</div>`;
    const seasons=p.seasons||[];
    const lastS=seasons.length?seasons[seasons.length-1]:null;
    const sBadge=lastS?(()=>{const rk=lastS.rank,cls=rk===1?'rank1':rk===2?'rank2':rk===3?'rank3':'rankN',emoji=rk===1?'ðŸ¥‡':rk===2?'ðŸ¥ˆ':rk===3?'ðŸ¥‰':'';return`<span class="s-badge ${cls}" title="Last season: ${esc(lastS.seasonName||'Season '+lastS.seasonNum)}" style="font-size:.6rem;padding:.12rem .35rem">${emoji}${emoji?'':('#'+rk)}</span>`})():'';
    return`<tr onclick="window.openProfile('${p.firestoreId}')"><td class="rank ${rc}">${i+1}</td><td><div class="pname-cell">${av}<span class="player-name">${esc(p.name)}</span>${sBadge}</div></td><td><span class="rating-val">${Math.round(p.rating)}</span></td><td><span class="rd-val">Â±${Math.round(p.rd)}</span></td><td><span class="record-badge"><span class="w">${p.wins}W</span><span class="l">${p.losses}L</span></span></td></tr>`;
  }).join('')+(sorted.length>vis.length?`<tr><td colspan="5" style="font-family:'DM Mono',monospace;font-size:.58rem;color:var(--muted);padding:.55rem .7rem;text-align:center">${sorted.length-vis.length} hidden (RD>100)</td></tr>`:'');
}

// â”€â”€ PLAYERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addPlayer=async function(){
  const name=document.getElementById('player-name').value.trim();
  if(!name){showMsg('player-msg','Name required.',true);return;}
  if(players.find(p=>p.name.toLowerCase()===name.toLowerCase())){showMsg('player-msg','Already exists.',true);return;}
  const btn=document.getElementById('add-player-btn');btn.disabled=true;
  try{await addDoc(collection(db,'players'),{name,rating:1500,rd:120,wins:0,losses:0,lastDecayAt:Date.now(),createdAt:serverTimestamp()});document.getElementById('player-name').value='';showMsg('player-msg',name+' added!');}
  catch(e){showMsg('player-msg','Error: '+e.message,true);}finally{btn.disabled=false;}
};

function makeCard(p){
  const wr=(p.wins+p.losses)>0?Math.round(p.wins/(p.wins+p.losses)*100):0;
  const wc=wr>=60?'var(--win)':wr>=40?'var(--text)':'var(--loss)';
  const rdH=p.rd>100,rdC=rdH?'var(--loss)':p.rd>80?'var(--accent)':'var(--win)';
  const{ls,la}=pStats(p.firestoreId),sc=ls>=5?'var(--win)':ls>=3?'var(--accent)':'var(--text)';
  const av=p.photoURL?`<img class="pc-avatar" src="${esc(p.photoURL)}" alt="">`:`<div class="pc-av-ph">${esc(p.name.charAt(0).toUpperCase())}</div>`;
  // Season badges
  const seasons=p.seasons||[];
  let badgesHtml='',histHtml='';
  if(seasons.length){
    badgesHtml=`<div class="season-badges">`+seasons.slice().reverse().slice(0,4).map(s=>{
      const rk=s.rank,cls=rk===1?'rank1':rk===2?'rank2':rk===3?'rank3':'rankN';
      const emoji=rk===1?'ðŸ¥‡':rk===2?'ðŸ¥ˆ':rk===3?'ðŸ¥‰':'';
      return`<span class="s-badge ${cls}" title="${esc(s.seasonName||'Season')}">${emoji}${emoji?'':('#'+rk)} ${esc(s.seasonName||('S'+s.seasonNum))}</span>`;
    }).join('')+`</div>`;
    // History dropdown
    const opts=seasons.slice().reverse().map((s,i)=>`<option value="${i}">${esc(s.seasonName||('Season '+s.seasonNum))} â€” #${s.rank}</option>`).join('');
    histHtml=`<div class="s-history-wrap">
      <select class="s-history-select" onchange="showSeasonData(this,'s-data-${p.firestoreId}')" onclick="event.stopPropagation()">
        <option value="">ðŸ“‹ Previous seasonsâ€¦</option>${opts}
      </select>
      <div class="s-history-data" id="s-data-${p.firestoreId}" style="display:none"></div>
    </div>`;
  }
  return`<div class="player-card" onclick="window.openProfile('${p.firestoreId}')">
    <div class="pc-header">${av}<div class="pc-name-block"><div class="pc-name">${esc(p.name)}</div>${rdH?'<span class="pc-tag">HIDDEN</span>':''}</div></div>
    ${badgesHtml}
    <div class="pc-stats">
      <div class="pc-stat"><span class="pc-stat-l">Rating</span><span class="pc-stat-v" style="color:var(--accent)">${Math.round(p.rating)}</span></div>
      <div class="pc-stat"><span class="pc-stat-l">RD</span><span class="pc-stat-v" style="color:${rdC}">Â±${Math.round(p.rd)}</span></div>
      <div class="pc-stat"><span class="pc-stat-l">Record</span><span class="pc-stat-v">${p.wins}Wâ€“${p.losses}L</span></div>
      <div class="pc-stat"><span class="pc-stat-l">Win%</span><span class="pc-stat-v" style="color:${wc}">${wr}%</span></div>
      <div class="pc-stat"><span class="pc-stat-l">Streak</span><span class="pc-stat-v" style="color:${sc}">${ls>0?ls+'W':'â€”'}</span></div>
      <div class="pc-stat"><span class="pc-stat-l">Longest #1</span><span class="pc-stat-v" style="color:var(--accent3);font-size:.95rem">${fmtDur(la)}</span></div>
    </div>
    <div class="pc-foot"><span class="pc-hint">TAP TO VIEW PROFILE</span></div>
    ${histHtml}
  </div>`;
}
function renderPlayersList(){
  const sorted=[...players].sort((a,b)=>b.rating-a.rating);
  const html=sorted.length?`<div class="cards-label">ALL PLAYERS (${sorted.length})</div><div class="cards-grid">${sorted.map(makeCard).join('')}</div>`:'<div class="empty">No players yet.</div>';
  const mob=document.getElementById('players-list-mobile'),des=document.getElementById('players-list-desktop');
  if(mob)mob.innerHTML=html;if(des)des.innerHTML=html;
}

// â”€â”€ SEASON HISTORY DROPDOWN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.showSeasonData=function(sel,dataId){
  const el=document.getElementById(dataId);if(!el)return;
  if(!sel.value){el.style.display='none';return;}
  const idx=parseInt(sel.value);
  // find the player
  const pid=dataId.replace('s-data-','');
  const p=players.find(x=>x.firestoreId===pid);
  if(!p||!p.seasons){el.style.display='none';return;}
  const seasons=p.seasons.slice().reverse();
  const s=seasons[idx];if(!s){el.style.display='none';return;}
  const rk=s.rank,emoji=rk===1?'ðŸ¥‡ ':rk===2?'ðŸ¥ˆ ':rk===3?'ðŸ¥‰ ':'';
  const ended=s.endedAt?new Date(s.endedAt).toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}):'â€”';
  el.style.display='block';
  el.innerHTML=`<strong>${emoji}${esc(s.seasonName||('Season '+s.seasonNum))}</strong><br>
    Final Rank: <strong style="color:${rk===1?'var(--accent)':rk===2?'#c0c0c0':rk===3?'#cd7f32':'var(--text)'}">#${rk}</strong><br>
    Final Rating: <strong style="color:var(--accent)">${Math.round(s.rating)}</strong> Â±${Math.round(s.rd)}<br>
    Record: <strong>${s.wins}W â€“ ${s.losses}L</strong><br>
    Season ended: ${ended}`;
};
function pStats(fid){
  const ids=new Set(players.map(x=>x.firestoreId));
  const pm=[...matches].filter(m=>ids.has(m.p1id)&&ids.has(m.p2id)&&(m.p1id===fid||m.p2id===fid)).sort((a,b)=>toTs(a)-toTs(b));
  let ls=0,cs=0;pm.forEach(m=>{const w=m.p1id===fid?m.score===1:m.score===0;w?(cs++,ls=Math.max(ls,cs)):cs=0;});
  let la=0;
  const all=[...matches].filter(m=>ids.has(m.p1id)&&ids.has(m.p2id)).sort((a,b)=>toTs(a)-toTs(b));
  if(all.length&&players.length>=2){
    const rs={};players.forEach(p=>{rs[p.firestoreId]=1500;});
    const seen=new Set();all.forEach(m=>{if(!seen.has(m.p1id)){rs[m.p1id]=m.p1oldRating;seen.add(m.p1id);}if(!seen.has(m.p2id)){rs[m.p2id]=m.p2oldRating;seen.add(m.p2id);}});
    let a1=null;const top=()=>Object.entries(rs).reduce((b,[id,r])=>r>b[1]?[id,r]:b,[null,-Infinity])[0];
    all.forEach(m=>{const pt=top();rs[m.p1id]=m.p1newRating;rs[m.p2id]=m.p2newRating;const nt=top(),ts=toTs(m);
      if(pt===fid&&nt!==fid){if(a1!==null){la=Math.max(la,ts-a1);a1=null;}}else if(pt!==fid&&nt===fid)a1=ts;});
    if(top()===fid&&a1!==null)la=Math.max(la,Date.now()-a1);
  }
  return{ls,la};
}
function toTs(m){return m.date?.toDate?m.date.toDate().getTime():new Date(m.date).getTime();}
function fmtDur(ms){if(ms<=0)return'â€”';const d=Math.floor(ms/864e5),h=Math.floor((ms%864e5)/36e5);if(d>0)return d+'d '+h+'h';const m2=Math.floor((ms%36e5)/6e4);if(h>0)return h+'h '+m2+'m';return m2+'m';}

// â”€â”€ SEASON LOGIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let seasonConfig={name:'',deadline:null,seasonNum:1};

onSnapshot(doc(db,'config','season'),snap=>{
  if(snap.exists()){
    const d=snap.data();
    seasonConfig={name:d.name||'',deadline:d.deadline||null,seasonNum:d.seasonNum||1};
  }
  updateSeasonCountdown();
  if(isAdmin)populateSeasonAdmin();
});
setInterval(updateSeasonCountdown,1000);

function updateSeasonCountdown(){
  const el=document.getElementById('season-countdown');
  if(!el||!seasonConfig.deadline)return el&&(el.style.display='none');
  const now=Date.now(),dl=new Date(seasonConfig.deadline).getTime(),diff=dl-now;
  if(diff<=0){el.textContent='SEASON ENDED';el.style.display='';el.className='';el.style.cssText='font-size:.55rem;color:var(--loss);font-family:\'DM Mono\',monospace;letter-spacing:.07em;white-space:nowrap;border:1px solid rgba(217,83,79,.4);padding:.25rem .5rem;';return;}
  el.style.display='';
  const days=Math.floor(diff/864e5),hrs=Math.floor((diff%864e5)/36e5),mins=Math.floor((diff%36e5)/6e4),secs=Math.floor((diff%6e4)/1e3);
  const urgent=diff<86400000;
  el.className=urgent?'urgent':'';
  const label=seasonConfig.name?`${seasonConfig.name} Â· `:'';
  if(days>0)el.textContent=label+'ENDS '+days+'d '+hrs+'h';
  else el.textContent=label+'ENDS '+hrs+'h '+mins+'m '+secs+'s';
}

function populateSeasonAdmin(){
  const nameEl=document.getElementById('season-name-input'),dlEl=document.getElementById('season-deadline-input');
  if(nameEl&&seasonConfig.name)nameEl.value=seasonConfig.name;
  if(dlEl&&seasonConfig.deadline){
    try{const d=new Date(seasonConfig.deadline);const local=new Date(d.getTime()-d.getTimezoneOffset()*60000).toISOString().slice(0,16);dlEl.value=local;}catch(e){}
  }
  const sa=document.getElementById('season-status-admin');
  if(sa){
    const di=document.getElementById('decay-info');
    const a=document.getElementById('decay-amount').value||'7',u=document.getElementById('decay-unit').value||'days';
    if(di)di.textContent=`Decay period: ${a} ${u} Â· Max RD: 200 Â· Players hidden if RD > 100`;
    if(seasonConfig.deadline){
      const dl=new Date(seasonConfig.deadline),now=Date.now(),diff=dl.getTime()-now;
      sa.style.display='block';
      sa.innerHTML=diff>0?`Current season: <strong style="color:var(--admin)">${esc(seasonConfig.name||'Unnamed')}</strong><br>Ends: <strong>${dl.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric',hour:'2-digit',minute:'2-digit'})}</strong>`:`Season <strong style="color:var(--loss)">${esc(seasonConfig.name||'Unnamed')}</strong> has ended. Ready to reset!`;
    }else sa.style.display='none';
  }
}

window.saveSeason=async function(){
  const name=document.getElementById('season-name-input').value.trim();
  const dlRaw=document.getElementById('season-deadline-input').value;
  if(!dlRaw){showMsg('season-msg','Set a deadline date.',true);return;}
  const deadline=new Date(dlRaw).toISOString();
  try{
    await setDoc(doc(db,'config','season'),{name:name||'Season',deadline,seasonNum:seasonConfig.seasonNum||1},);
    showMsg('season-msg','Season saved!');
  }catch(e){showMsg('season-msg','Error: '+e.message,true);}
};

window.triggerSeasonReset=async function(){
  if(!confirm(`This will:\n1. Save each player's current rank/stats as a season record\n2. Reset ALL ratings to 1500, RD to 120, wins/losses to 0\n\nSeason: "${seasonConfig.name||'Current'}"\n\nThis cannot be undone. Continue?`))return;
  const btn=document.getElementById('reset-season-btn');btn.disabled=true;btn.textContent='Resettingâ€¦';
  try{
    // Snapshot current leaderboard rankings
    const ranked=[...players].filter(p=>p.rd<=100).sort((a,b)=>b.rating-a.rating);
    const rankMap={};ranked.forEach((p,i)=>rankMap[p.firestoreId]=i+1);
    // Unranked players get rank = ranked.length + 1
    players.forEach(p=>{if(!rankMap[p.firestoreId])rankMap[p.firestoreId]=ranked.length+1;});
    const sNum=seasonConfig.seasonNum||1;
    const sName=seasonConfig.name||('Season '+sNum);
    const endedAt=new Date().toISOString();
    // Update each player in a batch via individual updates
    await Promise.all(players.map(p=>{
      const existing=p.seasons||[];
      const entry={seasonNum:sNum,seasonName:sName,rank:rankMap[p.firestoreId],rating:p.rating,rd:p.rd,wins:p.wins,losses:p.losses,endedAt};
      return updateDoc(doc(db,'players',p.firestoreId),{rating:1500,rd:120,wins:0,losses:0,lastDecayAt:Date.now(),seasons:[...existing,entry]});
    }));
    // Bump season number, clear deadline
    await setDoc(doc(db,'config','season'),{name:'',deadline:null,seasonNum:sNum+1});
    showMsg('season-msg',`Season "${sName}" archived! All ratings reset.`);
  }catch(e){showMsg('season-msg','Error: '+e.message,true);}
  finally{btn.disabled=false;btn.textContent='âš¡ Reset Season Now';}
};

// â”€â”€ DECAY (read-only display now) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// â”€â”€ SUBMIT MATCH â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.submitMatch=async function(){
  const wid=document.getElementById('match-winner').value,lid=document.getElementById('match-loser').value;
  if(wid===lid){showMsg('match-msg','Select two different players.',true);return;}
  const btn=document.getElementById('submit-match-btn');btn.disabled=true;showMsg('match-msg','Submittingâ€¦');
  try{await runTransaction(db,async tx=>{
    const[ws,ls]=await Promise.all([tx.get(doc(db,'players',wid)),tx.get(doc(db,'players',lid))]);
    if(!ws.exists()||!ls.exists())throw new Error('Player not found');
    const w=ws.data(),l=ls.data();
    const uw=g2Update(w,[{rating:l.rating,rd:l.rd,s:1}]),ul=g2Update(l,[{rating:w.rating,rd:w.rd,s:0}]);
    const now=Date.now();
    tx.update(doc(db,'players',wid),{rating:uw.rating,rd:uw.rd,wins:w.wins+1,lastDecayAt:now});
    tx.update(doc(db,'players',lid),{rating:ul.rating,rd:ul.rd,losses:l.losses+1,lastDecayAt:now});
    const sc=document.getElementById('match-score').value.trim();
    tx.set(doc(collection(db,'matches')),{winnerId:wid,loserId:lid,winnerName:w.name,loserName:l.name,p1id:wid,p2id:lid,p1name:w.name,p2name:l.name,score:1,matchScore:sc||null,p1delta:Math.round((uw.rating-w.rating)*10)/10,p2delta:Math.round((ul.rating-l.rating)*10)/10,p1newRD:uw.rd,p2newRD:ul.rd,p1oldRating:w.rating,p1newRating:uw.rating,p2oldRating:l.rating,p2newRating:ul.rating,date:serverTimestamp()});
  });document.getElementById('match-score').value='';const wn=players.find(p=>p.firestoreId===wid);showMsg('match-msg',(wn?.name||'Winner')+' wins!');}
  catch(e){showMsg('match-msg','Error: '+e.message,true);}finally{btn.disabled=false;}
};
function renderMatchSelects(){const opts=players.map(p=>`<option value="${p.firestoreId}">${esc(p.name)} (${Math.round(p.rating)})</option>`).join('');document.getElementById('match-winner').innerHTML=opts||'<option disabled>No players yet</option>';document.getElementById('match-loser').innerHTML=opts||'<option disabled>No players yet</option>';}

// â”€â”€ HISTORY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderHistoryFilter(){const sel=document.getElementById('history-filter'),cur=sel.value;sel.innerHTML='<option value="all">All Players</option>'+players.map(p=>`<option value="${p.firestoreId}">${esc(p.name)}</option>`).join('');sel.value=players.find(p=>p.firestoreId===cur)?cur:'all';}
window.renderHistory=function(){
  renderHistoryFilter();const flt=document.getElementById('history-filter').value,el=document.getElementById('history-list');
  const ids=new Set(players.map(p=>p.firestoreId));
  let ms=matches.filter(m=>ids.has(m.p1id)&&ids.has(m.p2id));if(flt!=='all')ms=ms.filter(m=>m.p1id===flt||m.p2id===flt);
  if(!ms.length){el.innerHTML='<div class="empty">No matches yet.</div>';return;}
  el.innerHTML=ms.map(m=>{
    const ts=m.date?.toDate?m.date.toDate():new Date(m.date);
    const ds=ts.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}),ti=ts.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'});
    const d1=(m.p1delta>=0?'+':'')+m.p1delta,d2=(m.p2delta>=0?'+':'')+m.p2delta;
    return`<div class="match-row">
      <div class="match-player"><span class="name">${esc(m.p1name)}</span><span class="delta ${m.p1delta>=0?'pos':'neg'}">${d1} (${Math.round(m.p1oldRating)}â†’${Math.round(m.p1newRating)})</span><span class="rdi">RD:Â±${Math.round(m.p1newRD)}</span></div>
      <div class="match-mid"><div class="match-result"><span class="ws">WIN</span>${m.matchScore?`<span class="match-score-lbl">${esc(m.matchScore)}</span>`:'<span style="font-size:.8rem;color:var(--muted)">vs</span>'}<span class="ls">LOSS</span></div><div class="match-date-lbl">${ds} ${ti}</div></div>
      <div class="match-player" style="text-align:right"><span class="name">${esc(m.p2name)}</span><span class="delta ${m.p2delta>=0?'pos':'neg'}">${d2} (${Math.round(m.p2oldRating)}â†’${Math.round(m.p2newRating)})</span><span class="rdi">RD:Â±${Math.round(m.p2newRD)}</span></div>
      <div class="match-meta-col">${ds}<br>${ti}${m.matchScore?'<br>'+esc(m.matchScore):''}</div>
    </div>`;
  }).join('');
};

// â”€â”€ ADMIN PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderAdminPanel(){
  if(!isAdmin)return;
  populateSeasonAdmin();
  const di=document.getElementById('decay-info');
  if(di){const a=document.getElementById('decay-amount').value||'7',u=document.getElementById('decay-unit').value||'days';di.textContent=`Decay period: ${a} ${u} Â· Max RD: 200 Â· Players hidden if RD > 100`;}
  const sorted=[...players].sort((a,b)=>b.rating-a.rating);
  const pl=document.getElementById('admin-players-list');
  if(pl)pl.innerHTML=sorted.length?sorted.map(p=>`<div class="admin-prow"><span class="admin-pname">${esc(p.name)}</span><span class="admin-prating">${Math.round(p.rating)} Â±${Math.round(p.rd)}</span><button class="btn-admin" onclick="openEditPlayer('${p.firestoreId}')">Edit Stats</button><button class="btn-danger" onclick="adminRemovePlayer('${p.firestoreId}','${esc(p.name)}')">Remove</button></div>`).join(''):'<div class="empty">No players.</div>';
  const ml=document.getElementById('admin-matches-list');
  if(ml)ml.innerHTML=matches.length?matches.slice(0,60).map(m=>{
    const ts=m.date?.toDate?m.date.toDate():new Date(m.date);
    return`<div class="admin-mrow"><div class="admin-minfo"><strong>${esc(m.p1name)} beat ${esc(m.p2name)}</strong>${m.matchScore?' Â· '+esc(m.matchScore):''}<br>${ts.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'})}</div><button class="btn-danger" onclick="adminRemoveMatch('${m.firestoreId}')">Delete</button></div>`;
  }).join(''):'<div class="empty">No matches.</div>';
}
window.adminRemovePlayer=async function(fid,name){if(!confirm(`Remove "${name}"? Match history remains.`))return;try{await deleteDoc(doc(db,'players',fid));}catch(e){alert('Error: '+e.message);}};
window.adminRemoveMatch=async function(fid){if(!confirm('Delete this match? Ratings will NOT be recalculated.'))return;try{await deleteDoc(doc(db,'matches',fid));}catch(e){alert('Error: '+e.message);}};
window.openEditPlayer=function(fid){const p=players.find(x=>x.firestoreId===fid);if(!p)return;document.getElementById('edit-pid').value=fid;document.getElementById('edit-rating').value=Math.round(p.rating);document.getElementById('edit-rd').value=Math.round(p.rd);document.getElementById('edit-wins').value=p.wins;document.getElementById('edit-losses').value=p.losses;document.getElementById('edit-player-msg').style.display='none';document.getElementById('admin-edit-overlay').classList.add('open');};
window.submitEditPlayer=async function(){
  const fid=document.getElementById('edit-pid').value,rating=parseFloat(document.getElementById('edit-rating').value),rd=parseFloat(document.getElementById('edit-rd').value),wins=parseInt(document.getElementById('edit-wins').value),losses=parseInt(document.getElementById('edit-losses').value);
  if([rating,rd,wins,losses].some(isNaN)){showMsg('edit-player-msg','Invalid values.',true);return;}
  try{await updateDoc(doc(db,'players',fid),{rating,rd,wins,losses});showMsg('edit-player-msg','Saved!');setTimeout(()=>document.getElementById('admin-edit-overlay').classList.remove('open'),1200);}
  catch(e){showMsg('edit-player-msg','Error: '+e.message,true);}
};

// â”€â”€ PROFILE PICTURE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('m-av-input').addEventListener('change',async function(e){
  const file=e.target.files[0];if(!file||!curProfileId)return;
  const prog=document.getElementById('upload-prog');prog.style.display='block';prog.textContent='Uploadingâ€¦';
  const ext=file.name.split('.').pop(),sr=sRef(storage,`avatars/${curProfileId}.${ext}`);
  const task=uploadBytesResumable(sr,file,{contentType:file.type});
  task.on('state_changed',snap=>{prog.textContent=`Uploadingâ€¦ ${Math.round(snap.bytesTransferred/snap.totalBytes*100)}%`;},
    err=>{prog.textContent='Upload failed.';console.error(err);},
    async()=>{const url=await getDownloadURL(task.snapshot.ref);await updateDoc(doc(db,'players',curProfileId),{photoURL:url});prog.textContent='Photo updated!';
      const wrap=document.getElementById('m-av-wrap'),uploadBtn=wrap.querySelector('.m-av-upload');
      let img=wrap.querySelector('.m-avatar');if(!img){img=document.createElement('img');img.className='m-avatar';const ph=wrap.querySelector('.m-av-ph');if(ph)ph.replaceWith(img);else wrap.insertBefore(img,uploadBtn);}img.src=url;
      setTimeout(()=>{prog.style.display='none';},2500);
    });
});

// â”€â”€ PROFILE MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.openProfile=function(fid){
  const p=players.find(x=>x.firestoreId===fid);if(!p)return;curProfileId=fid;
  // Avatar
  const wrap=document.getElementById('m-av-wrap'),uploadBtn=wrap.querySelector('.m-av-upload');
  const old=wrap.querySelector('.m-avatar,.m-av-ph');if(old)old.remove();
  if(p.photoURL){const img=document.createElement('img');img.className='m-avatar';img.src=p.photoURL;wrap.insertBefore(img,uploadBtn);}
  else{const ph=document.createElement('div');ph.className='m-av-ph';ph.textContent=p.name.charAt(0).toUpperCase();wrap.insertBefore(ph,uploadBtn);}
  document.getElementById('profile-name').textContent=p.name;
  document.getElementById('quote-input-modal').value=p.quote||'';
  document.getElementById('quote-msg-modal').style.display='none';
  document.getElementById('upload-prog').style.display='none';
  document.getElementById('m-av-input').value='';
  const qEl=document.getElementById('profile-quote');
  if(p.quote){qEl.innerHTML=`"${esc(p.quote)}" <span class="qa">â€” ${esc(p.name)}</span>`;qEl.style.display='block';}else qEl.style.display='none';
  const wr=(p.wins+p.losses)>0?Math.round(p.wins/(p.wins+p.losses)*100):0,wc=wr>=60?'green':wr>=40?'neutral':'red';
  const{ls,la}=pStats(fid);
  document.getElementById('profile-stats').innerHTML=`
    <div class="m-stat"><span class="m-stat-l">Rating</span><span class="m-stat-v">${Math.round(p.rating)}</span></div>
    <div class="m-stat"><span class="m-stat-l">RD</span><span class="m-stat-v neutral">Â±${Math.round(p.rd)}</span></div>
    <div class="m-stat"><span class="m-stat-l">Record</span><span class="m-stat-v neutral">${p.wins}Wâ€“${p.losses}L</span></div>
    <div class="m-stat"><span class="m-stat-l">Win%</span><span class="m-stat-v ${wc}">${wr}%</span></div>
    <div class="m-stat"><span class="m-stat-l">Streak</span><span class="m-stat-v ${ls>=5?'green':ls>=3?'':'neutral'}">${ls>0?ls+'W':'â€”'}</span></div>
    <div class="m-stat"><span class="m-stat-l">Longest #1</span><span class="m-stat-v" style="color:var(--accent3);font-size:1rem">${fmtDur(la)}</span></div>`;
  const ids=new Set(players.map(x=>x.firestoreId));
  const pm=[...matches].filter(m=>ids.has(m.p1id)&&ids.has(m.p2id)&&(m.p1id===fid||m.p2id===fid)).sort((a,b)=>toTs(a)-toTs(b));
  const start=pm.length>0?(pm[0].p1id===fid?pm[0].p1oldRating:pm[0].p2oldRating):p.rating;
  const pts=[{rating:start,label:'Start'}];
  pm.forEach(m=>{const i1=m.p1id===fid,ts=m.date?.toDate?m.date.toDate():new Date(m.date);pts.push({rating:i1?m.p1newRating:m.p2newRating,won:m.winnerId===fid,label:i1?m.p2name:m.p1name,date:ts.toISOString()});});
  drawChart(pts);
  document.getElementById('profile-matches').innerHTML=pm.length?[...pm].reverse().map(m=>{
    const i1=m.p1id===fid,won=i1?m.score===1:m.score===0,opp=i1?m.p2name:m.p1name,delta=i1?m.p1delta:m.p2delta,oldR=i1?m.p1oldRating:m.p2oldRating,newR=i1?m.p1newRating:m.p2newRating;
    const ts=m.date?.toDate?m.date.toDate():new Date(m.date),ds=ts.toLocaleDateString('en-US',{month:'short',day:'numeric',year:'numeric'}),ti=ts.toLocaleTimeString('en-US',{hour:'2-digit',minute:'2-digit'}),df=(delta>=0?'+':'')+delta;
    return`<div class="pm-row"><span class="pm-badge ${won?'win':'loss'}">${won?'WIN':'LOSS'}</span><div class="pm-info"><span class="pm-opp">vs ${esc(opp)}${m.matchScore?' <span style="font-family:\'DM Mono\',monospace;font-size:.58rem;color:var(--muted)">'+esc(m.matchScore)+'</span>':''}</span><span class="pm-date">${ds} Â· ${ti}</span></div><span class="pm-delta ${delta>=0?'pos':'neg'}">${df}<br><span style="font-size:.6rem;color:var(--muted)">${Math.round(oldR)}â†’${Math.round(newR)}</span></span></div>`;
  }).join(''):'<div class="empty">No matches yet.</div>';
  document.getElementById('profile-overlay').classList.add('open');
};

window.saveQuoteModal=async function(){
  if(!curProfileId)return;const q=document.getElementById('quote-input-modal').value.trim();
  try{await updateDoc(doc(db,'players',curProfileId),{quote:q||null});const p=players.find(x=>x.firestoreId===curProfileId);if(p)p.quote=q||null;
    const qEl=document.getElementById('profile-quote');if(q){qEl.innerHTML=`"${esc(q)}" <span class="qa">â€” ${esc(p?.name||'')}</span>`;qEl.style.display='block';}else qEl.style.display='none';
    showMsg('quote-msg-modal',q?'Quote saved!':'Quote cleared.');}
  catch(e){showMsg('quote-msg-modal','Error: '+e.message,true);}
};

window.closeProfile=function(e){if(e.target===document.getElementById('profile-overlay'))document.getElementById('profile-overlay').classList.remove('open');};
document.addEventListener('keydown',e=>{if(e.key==='Escape'){['profile-overlay','admin-login-overlay','admin-edit-overlay'].forEach(id=>document.getElementById(id).classList.remove('open'));}});

// â”€â”€ CHART â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function drawChart(points){
  const PAD={top:16,right:22,bottom:26,left:46},H=175,MIN_PX=54;
  const outer=document.getElementById('chart-outer'),newOuter=outer.cloneNode(false);
  while(outer.firstChild)newOuter.appendChild(outer.firstChild);outer.parentNode.replaceChild(newOuter,outer);
  const wrap=document.getElementById('chart-wrap'),canvas=document.getElementById('rating-chart'),tip=document.getElementById('chart-tip');
  const W=Math.max(newOuter.clientWidth||580,PAD.left+PAD.right+(points.length>1?(points.length-1)*MIN_PX:200));
  wrap.style.width=W+'px';wrap.style.height=H+'px';canvas.width=W;canvas.height=H;
  const ctx=canvas.getContext('2d'),cW=W-PAD.left-PAD.right,cH=H-PAD.top-PAD.bottom;
  const ratings=points.map(p=>p.rating),minR=Math.min(...ratings),maxR=Math.max(...ratings),range=maxR-minR||50,rPad=range*.18,lo=minR-rPad,hi=maxR+rPad;
  const xOf=i=>PAD.left+(points.length>1?(i/(points.length-1))*cW:cW/2);
  const yOf=r=>PAD.top+(1-(r-lo)/(hi-lo))*cH;
  function redraw(hl){
    ctx.clearRect(0,0,W,H);
    for(let g=0;g<=4;g++){const y=PAD.top+(g/4)*cH;ctx.strokeStyle='rgba(74,42,56,.9)';ctx.lineWidth=1;ctx.beginPath();ctx.moveTo(PAD.left,y);ctx.lineTo(W-PAD.right,y);ctx.stroke();ctx.fillStyle='#8a6a78';ctx.font='9px DM Mono,monospace';ctx.textAlign='right';ctx.fillText(Math.round(hi-(g/4)*(hi-lo)),PAD.left-4,y+3);}
    if(points.length<2){ctx.fillStyle='#8a6a78';ctx.font='11px DM Mono,monospace';ctx.textAlign='center';ctx.fillText('Play more matches to see history',W/2,H/2);return;}
    for(let i=1;i<points.length;i++){const pv=points[i-1],cv=points[i],col=cv.won?'#7ec8a0':'#ff4757';ctx.beginPath();ctx.moveTo(xOf(i-1),yOf(pv.rating));ctx.lineTo(xOf(i),yOf(cv.rating));ctx.lineTo(xOf(i),H-PAD.bottom);ctx.lineTo(xOf(i-1),H-PAD.bottom);ctx.closePath();ctx.fillStyle=cv.won?'rgba(126,200,160,.1)':'rgba(217,83,79,.1)';ctx.fill();ctx.beginPath();ctx.moveTo(xOf(i-1),yOf(pv.rating));ctx.lineTo(xOf(i),yOf(cv.rating));ctx.strokeStyle=col;ctx.lineWidth=2;ctx.stroke();}
    for(let i=0;i<points.length;i++){const pt=points[i],col=i===0?'#8a6a78':(pt.won?'#7ec8a0':'#ff4757'),isHl=i===hl;if(isHl){ctx.beginPath();ctx.arc(xOf(i),yOf(pt.rating),8,0,Math.PI*2);ctx.fillStyle=i===0?'rgba(138,106,120,.2)':(pt.won?'rgba(126,200,160,.2)':'rgba(217,83,79,.2)');ctx.fill();}ctx.beginPath();ctx.arc(xOf(i),yOf(pt.rating),isHl?5:3.5,0,Math.PI*2);ctx.fillStyle=col;ctx.fill();if(isHl){ctx.beginPath();ctx.arc(xOf(i),yOf(pt.rating),1.5,0,Math.PI*2);ctx.fillStyle='#fff';ctx.fill();}}
    if(hl>=0){ctx.beginPath();ctx.moveTo(xOf(hl),PAD.top);ctx.lineTo(xOf(hl),H-PAD.bottom);ctx.strokeStyle='rgba(255,255,255,.07)';ctx.lineWidth=1;ctx.setLineDash([3,4]);ctx.stroke();ctx.setLineDash([]);}
  }
  function showTip(idx){const pt=points[idx],col=idx===0?'#8a6a78':(pt.won?'#7ec8a0':'#ff4757');let html=`<span style="font-family:'Bebas Neue',sans-serif;font-size:1rem;color:${col}">${Math.round(pt.rating)}</span>`;if(idx===0)html+=`<br><span style="color:#8a6a78">Starting rating</span>`;else{const d=new Date(pt.date),ds=pt.rating-points[idx-1].rating,df=(ds>=0?'+':'')+Math.round(ds),dt=d.toLocaleDateString('en-US',{month:'short',day:'numeric'});html+=`<br><span style="color:${col}">${pt.won?'WIN':'LOSS'}</span> vs ${esc(pt.label)}<br><span style="color:${col}">${df} pts</span> Â· ${dt}`;}tip.innerHTML=html;tip.style.display='block';tip.style.left='-9999px';tip.style.top='-9999px';requestAnimationFrame(()=>{const dx=xOf(idx),dy=yOf(pt.rating),tw=tip.offsetWidth,th=tip.offsetHeight;let l=Math.max(PAD.left,Math.min(dx-tw/2,W-PAD.right-tw)),t=dy-th-10;if(t<PAD.top)t=dy+14;tip.style.left=l+'px';tip.style.top=t+'px';});}
  redraw(-1);let hl=-1;
  function near(cx){let b=-1,bd=Infinity;for(let i=0;i<points.length;i++){const d=Math.abs(xOf(i)-cx);if(d<bd){bd=d;b=i;}}return bd<34?b:-1;}
  function onMove(e){const r=canvas.getBoundingClientRect(),cx=(e.touches?e.touches[0].clientX:e.clientX)-r.left,idx=near(cx*(canvas.width/r.width));if(idx!==hl){hl=idx;redraw(idx);if(idx>=0)showTip(idx);else tip.style.display='none';}}
  function onLeave(){hl=-1;redraw(-1);tip.style.display='none';}
  newOuter.addEventListener('mousemove',onMove);newOuter.addEventListener('mouseleave',onLeave);newOuter.addEventListener('touchmove',onMove,{passive:true});newOuter.addEventListener('touchend',onLeave);
}

// â”€â”€ NAV â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.showPanel=function(id,btn){document.querySelectorAll('.panel').forEach(p=>p.classList.remove('active'));document.querySelectorAll('nav button').forEach(b=>b.classList.remove('active'));document.getElementById('panel-'+id).classList.add('active');btn.classList.add('active');if(id==='players')renderPlayersList();if(id==='history')renderHistory();if(id==='admin')renderAdminPanel();};

// â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function esc(s){return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');}
function showMsg(id,text,isErr=false){const el=document.getElementById(id);el.textContent=text;el.className='msg'+(isErr?' err':'');el.style.display='block';if(!isErr)setTimeout(()=>{el.style.display='none';},3000);}
</script>
</body>
</html>